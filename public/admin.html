<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Sistema de Asistencia</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #F8FAFC;
            color: #1E293B;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 30px 20px;
            border-bottom: 1px solid #E2E8F0;
            text-align: center;
        }

        .sidebar-header h2 {
            color: #667eea;
            font-size: 20px;
            font-weight: 700;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            padding: 15px 25px;
            color: #64748B;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #F1F5F9;
            color: #667eea;
            border-left-color: #667eea;
        }

        .nav-item i {
            width: 20px;
            margin-right: 12px;
        }

        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #1E293B;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .logout-btn {
            background: #EF4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: #DC2626;
        }

        .content {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .stat-icon.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.success { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .stat-icon.warning { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
        .stat-icon.info { background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1E293B;
        }

        .stat-label {
            color: #64748B;
            font-size: 14px;
            margin-top: 5px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1E293B;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #E2E8F0;
        }

        .data-table th {
            background: #F8FAFC;
            font-weight: 600;
            color: #475569;
        }

        .data-table tr:hover {
            background: #F8FAFC;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-active {
            background: #D1FAE5;
            color: #065F46;
        }

        .badge-inactive {
            background: #FEE2E2;
            color: #991B1B;
        }

        .badge-pending {
            background: #FEF3C7;
            color: #92400E;
        }

        .badge-approved {
            background: #D1FAE5;
            color: #065F46;
        }

        .badge-rejected {
            background: #FEE2E2;
            color: #991B1B;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1E293B;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: #64748B;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Estilos para el formulario de horarios personalizados */
        .schedule-container {
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            padding: 20px;
            background: #F9FAFB;
            margin-top: 10px;
        }

        .schedule-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 0.5fr 0.5fr;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 2px solid #E5E7EB;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
        }

        .schedule-days {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .schedule-day {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 0.5fr 0.5fr;
            gap: 15px;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
            transition: all 0.3s ease;
        }

        .schedule-day:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .schedule-day.disabled {
            opacity: 0.5;
            background: #F3F4F6;
        }

        .schedule-day span:first-child {
            font-weight: 500;
            color: #374151;
        }

        .time-input {
            padding: 8px 12px;
            border: 2px solid #E5E7EB;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .time-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .time-input:disabled {
            background: #F3F4F6;
            color: #9CA3AF;
        }

        .hours-display {
            font-weight: 600;
            color: #667eea;
            text-align: center;
        }

        .schedule-day input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .schedule-summary {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #E5E7EB;
        }

        .total-hours {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
        }

        .hours-limit {
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .hours-limit.valid {
            background: #D1FAE5;
            color: #065F46;
        }

        .hours-limit.invalid {
            background: #FEE2E2;
            color: #991B1B;
        }

        .hours-limit.warning {
            background: #FEF3C7;
            color: #92400E;
        }

        .schedule-info {
            background: #F0F9FF;
            border: 1px solid #BAE6FD;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .schedule-info small {
            font-size: 13px;
            line-height: 1.4;
        }

        /* Estilos para el modal de rotaci√≥n */
        .rotation-config-content {
            padding: 20px;
        }

        .config-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #F9FAFB;
            border-radius: 12px;
            border: 1px solid #E5E7EB;
        }

        .config-section h4 {
            margin-bottom: 15px;
            color: #374151;
            font-size: 16px;
            font-weight: 600;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
        }

        .stat-label {
            font-weight: 500;
            color: #6B7280;
        }

        .stat-value {
            font-weight: 600;
            color: #667eea;
            font-size: 18px;
        }

        .rotation-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option-group label {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #E5E7EB;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-group label:hover {
            border-color: #667eea;
            background: #F8FAFF;
        }

        .option-group input[type="radio"] {
            margin-top: 2px;
        }

        .option-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .option-label strong {
            color: #374151;
            font-size: 14px;
        }

        .option-label small {
            color: #6B7280;
            font-size: 12px;
        }

        .schedules-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
        }

        .schedule-item {
            display: grid;
            grid-template-columns: 1fr 1fr 0.8fr 0.6fr;
            gap: 12px;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
            font-size: 13px;
        }

        .schedule-name {
            font-weight: 600;
            color: #374151;
        }

        .schedule-time {
            color: #667eea;
            font-weight: 500;
        }

        .schedule-days {
            color: #6B7280;
            text-align: center;
        }

        .schedule-hours {
            color: #059669;
            font-weight: 600;
            text-align: center;
        }

        .rotation-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-warning {
            background: #F59E0B;
            color: white;
            border: none;
        }

        .btn-warning:hover {
            background: #D97706;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #A7F3D0;
        }

        .alert-error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FECACA;
        }

        .alert-info {
            background: #DBEAFE;
            color: #1E40AF;
            border: 1px solid #93C5FD;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1E40AF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para el panel de empleados del d√≠a */
        .day-employees-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .panel-title {
            color: #495057;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .employees-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .employee-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .employee-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .employee-name {
            font-weight: 600;
            color: #212529;
            margin-bottom: 5px;
        }

        .employee-role {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .employee-schedule {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #e3f2fd;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }

        .schedule-time {
            font-weight: 500;
            color: #1976d2;
        }

        .schedule-shift {
            background: #1976d2;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        /* C√≥digos de colores por rol */
        .role-centralista {
            background-color: #3B82F6 !important;
            color: white !important;
        }
        
        .role-despachador {
            background-color: #10B981 !important;
            color: white !important;
        }
        
        .role-turno-noche {
            background-color: #1F2937 !important;
            color: white !important;
        }
        
        .role-administrador {
            background-color: #EF4444 !important;
            color: white !important;
        }
        
        /* Colores para el calendario */
        .calendar-day.centralista {
            background-color: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3B82F6;
        }
        
        .calendar-day.despachador {
            background-color: rgba(16, 185, 129, 0.1);
            border-left: 4px solid #10B981;
        }
        
        .calendar-day.turno-noche {
            background-color: rgba(31, 41, 55, 0.1);
            border-left: 4px solid #1F2937;
        }
        
        .calendar-day.administrador {
            background-color: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #EF4444;
        }
        
        /* Estilos para feriados */
        .calendar-day.holiday {
            background: linear-gradient(135deg, #FF6B6B, #FF8E8E) !important;
            color: white !important;
            font-weight: bold;
            position: relative;
        }
        
        .calendar-day.holiday:hover {
            background: linear-gradient(135deg, #FF5252, #FF7979) !important;
        }
        
        .calendar-day.holiday::after {
            content: 'üéâ';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
        }
        
        .holiday-tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .holiday-tooltip::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: #333;
        }
        
        /* Animaciones para men√∫ desplegable */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }
        
        .custom-shifts-section.show {
            display: block !important;
            animation: slideDown 0.3s ease;
        }
        
        .custom-shifts-section.hide {
            animation: slideUp 0.3s ease;
        }
        
        /* Estilo para bot√≥n desplegable */
        .btn-outline-primary {
            background: transparent;
            border: 2px solid #007bff;
            color: #007bff;
            transition: all 0.3s ease;
        }
        
        .btn-outline-primary:hover {
            background: #007bff;
            color: white;
        }
        
        .btn-outline-primary.active {
            background: #007bff;
            color: white;
        }
        
        /* Estilos para bot√≥n de edici√≥n de turnos */
        .btn-outline-warning {
            background: transparent;
            border: 2px solid #ffc107;
            color: #856404;
            transition: all 0.3s ease;
        }
        
        .btn-outline-warning:hover {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-outline-warning.active {
            background: #ffc107;
            color: #212529;
        }
        
        /* Estilos para secciones de configuraci√≥n */
        .config-section {
            border: 1px solid #e9ecef;
            transition: box-shadow 0.3s ease;
        }
        
        .config-section:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .config-section h4 {
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 8px;
        }
        
        /* Estilos para formularios de edici√≥n */
        .edit-shifts-section.show {
            display: block !important;
            animation: slideDown 0.3s ease;
        }
        
        .edit-shifts-section.hide {
            animation: slideUp 0.3s ease;
        }
        
        /* Estilos para checkboxes personalizados */
        .form-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }
        
        /* Estilos para botones de acci√≥n */
        .btn-group-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Estilos para secci√≥n part-time */
        .btn-outline-success {
            background: transparent;
            border: 2px solid #28a745;
            color: #155724;
            transition: all 0.3s ease;
        }
        
        .btn-outline-success:hover {
            background: #28a745;
            color: white;
        }
        
        .btn-outline-success.active {
            background: #28a745;
            color: white;
        }
        
        /* Estilos para formulario part-time */
        .part-time-form.show {
            display: block !important;
            animation: slideDown 0.3s ease;
        }
        
        .part-time-form.hide {
            animation: slideUp 0.3s ease;
        }
        
        /* Estilos para tabla de empleados part-time */
        .part-time-employee-card {
            background: white;
            border: 1px solid #c3e6c3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: box-shadow 0.3s ease;
        }
        
        .part-time-employee-card:hover {
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);
        }
        
        .part-time-employee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .part-time-employee-name {
            font-weight: 600;
            color: #2d5a2d;
            font-size: 16px;
        }
        
        .part-time-employee-role {
            background: #e8f5e8;
            color: #2d5a2d;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .part-time-employee-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .part-time-detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: #495057;
        }
        
        .part-time-detail-item i {
            color: #28a745;
            width: 16px;
        }
        
        .part-time-coverage-badges {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .coverage-badge {
            background: #f8f9fa;
            color: #495057;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            border: 1px solid #dee2e6;
        }
        
        .coverage-badge.active {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        
        .part-time-actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        /* Estilos para editor de horarios part-time */
        .schedule-editor {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .day-column {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }
        
        .day-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .shift-option {
            margin-bottom: 8px;
        }
        
        .shift-option label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .shift-option label:hover {
            background-color: #e9ecef;
        }
        
        .shift-option input[type="checkbox"] {
            margin: 0;
        }
        
        .shift-name {
            font-weight: 500;
        }
        
        .shift-time {
            font-size: 10px;
            color: #6c757d;
        }
        
        .no-shifts {
            color: #6c757d;
            font-style: italic;
            font-size: 12px;
            text-align: center;
            padding: 10px;
        }
        
        .schedule-summary {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .summary-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .summary-day {
            font-weight: 500;
        }
        
        .summary-shifts {
            color: #6c757d;
            font-size: 12px;
        }

        .no-employees {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }

        /* Estilos para el modal de edici√≥n de horarios */
        .shifts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .shift-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }

        .shift-item h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid #dee2e6;
            background: #f8f9fa;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748B;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block;
            }

            .content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Estilos para el calendario de turnos */
        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            margin-bottom: 10px;
        }

        .day-header {
            background: #F8FAFC;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            color: #64748B;
            border-radius: 8px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
        }

        .calendar-day {
            min-height: 120px;
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
            padding: 10px;
            border-radius: 8px;
            position: relative;
            transition: all 0.3s ease;
        }

        .calendar-day:hover {
            background: #F1F5F9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .calendar-day.other-month {
            background: #F1F5F9;
            color: #94A3B8;
        }

        .calendar-day.empty-day {
            background: transparent;
            border: none;
            min-height: 120px;
        }

        .calendar-day.today {
            background: #EFF6FF;
            border-color: #3B82F6;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1E293B;
        }

        .day-number.other-month {
            color: #94A3B8;
        }

        .shift-assignment {
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .shift-assignment.ivan-vidal {
            background: #9C27B0; /* Morado */
        }

        .shift-assignment.jose-paillacar {
            background: #2196F3; /* Azul */
        }

        .shift-assignment.marcos-paillacar {
            background: #424242; /* Negro */
        }

        .shift-assignment.matias-villanueva {
            background: #FF9800; /* Naranja */
        }

        .shift-assignment.angelica-chavez {
            background: #4CAF50; /* Verde */
        }

        .shift-assignment.matias-igor {
            background: #FFEB3B; /* Amarillo */
            color: #000; /* Texto negro para mejor contraste */
        }

        .shift-assignment.trabajador-parttime {
            background: #E91E63; /* Rosa/Magenta */
            color: white;
        }


        .shift-assignment.turno-noche {
            background: #424242; /* Negro */
            color: white;
        }

        /* Estilos para el nuevo sistema de rotaci√≥n */
        .shift-assignment.turno-manana {
            background: #2196F3; /* Azul */
            color: white;
        }

        .shift-assignment.turno-tarde {
            background: #FF9800; /* Naranja */
            color: white;
        }

        .shift-assignment.fin-semana-manana {
            background: #4CAF50; /* Verde */
            color: white;
        }

        .shift-assignment.fin-semana-tarde {
            background: #9C27B0; /* P√∫rpura */
            color: white;
        }

        /* Estilos para el calendario oficial */
        .official-calendar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 20px 0;
        }

        .calendar-header h2 {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: #1E293B;
            margin: 20px 0;
            text-transform: uppercase;
        }

        .calendar-days-header {
            display: grid;
            grid-template-columns: 200px repeat(7, 1fr);
            gap: 2px;
            background: #F1F5F9;
            padding: 10px;
        }

        .day-header {
            text-align: center;
            font-weight: 600;
            color: #475569;
            padding: 8px;
            font-size: 12px;
        }

        .calendar-days-numbers {
            display: grid;
            grid-template-columns: 200px repeat(7, 1fr);
            gap: 2px;
            background: #F8FAFC;
            padding: 0 10px 10px 10px;
        }

        .day-number {
            text-align: center;
            font-weight: 600;
            color: #1E293B;
            padding: 8px;
            font-size: 14px;
        }

        .day-number.special-day {
            color: #DC2626;
            font-weight: 700;
        }

        .calendar-employees {
            background: white;
        }

        .employee-row {
            display: grid;
            grid-template-columns: 200px repeat(7, 1fr);
            gap: 2px;
            border-bottom: 1px solid #E2E8F0;
            min-height: 60px;
        }

        .employee-row:last-child {
            border-bottom: none;
        }

        .employee-info {
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-right: 2px solid #E2E8F0;
        }

        .employee-info.purple {
            background: #F3E8FF;
            border-left: 4px solid #800080;
        }

        .employee-info.blue {
            background: #EFF6FF;
            border-left: 4px solid #0000FF;
        }

        .employee-info.black {
            background: #F3F4F6;
            border-left: 4px solid #000000;
        }

        .employee-info.orange {
            background: #FFF7ED;
            border-left: 4px solid #FFA500;
        }

        .employee-info.green {
            background: #F0FDF4;
            border-left: 4px solid #00FF00;
        }

        .employee-info.yellow {
            background: #FEFCE8;
            border-left: 4px solid #FFFF00;
        }

        .employee-name {
            font-weight: 700;
            color: #1E293B;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .employee-shift {
            font-size: 12px;
            color: #64748B;
            font-weight: 500;
        }

        .employee-schedule {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .shift-cell {
            min-height: 60px;
            border: 1px solid #E2E8F0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .shift-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .shift-cell.orange-shift {
            background-color: #FFA500;
            border-color: #E67E22;
        }

        .shift-cell.green-shift {
            background-color: #00FF00;
            border-color: #27AE60;
        }

        .shift-cell.yellow-shift {
            background-color: #FFFF00;
            border-color: #F1C40F;
        }

        .shift-cell.blue-shift {
            background-color: #0000FF;
            border-color: #2980B9;
        }

        .shift-cell.purple-shift {
            background-color: #800080;
            border-color: #8E44AD;
        }

        .shift-cell.black-shift {
            background-color: #000000;
            border-color: #2C3E50;
        }

        .shift-cell.red-shift {
            background-color: #FF0000;
            border-color: #E74C3C;
        }

        .shift-cell.no-shift {
            background-color: #FFFFFF;
            border-color: #E2E8F0;
        }

        .shift-cell.holiday {
            background-color: #FF0000;
            border-color: #E74C3C;
            position: relative;
        }

        .shift-cell.holiday::after {
            content: "FERIADO";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
        }

        .no-employees-message {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            background: #F8F9FA;
            border-radius: 12px;
            margin: 20px;
            border: 2px dashed #DEE2E6;
        }

        .message-content {
            text-align: center;
            color: #6C757D;
        }

        .message-content i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #ADB5BD;
        }

        .message-content h3 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .message-content p {
            font-size: 16px;
            margin-bottom: 24px;
            color: #6C757D;
        }

        .message-content .btn {
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
        }


        .schedule-legend {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .schedule-legend h4 {
            margin-bottom: 15px;
            color: #1E293B;
            font-weight: 600;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .legend-item span:last-child {
            font-size: 14px;
            color: #64748B;
        }

        /* Estilos para el resumen semanal */
        .weekly-summary {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .weekly-summary h3 {
            margin-bottom: 15px;
            color: #1E293B;
            font-weight: 600;
        }

        .summary-cell {
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .summary-cell.central-transporte-manana {
            background: #E8F5E8;
            color: #2E7D32;
        }

        .summary-cell.central-transporte-tarde {
            background: #FFF3E0;
            color: #E65100;
        }

        .summary-cell.despacho-central-manana {
            background: #E3F2FD;
            color: #1565C0;
        }

        .summary-cell.despacho-central-tarde {
            background: #F3E5F5;
            color: #7B1FA2;
        }

        .summary-cell.turno-noche {
            background: #ECEFF1;
            color: #455A64;
        }

        .summary-cell.total-hours {
            background: #E8F5E8;
            color: #2E7D32;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-cog"></i> Administraci√≥n</h2>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" data-section="dashboard">
                <i class="fas fa-chart-pie"></i> Dashboard
            </a>
            <a href="#" class="nav-item" data-section="employees">
                <i class="fas fa-users"></i> Empleados
            </a>
            <a href="#" class="nav-item" data-section="partTime">
                <i class="fas fa-user-clock"></i> Part-Time
            </a>
            <a href="#" class="nav-item" data-section="roles">
                <i class="fas fa-user-tag"></i> Roles
            </a>
            <a href="#" class="nav-item" data-section="schedules">
                <i class="fas fa-clock"></i> Horarios
            </a>
            <a href="#" class="nav-item" data-section="schedule-config">
                <i class="fas fa-calendar-alt"></i> Configurar Horarios
            </a>
            <a href="#" class="nav-item" data-section="attendance">
                <i class="fas fa-calendar-check"></i> Asistencia
            </a>
            <a href="#" class="nav-item" data-section="vacations">
                <i class="fas fa-plane"></i> Vacaciones
            </a>

            <a href="#" class="nav-item" data-section="dias-libres">
                <i class="fas fa-calendar-times"></i> D√≠as Libres
            </a>
            <a href="#" class="nav-item" data-section="reports">
                <i class="fas fa-chart-bar"></i> Reportes
            </a>
            <a href="#" class="nav-item" data-section="profile">
                <i class="fas fa-user"></i> Mi Perfil
            </a>
            <a href="#" class="nav-item" data-section="liquidaciones">
                <i class="fas fa-file-invoice-dollar"></i> Liquidaciones
            </a>
        </nav>
    </div>

    <div class="main-content">
        <header class="header">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="pageTitle">Dashboard</h1>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <span id="userName">Administrador</span>
                <button class="logout-btn" onclick="logout()" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </header>

        <div class="content">
            <div class="alert alert-success" id="successAlert"></div>
            <div class="alert alert-error" id="errorAlert"></div>
            <div class="alert alert-info" id="loadingAlert" style="display: none;">
                <div class="loading-spinner"></div>
                <span id="loadingMessage">Cargando...</span>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboardSection">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon primary">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalEmployees">0</div>
                        <div class="stat-label">Empleados Activos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon success">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="todayAttendance">0</div>
                        <div class="stat-label">Asistencias Hoy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon warning">
                                <i class="fas fa-plane"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="pendingVacations">0</div>
                        <div class="stat-label">Vacaciones Pendientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon info">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalHours">0h</div>
                        <div class="stat-label">Horas Trabajadas</div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Actividad Reciente</h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Empleado</th>
                                    <th>Acci√≥n</th>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivityTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Employees Section -->
            <div id="employeesSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">
                        Gesti√≥n de Empleados
                        <button class="btn btn-primary" onclick="showAddEmployeeModal()">
                            <i class="fas fa-plus"></i> Nuevo Empleado
                        </button>
                        <button class="btn btn-secondary" onclick="showRotationConfigModal()" style="margin-left: 10px;">
                            <i class="fas fa-sync-alt"></i> Configurar Rotaci√≥n
                        </button>
                    </h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Rol</th>
                                    <th>Colaci√≥n (min)</th>
                                    <th>Estado</th>
                                    <th>Fecha Contrataci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="employeesTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Part-Time Employees Section -->
            <div id="partTimeSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">
                        <i class="fas fa-user-clock"></i> Empleados Part-Time (Cobertura)
                    </h2>
                    
                    <!-- Bot√≥n para agregar empleado part-time -->
                    <div style="margin-bottom: 20px;">
                        <button onclick="togglePartTimeForm()" class="btn btn-outline-success" style="display: flex; align-items: center; gap: 8px; padding: 10px 20px;">
                            <i class="fas fa-user-plus"></i> 
                            <span>Contratar Empleado Part-Time</span>
                            <i id="partTimeToggleIcon" class="fas fa-chevron-down" style="margin-left: auto; transition: transform 0.3s ease;"></i>
                        </button>
                    </div>
                    
                    <!-- Formulario para empleado part-time (Colapsable) -->
                    <div id="partTimeForm" class="part-time-form" style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #c3e6c3; display: none;">
                        <h4 style="color: #2d5a2d; margin-bottom: 15px;">
                            <i class="fas fa-user-plus"></i> Nuevo Empleado Part-Time
                        </h4>
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px; color: #155724;">
                                <i class="fas fa-lightbulb"></i>
                                <strong>Empleado Flexible:</strong> Los empleados part-time pueden cubrir cualquier rol seg√∫n las necesidades del momento. 
                                No es necesario asignar un rol espec√≠fico para m√°xima flexibilidad operativa.
                            </div>
                        </div>
                        
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label for="partTimeName">Nombre Completo *</label>
                                <input type="text" id="partTimeName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="partTimeEmail">Email *</label>
                                <input type="email" id="partTimeEmail" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label for="partTimePhone">Tel√©fono</label>
                                <input type="tel" id="partTimePhone" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="partTimeRole">Rol de Cobertura</label>
                                <select id="partTimeRole" class="form-control">
                                    <option value="">Sin rol espec√≠fico (Flexible)</option>
                                </select>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    Los empleados part-time pueden cubrir cualquier rol seg√∫n las necesidades. 
                                    Dejar sin seleccionar para m√°xima flexibilidad.
                                </small>
                            </div>
                        </div>
                        
                        <!-- Configuraci√≥n de disponibilidad -->
                        <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h5 style="color: #495057; margin-bottom: 10px;">
                                <i class="fas fa-calendar-check"></i> Disponibilidad
                            </h5>
                            
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div class="form-group">
                                    <label>D√≠as de la Semana Disponibles</label>
                                    <div class="days-checkboxes" style="display: flex; gap: 10px; flex-wrap: wrap;">
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" value="1" id="partTimeDay1" style="margin: 0;"> L
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" value="2" id="partTimeDay2" style="margin: 0;"> M
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" value="3" id="partTimeDay3" style="margin: 0;"> X
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" value="4" id="partTimeDay4" style="margin: 0;"> J
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" value="5" id="partTimeDay5" style="margin: 0;"> V
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" value="6" id="partTimeDay6" style="margin: 0;"> S
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" value="7" id="partTimeDay7" style="margin: 0;"> D
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="partTimeMaxHours">Horas M√°ximas por Semana</label>
                                    <select id="partTimeMaxHours" class="form-control">
                                        <option value="20">20 horas</option>
                                        <option value="25">25 horas</option>
                                        <option value="30">30 horas</option>
                                        <option value="35">35 horas</option>
                                        <option value="40">40 horas</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="partTimeWeekends" style="margin-right: 8px;">
                                        Disponible Fines de Semana
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="partTimeHolidays" style="margin-right: 8px;">
                                        Disponible en Feriados
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Configuraci√≥n de cobertura -->
                        <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                            <h5 style="color: #495057; margin-bottom: 10px;">
                                <i class="fas fa-shield-alt"></i> Tipos de Cobertura
                            </h5>
                            
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="partTimeVacationCover" style="margin-right: 8px;" checked>
                                        Cobertura de Vacaciones
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="partTimeSickCover" style="margin-right: 8px;" checked>
                                        Cobertura de Enfermedades
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="partTimeEmergencyCover" style="margin-right: 8px;" checked>
                                        Cobertura de Emergencias
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="partTimeOvertimeCover" style="margin-right: 8px;">
                                        Cobertura de Horas Extra
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n adicional -->
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label for="partTimeSalary">Salario por Hora</label>
                                <input type="number" id="partTimeSalary" class="form-control" min="0" step="100" placeholder="Ej: 5000">
                            </div>
                            <div class="form-group">
                                <label for="partTimeStartDate">Fecha de Inicio</label>
                                <input type="date" id="partTimeStartDate" class="form-control">
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label for="partTimeNotes">Notas Adicionales</label>
                            <textarea id="partTimeNotes" class="form-control" rows="3" placeholder="Informaci√≥n adicional sobre el empleado..."></textarea>
                        </div>
                        
                        <!-- Botones de acci√≥n -->
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="clearPartTimeForm()" class="btn btn-secondary">
                                <i class="fas fa-eraser"></i> Limpiar
                            </button>
                            <button onclick="addPartTimeEmployee()" class="btn btn-success">
                                <i class="fas fa-user-plus"></i> Contratar Empleado
                            </button>
                        </div>
                    </div>
                    
                    <!-- Lista de empleados part-time -->
                    <div id="partTimeEmployeesList" style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #c3e6c3;">
                        <h4 style="color: #495057; margin-bottom: 15px;">
                            <i class="fas fa-users"></i> Empleados Part-Time Activos
                        </h4>
                        <div id="partTimeTableContainer">
                            <p class="text-muted">Cargando empleados part-time...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule Configuration Section -->
            <div id="schedule-configSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">
                        Configuraci√≥n de Horarios de Empleados
                        <button class="btn btn-primary" onclick="showAddScheduleModal()">
                            <i class="fas fa-plus"></i> Configurar Horario
                        </button>
                    </h2>
                    
                    <!-- Filtros -->
                    <div class="filters-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Empleado</label>
                            <select id="employeeFilter" onchange="filterSchedules()">
                                <option value="">Todos los empleados</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Rol</label>
                            <select id="roleFilter" onchange="filterSchedules()">
                                <option value="">Todos los roles</option>
                                <option value="FULL TIME">Full Time</option>
                                <option value="PART TIME">Part Time</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Empleado</th>
                                    <th>Rol</th>
                                    <th>D√≠as de Trabajo</th>
                                    <th>Horario</th>
                                    <th>Turno</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="schedulesTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Roles Section -->
            <div id="rolesSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">
                        Gesti√≥n de Roles
                        <button class="btn btn-primary" onclick="showAddRoleModal()">
                            <i class="fas fa-plus"></i> Nuevo Rol
                        </button>
                    </h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Descripci√≥n</th>
                                    <th>Permisos</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="rolesTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Schedules Section -->
            <div id="schedulesSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">
                        Calendario de Horarios
                        <button class="btn btn-primary" onclick="showAddScheduleModal()">
                            <i class="fas fa-plus"></i> Nuevo Horario
                        </button>
                    </h2>
                    
                    <!-- Bot√≥n para mostrar/ocultar turnos personalizados -->
                    <div style="margin-bottom: 20px;">
                        <button onclick="toggleCustomShifts()" class="btn btn-outline-primary" style="display: flex; align-items: center; gap: 8px; padding: 10px 20px;">
                            <i class="fas fa-plus-circle"></i> 
                            <span>Agregar Turno Personalizado</span>
                            <i id="customShiftsToggleIcon" class="fas fa-chevron-down" style="margin-left: auto; transition: transform 0.3s ease;"></i>
                        </button>
                    </div>
                    
                    <!-- Secci√≥n de Turnos Personalizados (Colapsable) -->
                    <div id="customShiftsSection" class="custom-shifts-section" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #e9ecef; display: none; animation: slideDown 0.3s ease;">
                        <h3 style="color: #495057; margin-bottom: 15px;">
                            <i class="fas fa-plus-circle" style="color: #28a745;"></i> Turnos Personalizados
                        </h3>
                        <p style="color: #6c757d; margin-bottom: 20px;">Agrega turnos adicionales seg√∫n las necesidades de la empresa</p>
                        
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label for="customShiftName">Nombre del Turno</label>
                                <input type="text" id="customShiftName" class="form-control" placeholder="Ej: Turno Especial">
                            </div>
                            <div class="form-group">
                                <label for="customShiftRole">Rol Requerido</label>
                                <select id="customShiftRole" class="form-control">
                                    <option value="">Seleccionar rol...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group">
                                <label for="customShiftStart">Hora de Entrada</label>
                                <input type="time" id="customShiftStart" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="customShiftEnd">Hora de Salida</label>
                                <input type="time" id="customShiftEnd" class="form-control">
                            </div>
                        </div>
                        
                        <div class="form-row" style="margin-bottom: 20px;">
                            <div class="form-group">
                                <label>D√≠as de la Semana</label>
                                <div class="days-checkboxes" style="display: flex; gap: 15px; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                        <input type="checkbox" value="1" style="margin: 0;"> Lunes
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                        <input type="checkbox" value="2" style="margin: 0;"> Martes
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                        <input type="checkbox" value="3" style="margin: 0;"> Mi√©rcoles
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                        <input type="checkbox" value="4" style="margin: 0;"> Jueves
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                        <input type="checkbox" value="5" style="margin: 0;"> Viernes
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                        <input type="checkbox" value="6" style="margin: 0;"> S√°bado
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                        <input type="checkbox" value="7" style="margin: 0;"> Domingo
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="addCustomShift()" class="btn btn-success">
                                <i class="fas fa-plus"></i> Agregar Turno Personalizado
                            </button>
                            <button onclick="clearCustomShiftForm()" class="btn btn-secondary">
                                <i class="fas fa-eraser"></i> Limpiar Formulario
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bot√≥n para ver feriados -->
                    <div style="margin-bottom: 20px;">
                        <button onclick="showHolidaysModal()" class="btn btn-info">
                            <i class="fas fa-calendar-star"></i> Ver Feriados de Chile
                        </button>
                    </div>
                    
                    <!-- Bot√≥n para editar turnos existentes -->
                    <div style="margin-bottom: 20px;">
                        <button onclick="toggleEditShifts()" class="btn btn-outline-warning" style="display: flex; align-items: center; gap: 8px; padding: 10px 20px;">
                            <i class="fas fa-edit"></i> 
                            <span>Editar Turnos Existentes</span>
                            <i id="editShiftsToggleIcon" class="fas fa-chevron-down" style="margin-left: auto; transition: transform 0.3s ease;"></i>
                        </button>
                    </div>
                    
                    <!-- Secci√≥n de Edici√≥n de Turnos (Colapsable) -->
                    <div id="editShiftsSection" class="edit-shifts-section" style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #ffeaa7; display: none;">
                        <h3 style="color: #856404; margin-bottom: 15px;">
                            <i class="fas fa-edit" style="color: #f39c12;"></i> Configuraci√≥n Avanzada de Turnos
                        </h3>
                        <p style="color: #856404; margin-bottom: 20px;">Edita y configura turnos existentes con opciones avanzadas</p>
                        
                        <!-- Selector de turno a editar -->
                        <div class="form-row" style="margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="selectShiftToEdit">Seleccionar Turno a Editar</label>
                                <select id="selectShiftToEdit" class="form-control" onchange="loadShiftForEdit()">
                                    <option value="">Seleccionar turno...</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Configuraci√≥n del turno seleccionado -->
                        <div id="shiftEditForm" style="display: none;">
                            <!-- Informaci√≥n b√°sica -->
                            <div class="config-section" style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <h4 style="color: #495057; margin-bottom: 15px;">
                                    <i class="fas fa-info-circle"></i> Informaci√≥n B√°sica
                                </h4>
                                
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div class="form-group">
                                        <label for="editShiftName">Nombre del Turno</label>
                                        <input type="text" id="editShiftName" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="editShiftRole">Rol Requerido</label>
                                        <select id="editShiftRole" class="form-control">
                                            <option value="">Seleccionar rol...</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="editShiftStart">Hora de Entrada</label>
                                        <input type="time" id="editShiftStart" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="editShiftEnd">Hora de Salida</label>
                                        <input type="time" id="editShiftEnd" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Configuraci√≥n de d√≠as -->
                            <div class="config-section" style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <h4 style="color: #495057; margin-bottom: 15px;">
                                    <i class="fas fa-calendar-week"></i> D√≠as de Trabajo
                                </h4>
                                
                                <div class="form-group">
                                    <label>D√≠as de la Semana</label>
                                    <div class="days-checkboxes" style="display: flex; gap: 15px; flex-wrap: wrap;">
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" value="1" id="editDay1" style="margin: 0;"> Lunes
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" value="2" id="editDay2" style="margin: 0;"> Martes
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" value="3" id="editDay3" style="margin: 0;"> Mi√©rcoles
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" value="4" id="editDay4" style="margin: 0;"> Jueves
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" value="5" id="editDay5" style="margin: 0;"> Viernes
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" value="6" id="editDay6" style="margin: 0;"> S√°bado
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" value="7" id="editDay7" style="margin: 0;"> Domingo
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Opciones de d√≠as especiales -->
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="editWorkHolidays" style="margin-right: 8px;">
                                            Trabajar en Feriados
                                        </label>
                                        <small class="form-text text-muted">Si est√° marcado, este turno trabajar√° en d√≠as feriados</small>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="editWeekendOnly" style="margin-right: 8px;">
                                            Solo Fines de Semana
                                        </label>
                                        <small class="form-text text-muted">Restringir turno solo a s√°bados y domingos</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Configuraci√≥n de horarios especiales -->
                            <div class="config-section" style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <h4 style="color: #495057; margin-bottom: 15px;">
                                    <i class="fas fa-clock"></i> Configuraci√≥n de Horarios
                                </h4>
                                
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div class="form-group">
                                        <label for="editBreakDuration">Duraci√≥n de Colaci√≥n (minutos)</label>
                                        <select id="editBreakDuration" class="form-control">
                                            <option value="0">Sin colaci√≥n</option>
                                            <option value="15">15 minutos</option>
                                            <option value="30" selected>30 minutos</option>
                                            <option value="45">45 minutos</option>
                                            <option value="60">1 hora</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="editMaxHours">Horas M√°ximas por D√≠a</label>
                                        <select id="editMaxHours" class="form-control">
                                            <option value="8">8 horas</option>
                                            <option value="9">9 horas</option>
                                            <option value="10">10 horas</option>
                                            <option value="12">12 horas</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="editFlexibleHours" style="margin-right: 8px;">
                                            Horarios Flexibles
                                        </label>
                                        <small class="form-text text-muted">Permitir variaci√≥n de ¬±30 minutos en horarios</small>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="editOvertimeAllowed" style="margin-right: 8px;">
                                            Permitir Horas Extra
                                        </label>
                                        <small class="form-text text-muted">Permitir trabajo m√°s all√° del horario establecido</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Configuraci√≥n de personal -->
                            <div class="config-section" style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <h4 style="color: #495057; margin-bottom: 15px;">
                                    <i class="fas fa-users"></i> Configuraci√≥n de Personal
                                </h4>
                                
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div class="form-group">
                                        <label for="editMinEmployees">M√≠nimo de Empleados</label>
                                        <input type="number" id="editMinEmployees" class="form-control" min="1" max="10" value="1">
                                    </div>
                                    <div class="form-group">
                                        <label for="editMaxEmployees">M√°ximo de Empleados</label>
                                        <input type="number" id="editMaxEmployees" class="form-control" min="1" max="20" value="1">
                                    </div>
                                </div>
                                
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="editRotationRequired" style="margin-right: 8px;">
                                            Rotaci√≥n Obligatoria
                                        </label>
                                        <small class="form-text text-muted">Los empleados deben rotar en este turno</small>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="editPriorityShift" style="margin-right: 8px;">
                                            Turno Prioritario
                                        </label>
                                        <small class="form-text text-muted">Este turno tiene prioridad en la asignaci√≥n</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Configuraci√≥n de estado -->
                            <div class="config-section" style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h4 style="color: #495057; margin-bottom: 15px;">
                                    <i class="fas fa-toggle-on"></i> Estado del Turno
                                </h4>
                                
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="editShiftActive" style="margin-right: 8px;" checked>
                                            Turno Activo
                                        </label>
                                        <small class="form-text text-muted">El turno est√° disponible para asignaci√≥n</small>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="editShiftVisible" style="margin-right: 8px;" checked>
                                            Visible en Calendario
                                        </label>
                                        <small class="form-text text-muted">Mostrar en el calendario de horarios</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Botones de acci√≥n -->
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: space-between;">
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="saveShiftEdit()" class="btn btn-success">
                                        <i class="fas fa-save"></i> Guardar Cambios
                                    </button>
                                    <button onclick="resetShiftEdit()" class="btn btn-secondary">
                                        <i class="fas fa-undo"></i> Restaurar
                                    </button>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="duplicateShift()" class="btn btn-info">
                                        <i class="fas fa-copy"></i> Duplicar Turno
                                    </button>
                                    <button onclick="deleteShift()" class="btn btn-danger">
                                        <i class="fas fa-trash"></i> Eliminar Turno
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Controles del calendario -->
                    <div class="calendar-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div class="calendar-navigation">
                            <button class="btn btn-secondary" onclick="changeMonth(-1)">
                                <i class="fas fa-chevron-left"></i> Mes Anterior
                            </button>
                            <span id="currentMonthYear" class="month-year-display" style="font-size: 18px; font-weight: bold; margin: 0 20px;"></span>
                            <button class="btn btn-secondary" onclick="changeMonth(1)">
                                Mes Siguiente <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="calendar-actions">
                            <button class="btn btn-info" onclick="generateOfficialCalendar()">
                                <i class="fas fa-sync"></i> Regenerar Calendario
                            </button>
                        </div>
                    </div>

                    <!-- Calendario de horarios -->
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="day-header">Lun</div>
                            <div class="day-header">Mar</div>
                            <div class="day-header">Mi√©</div>
                            <div class="day-header">Jue</div>
                            <div class="day-header">Vie</div>
                            <div class="day-header">S√°b</div>
                            <div class="day-header">Dom</div>
                        </div>
                        <div id="calendarGrid" class="calendar-grid">
                            <!-- El calendario se generar√° din√°micamente -->
                        </div>
                    </div>

                    <!-- Panel de empleados del d√≠a seleccionado -->
                    <div id="dayEmployeesPanel" class="day-employees-panel" style="display: none; margin-top: 20px;">
                        <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 id="selectedDayTitle" class="panel-title"></h3>
                            <button class="btn btn-primary btn-sm" onclick="showEditScheduleModal()">
                                <i class="fas fa-edit"></i> Editar Turnos
                            </button>
                        </div>
                        <div id="dayEmployeesList" class="employees-list">
                            <!-- Los empleados del d√≠a se mostrar√°n aqu√≠ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Section -->
            <div id="attendanceSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">Asistencia de Empleados</h2>
                    
                    <!-- Filtros de asistencia -->
                    <div class="filters-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Fecha Inicio</label>
                            <input type="date" id="attendanceDateFrom" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Fecha Fin</label>
                            <input type="date" id="attendanceDateTo" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Empleado</label>
                            <select id="attendanceEmployeeFilter" class="form-control">
                                <option value="">Todos los empleados</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: end;">
                            <button class="btn btn-primary" onclick="loadAttendanceData()">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de asistencia -->
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Empleado</th>
                                    <th>Fecha</th>
                                    <th>Hora Entrada</th>
                                    <th>Hora Salida</th>
                                    <th>Horas Trabajadas</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTable">
                                <!-- Los datos se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="section">
                    <h2 class="section-title">Calendario de Turnos</h2>
                    
                    <!-- Controles del calendario -->
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center;">
                        <button class="btn btn-secondary" onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i> Mes Anterior
                        </button>
                        <h3 id="currentMonth" style="margin: 0; min-width: 200px; text-align: center;"></h3>
                        <button class="btn btn-secondary" onclick="nextMonth()">
                            Mes Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                        <button class="btn btn-primary" onclick="generateRotatingSchedule()">
                            <i class="fas fa-sync"></i> Generar Rotaci√≥n
                        </button>
                        <button class="btn btn-success" onclick="exportSchedule()">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>

                    <!-- Calendario de turnos -->
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="day-header">Lun</div>
                            <div class="day-header">Mar</div>
                            <div class="day-header">Mi√©</div>
                            <div class="day-header">Jue</div>
                            <div class="day-header">Vie</div>
                            <div class="day-header">S√°b</div>
                            <div class="day-header">Dom</div>
                        </div>
                        <div id="calendarGrid" class="calendar-grid">
                            <!-- El calendario se generar√° din√°micamente -->
                        </div>
                    </div>

                    <!-- Leyenda de turnos -->
                    <div class="schedule-legend" style="margin-top: 20px;">
                        <h4>Leyenda de Turnos:</h4>
                        <div class="legend-items">
                            <div class="legend-item">
                                <span class="legend-color" style="background-color: #4CAF50;"></span>
                                <span>Central Transporte - Ma√±ana (07:00-16:00) - Lunes a Domingo</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background-color: #FF9800;"></span>
                                <span>Central Transporte - Tarde (16:00-23:30) - Lunes a Domingo</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background-color: #2196F3;"></span>
                                <span>Despacho Central - Ma√±ana (07:00-15:00) - Lunes a S√°bado</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background-color: #9C27B0;"></span>
                                <span>Despacho Central - Tarde (15:00-23:00) - Lunes a S√°bado</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background-color: #607D8B;"></span>
                                <span>Turno Noche (23:30-07:30) - Lunes a Domingo (24/7)</span>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: #F8FAFC; border-radius: 8px; border-left: 4px solid #3B82F6;">
                            <strong>üìã Informaci√≥n del Sistema:</strong><br>
                            ‚Ä¢ Siempre hay 3 personas trabajando al mismo tiempo<br>
                            ‚Ä¢ Central de Transporte: 1 persona (Lunes a Domingo)<br>
                            ‚Ä¢ Despacho Central: 1 persona (Lunes a S√°bado)<br>
                            ‚Ä¢ Turno Noche: 1 persona (Lunes a Domingo - 24/7)<br>
                            ‚Ä¢ Total: 5 empleados rotando entre los 3 turnos<br>
                            ‚Ä¢ Todos los empleados trabajan 44 horas semanales<br>
                            ‚Ä¢ Turno Noche: Rotaci√≥n entre Empleado 1, Empleado 2, Empleado 3, Empleado 4 y Empleado 5
                        </div>
                    </div>

                    <!-- Tabla de resumen semanal -->
                    <div class="table-container" style="margin-top: 30px;">
                        <h3>Resumen Semanal de Turnos</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Empleado</th>
                                    <th>Semana 1</th>
                                    <th>Semana 2</th>
                                    <th>Semana 3</th>
                                    <th>Semana 4</th>
                                    <th>Semana 5</th>
                                    <th>Horas Totales</th>
                                </tr>
                            </thead>
                            <tbody id="weeklySummaryTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Vacations Section -->
            <div id="vacationsSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">Gesti√≥n de Vacaciones</h2>
                    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                        <select id="vacationStatusFilter" class="form-control" style="width: auto;">
                            <option value="">Todos los estados</option>
                            <option value="pendiente">Pendientes</option>
                            <option value="aprobado">Aprobadas</option>
                            <option value="rechazado">Rechazadas</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadVacationsData()">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Empleado</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Fin</th>
                                    <th>D√≠as</th>
                                    <th>Estado</th>
                                    <th>Motivo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="vacationsTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profileSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">Mi Perfil</h2>
                    
                    <div class="profile-container" style="display: flex; gap: 30px; align-items: flex-start;">
                        <!-- Foto de perfil -->
                        <div class="profile-photo-section" style="flex: 0 0 200px;">
                            <div class="profile-photo-container" style="text-align: center;">
                                <div class="profile-photo" id="profilePhoto" style="width: 150px; height: 150px; border-radius: 50%; background: #E2E8F0; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; border: 3px solid #CBD5E1; overflow: hidden;">
                                    <i class="fas fa-user" style="font-size: 60px; color: #94A3B8;"></i>
                                </div>
                                <input type="file" id="photoInput" accept="image/*" style="display: none;">
                                <button class="btn" onclick="document.getElementById('photoInput').click()" style="background: #3B82F6; color: white; margin-bottom: 10px;">
                                    <i class="fas fa-camera"></i> Cambiar Foto
                                </button>
                                <button class="btn" onclick="removeProfilePhoto()" style="background: #EF4444; color: white; display: none;" id="removePhotoBtn">
                                    <i class="fas fa-trash"></i> Eliminar Foto
                                </button>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n del perfil -->
                        <div class="profile-info" style="flex: 1;">
                            <div class="info-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <h3 style="margin-top: 0; color: #1E293B;">Informaci√≥n Personal</h3>
                                <div class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="info-item">
                                        <label style="font-weight: 600; color: #475569;">Nombre:</label>
                                        <p id="profileName" style="margin: 5px 0; color: #1E293B;"></p>
                                    </div>
                                    <div class="info-item">
                                        <label style="font-weight: 600; color: #475569;">Apellido:</label>
                                        <p id="profileLastName" style="margin: 5px 0; color: #1E293B;"></p>
                                    </div>
                                    <div class="info-item">
                                        <label style="font-weight: 600; color: #475569;">Email:</label>
                                        <p id="profileEmail" style="margin: 5px 0; color: #1E293B;"></p>
                                    </div>
                                    <div class="info-item">
                                        <label style="font-weight: 600; color: #475569;">Tel√©fono:</label>
                                        <p id="profilePhone" style="margin: 5px 0; color: #1E293B;"></p>
                                    </div>
                                    <div class="info-item">
                                        <label style="font-weight: 600; color: #475569;">Rol:</label>
                                        <p id="profileRole" style="margin: 5px 0; color: #1E293B;"></p>
                                    </div>
                                    <div class="info-item">
                                        <label style="font-weight: 600; color: #475569;">Fecha de Contrataci√≥n:</label>
                                        <p id="profileHireDate" style="margin: 5px 0; color: #1E293B;"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Liquidaciones Section -->
            <div id="liquidacionesSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">
                        Gesti√≥n de Liquidaciones
                        <button class="btn btn-primary" onclick="showUploadPayrollModal()">
                            <i class="fas fa-upload"></i> Subir Liquidaci√≥n
                        </button>
                    </h2>
                    
                    <!-- Filtros -->
                    <div class="filters" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div class="form-group" style="margin: 0;">
                            <label>Empleado:</label>
                            <select id="payrollEmployeeFilter" onchange="filterPayrolls()">
                                <option value="">Todos los empleados</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>A√±o:</label>
                            <select id="payrollYearFilter" onchange="filterPayrolls()">
                                <option value="">Todos los a√±os</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Mes:</label>
                            <select id="payrollMonthFilter" onchange="filterPayrolls()">
                                <option value="">Todos los meses</option>
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tabla de liquidaciones -->
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Empleado</th>
                                    <th>Per√≠odo</th>
                                    <th>Archivo</th>
                                    <th>Tama√±o</th>
                                    <th>Subido por</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="payrollsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">Generar Reportes</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="stat-card">
                            <h3>Reporte de Asistencia</h3>
                            <div class="form-group">
                                <label>Fecha Inicio</label>
                                <input type="date" id="reportAttendanceFrom" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Fecha Fin</label>
                                <input type="date" id="reportAttendanceTo" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Empleado</label>
                                <select id="reportAttendanceEmployee" class="form-control">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="generateAttendanceReport()">
                                <i class="fas fa-download"></i> Generar Reporte
                            </button>
                        </div>
                        
                        <div class="stat-card">
                            <h3>Reporte de Horas</h3>
                            <div class="form-group">
                                <label>Fecha Inicio</label>
                                <input type="date" id="reportHoursFrom" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Fecha Fin</label>
                                <input type="date" id="reportHoursTo" class="form-control">
                            </div>
                            <button class="btn btn-primary" onclick="generateHoursReport()">
                                <i class="fas fa-download"></i> Generar Reporte
                            </button>
                        </div>
                        
                        <div class="stat-card">
                            <h3>Reporte de Vacaciones</h3>
                            <div class="form-group">
                                <label>A√±o</label>
                                <select id="reportVacationYear" class="form-control">
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="generateVacationReport()">
                                <i class="fas fa-download"></i> Generar Reporte
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar empleado -->
    <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agregar Nuevo Empleado</h3>
                <span class="close" onclick="closeModal('addEmployeeModal')">&times;</span>
            </div>
            <form id="addEmployeeForm">
                <div class="form-group">
                    <label for="employeeName">Nombre</label>
                    <input type="text" id="employeeName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="employeeLastName">Apellido</label>
                    <input type="text" id="employeeLastName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="employeeEmail">Email</label>
                    <input type="email" id="employeeEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="employeePhone">Tel√©fono</label>
                    <input type="tel" id="employeePhone" class="form-control">
                </div>
                <div class="form-group">
                    <label for="employeeRole">Rol</label>
                    <select id="employeeRole" class="form-control" required>
                        <option value="">Seleccionar rol...</option>
                    </select>
                </div>
                
                <!-- Secci√≥n de Horarios Personalizados -->
                <div class="form-group">
                    <label>Horario de Trabajo Personalizado</label>
                    <div class="schedule-info">
                        <small style="color: #6B7280; display: block; margin-bottom: 10px;">
                            ‚ÑπÔ∏è <strong>Colaci√≥n autom√°tica:</strong> Se descuentan 30 minutos por jornadas mayores a 5.5 horas (seg√∫n ley chilena)
                        </small>
                    </div>
                    <div class="schedule-container">
                        <div class="schedule-header">
                            <span>D√≠a</span>
                            <span>Hora Entrada</span>
                            <span>Hora Salida</span>
                            <span>Horas</span>
                            <span>Activo</span>
                        </div>
                        <div class="schedule-days">
                            <div class="schedule-day">
                                <span>Lunes</span>
                                <input type="time" class="time-input" id="lunes_entrada" onchange="calculateHours('lunes')">
                                <input type="time" class="time-input" id="lunes_salida" onchange="calculateHours('lunes')">
                                <span class="hours-display" id="lunes_horas">0h</span>
                                <input type="checkbox" id="lunes_activo" checked onchange="toggleDay('lunes')">
                            </div>
                            <div class="schedule-day">
                                <span>Martes</span>
                                <input type="time" class="time-input" id="martes_entrada" onchange="calculateHours('martes')">
                                <input type="time" class="time-input" id="martes_salida" onchange="calculateHours('martes')">
                                <span class="hours-display" id="martes_horas">0h</span>
                                <input type="checkbox" id="martes_activo" checked onchange="toggleDay('martes')">
                            </div>
                            <div class="schedule-day">
                                <span>Mi√©rcoles</span>
                                <input type="time" class="time-input" id="miercoles_entrada" onchange="calculateHours('miercoles')">
                                <input type="time" class="time-input" id="miercoles_salida" onchange="calculateHours('miercoles')">
                                <span class="hours-display" id="miercoles_horas">0h</span>
                                <input type="checkbox" id="miercoles_activo" checked onchange="toggleDay('miercoles')">
                            </div>
                            <div class="schedule-day">
                                <span>Jueves</span>
                                <input type="time" class="time-input" id="jueves_entrada" onchange="calculateHours('jueves')">
                                <input type="time" class="time-input" id="jueves_salida" onchange="calculateHours('jueves')">
                                <span class="hours-display" id="jueves_horas">0h</span>
                                <input type="checkbox" id="jueves_activo" checked onchange="toggleDay('jueves')">
                            </div>
                            <div class="schedule-day">
                                <span>Viernes</span>
                                <input type="time" class="time-input" id="viernes_entrada" onchange="calculateHours('viernes')">
                                <input type="time" class="time-input" id="viernes_salida" onchange="calculateHours('viernes')">
                                <span class="hours-display" id="viernes_horas">0h</span>
                                <input type="checkbox" id="viernes_activo" checked onchange="toggleDay('viernes')">
                            </div>
                            <div class="schedule-day">
                                <span>S√°bado</span>
                                <input type="time" class="time-input" id="sabado_entrada" onchange="calculateHours('sabado')">
                                <input type="time" class="time-input" id="sabado_salida" onchange="calculateHours('sabado')">
                                <span class="hours-display" id="sabado_horas">0h</span>
                                <input type="checkbox" id="sabado_activo" onchange="toggleDay('sabado')">
                            </div>
                            <div class="schedule-day">
                                <span>Domingo</span>
                                <input type="time" class="time-input" id="domingo_entrada" onchange="calculateHours('domingo')">
                                <input type="time" class="time-input" id="domingo_salida" onchange="calculateHours('domingo')">
                                <span class="hours-display" id="domingo_horas">0h</span>
                                <input type="checkbox" id="domingo_activo" onchange="toggleDay('domingo')">
                            </div>
                        </div>
                        <div class="schedule-summary">
                            <div class="total-hours">
                                <strong>Total semanal: <span id="total_horas_semanales">0</span> horas</strong>
                                <span class="hours-limit" id="hours_limit_status">‚úÖ Dentro del l√≠mite legal (m√°x. 44h)</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="employeePassword">Contrase√±a</label>
                    <input type="password" id="employeePassword" class="form-control" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal('addEmployeeModal')" style="background: #6B7280; color: white;">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar Empleado</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para configurar rotaci√≥n -->
    <div id="rotationConfigModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Configurar Sistema de Rotaci√≥n Equitativa</h3>
                <span class="close" onclick="closeModal('rotationConfigModal')">&times;</span>
            </div>
            <div class="rotation-config-content">
                <div class="config-section">
                    <h4>üìä Estado Actual del Sistema</h4>
                    <div id="rotationStats" class="stats-container">
                        <div class="stat-item">
                            <span class="stat-label">Empleados Activos:</span>
                            <span class="stat-value" id="activeEmployeesCount">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Horarios Disponibles:</span>
                            <span class="stat-value" id="availableSchedulesCount">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Semana Actual:</span>
                            <span class="stat-value" id="currentWeek">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="config-section">
                    <h4>‚öôÔ∏è Configuraci√≥n de Rotaci√≥n</h4>
                    <div class="rotation-options">
                        <div class="option-group">
                            <label>
                                <input type="radio" name="rotationType" value="automatic" checked>
                                <span class="option-label">
                                    <strong>Rotaci√≥n Autom√°tica</strong>
                                    <small>Distribuye empleados equitativamente entre todos los horarios</small>
                                </span>
                            </label>
                        </div>
                        <div class="option-group">
                            <label>
                                <input type="radio" name="rotationType" value="manual">
                                <span class="option-label">
                                    <strong>Rotaci√≥n Manual</strong>
                                    <small>Permite configurar horarios espec√≠ficos por empleado</small>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="config-section">
                    <h4>üìÖ Horarios Base del Sistema</h4>
                    <div class="schedules-preview">
                        <div class="schedule-item">
                            <span class="schedule-name">Turno Ma√±ana</span>
                            <span class="schedule-time">08:00 - 16:00</span>
                            <span class="schedule-days">Lun-Vie</span>
                            <span class="schedule-hours">7.5h</span>
                        </div>
                        <div class="schedule-item">
                            <span class="schedule-name">Turno Tarde</span>
                            <span class="schedule-time">16:00 - 00:00</span>
                            <span class="schedule-days">Lun-Vie</span>
                            <span class="schedule-hours">7.5h</span>
                        </div>
                        <div class="schedule-item">
                            <span class="schedule-name">Turno Noche</span>
                            <span class="schedule-time">00:00 - 08:00</span>
                            <span class="schedule-days">Lun-Vie</span>
                            <span class="schedule-hours">7.5h</span>
                        </div>
                        <div class="schedule-item">
                            <span class="schedule-name">Fin de Semana Ma√±ana</span>
                            <span class="schedule-time">09:00 - 17:00</span>
                            <span class="schedule-days">S√°b-Dom</span>
                            <span class="schedule-hours">7.5h</span>
                        </div>
                        <div class="schedule-item">
                            <span class="schedule-name">Fin de Semana Tarde</span>
                            <span class="schedule-time">17:00 - 01:00</span>
                            <span class="schedule-days">S√°b-Dom</span>
                            <span class="schedule-hours">7.5h</span>
                        </div>
                    </div>
                </div>
                
                <div class="config-section">
                    <h4>üîÑ Acciones de Rotaci√≥n</h4>
                    <div class="rotation-actions">
                        <button class="btn btn-primary" onclick="executeSmartRotation()">
                            <i class="fas fa-sync-alt"></i> Ejecutar Rotaci√≥n Inteligente
                        </button>
                        <button class="btn btn-secondary" onclick="showRotationPreview()">
                            <i class="fas fa-eye"></i> Vista Previa
                        </button>
                        <button class="btn btn-warning" onclick="resetAllSchedules()">
                            <i class="fas fa-undo"></i> Resetear Horarios
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar rol -->
    <div id="addRoleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agregar Nuevo Rol</h3>
                <span class="close" onclick="closeModal('addRoleModal')">&times;</span>
            </div>
            <form id="addRoleForm">
                <div class="form-group">
                    <label for="roleName">Nombre del Rol</label>
                    <input type="text" id="roleName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="roleDescription">Descripci√≥n</label>
                    <textarea id="roleDescription" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="rolePermissions">Permisos</label>
                    <select id="rolePermissions" class="form-control" required>
                        <option value="admin">Administrador</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="empleado">Empleado</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal('addRoleModal')" style="background: #6B7280; color: white;">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar Rol</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar horario -->
    <div id="addScheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agregar Nuevo Horario</h3>
                <span class="close" onclick="closeModal('addScheduleModal')">&times;</span>
            </div>
            <form id="addScheduleForm">
                <div class="form-group">
                    <label for="scheduleName">Nombre del Horario</label>
                    <input type="text" id="scheduleName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="scheduleStartTime">Hora de Entrada</label>
                    <input type="time" id="scheduleStartTime" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="scheduleEndTime">Hora de Salida</label>
                    <input type="time" id="scheduleEndTime" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>D√≠as de la Semana</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                        <label><input type="checkbox" value="1" class="scheduleDays"> Lunes</label>
                        <label><input type="checkbox" value="2" class="scheduleDays"> Martes</label>
                        <label><input type="checkbox" value="3" class="scheduleDays"> Mi√©rcoles</label>
                        <label><input type="checkbox" value="4" class="scheduleDays"> Jueves</label>
                        <label><input type="checkbox" value="5" class="scheduleDays"> Viernes</label>
                        <label><input type="checkbox" value="6" class="scheduleDays"> S√°bado</label>
                        <label><input type="checkbox" value="0" class="scheduleDays"> Domingo</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="scheduleDescription">Descripci√≥n</label>
                    <textarea id="scheduleDescription" class="form-control" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal('addScheduleModal')" style="background: #6B7280; color: white;">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar Horario</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para asignar horario a empleado -->
    <div id="assignScheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Asignar Horario a Empleado</h3>
                <span class="close" onclick="closeModal('assignScheduleModal')">&times;</span>
            </div>
            <form id="assignScheduleForm">
                <div class="form-group">
                    <label for="assignEmployee">Empleado</label>
                    <select id="assignEmployee" class="form-control" required>
                        <option value="">Seleccionar empleado...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assignSchedule">Horario</label>
                    <select id="assignSchedule" class="form-control" required>
                        <option value="">Seleccionar horario...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assignStartDate">Fecha de Inicio</label>
                    <input type="date" id="assignStartDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="assignEndDate">Fecha de Fin (opcional)</label>
                    <input type="date" id="assignEndDate" class="form-control">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal('assignScheduleModal')" style="background: #6B7280; color: white;">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Asignar Horario</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para editar horarios de turnos -->
    <div id="editScheduleModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Editar Horarios de Turnos</h3>
                <span class="close" onclick="closeModal('editScheduleModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="shifts-container">
                    <div class="shift-item">
                        <h4>Centralista Turno Ma√±ana</h4>
                        <div class="time-inputs">
                            <div class="form-group">
                                <label>Hora de Entrada</label>
                                <input type="time" id="centralistaMananaEntrada" class="form-control" value="08:00">
                            </div>
                            <div class="form-group">
                                <label>Hora de Salida</label>
                                <input type="time" id="centralistaMananaSalida" class="form-control" value="16:00">
                            </div>
                        </div>
                    </div>
                    
                    <div class="shift-item">
                        <h4>Centralista Turno Tarde</h4>
                        <div class="time-inputs">
                            <div class="form-group">
                                <label>Hora de Entrada</label>
                                <input type="time" id="centralistaTardeEntrada" class="form-control" value="16:00">
                            </div>
                            <div class="form-group">
                                <label>Hora de Salida</label>
                                <input type="time" id="centralistaTardeSalida" class="form-control" value="00:00">
                            </div>
                        </div>
                    </div>
                    
                    <div class="shift-item">
                        <h4>Despachador Turno Ma√±ana</h4>
                        <div class="time-inputs">
                            <div class="form-group">
                                <label>Hora de Entrada</label>
                                <input type="time" id="despachadorMananaEntrada" class="form-control" value="08:00">
                            </div>
                            <div class="form-group">
                                <label>Hora de Salida</label>
                                <input type="time" id="despachadorMananaSalida" class="form-control" value="16:00">
                            </div>
                        </div>
                    </div>
                    
                    <div class="shift-item">
                        <h4>Despachador Turno Tarde</h4>
                        <div class="time-inputs">
                            <div class="form-group">
                                <label>Hora de Entrada</label>
                                <input type="time" id="despachadorTardeEntrada" class="form-control" value="16:00">
                            </div>
                            <div class="form-group">
                                <label>Hora de Salida</label>
                                <input type="time" id="despachadorTardeSalida" class="form-control" value="00:00">
                            </div>
                        </div>
                    </div>
                    
                    <div class="shift-item">
                        <h4>Turno Noche</h4>
                        <div class="time-inputs">
                            <div class="form-group">
                                <label>Hora de Entrada</label>
                                <input type="time" id="nocheEntrada" class="form-control" value="00:00">
                            </div>
                            <div class="form-group">
                                <label>Hora de Salida</label>
                                <input type="time" id="nocheSalida" class="form-control" value="08:00">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('editScheduleModal')" style="background: #6B7280; color: white;">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveScheduleChanges()">
                    <i class="fas fa-save"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para mostrar feriados -->
    <div id="holidaysModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">üóìÔ∏è Feriados de Chile</h3>
                <span class="close" onclick="closeModal('holidaysModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="holidaysList"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" onclick="closeModal('holidaysModal')" style="background: #6B7280; color: white;">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edici√≥n de Horarios Part-Time -->
    <div id="partTimeScheduleModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="partTimeScheduleModalTitle">Editar Horarios de Empleado Part-Time</h3>
                <span class="close" onclick="closeModal('partTimeScheduleModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="partTimeScheduleContent">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('partTimeScheduleModal')" class="btn btn-secondary">Cancelar</button>
                <button onclick="savePartTimeSchedule()" class="btn btn-success">
                    <i class="fas fa-save"></i> Guardar Horarios
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para subir liquidaci√≥n -->
    <div id="uploadPayrollModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Subir Liquidaci√≥n de Sueldo</h3>
                <span class="close" onclick="closeModal('uploadPayrollModal')">&times;</span>
            </div>
            <form id="uploadPayrollForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="payrollEmployee">Empleado *</label>
                    <select id="payrollEmployee" class="form-control" required>
                        <option value="">Seleccionar empleado...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payrollPeriod">Per√≠odo *</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="payrollMonth" class="form-control" required style="flex: 1;">
                            <option value="">Mes</option>
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                        <select id="payrollYear" class="form-control" required style="flex: 1;">
                            <option value="">A√±o</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="payrollFile">Archivo de Liquidaci√≥n *</label>
                    <input type="file" id="payrollFile" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx" required>
                    <small style="color: #666;">Formatos permitidos: PDF, DOC, DOCX, XLS, XLSX (m√°ximo 10MB)</small>
                </div>
                <div class="form-group">
                    <label for="payrollObservations">Observaciones</label>
                    <textarea id="payrollObservations" class="form-control" rows="3" placeholder="Observaciones adicionales (opcional)"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('uploadPayrollModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Subir Liquidaci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para editar tiempo de colaci√≥n -->
    <div id="editBreakTimeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Editar Tiempo de Colaci√≥n</h3>
                <span class="close" onclick="closeModal('editBreakTimeModal')">&times;</span>
            </div>
            <form id="editBreakTimeForm">
                <div class="form-group">
                    <label for="breakTimeEmployee">Empleado</label>
                    <input type="text" id="breakTimeEmployee" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="breakTimeMinutes">Tiempo de Colaci√≥n (minutos)</label>
                    <input type="number" id="breakTimeMinutes" class="form-control" min="0" max="120" required>
                    <small style="color: #666;">Rango permitido: 0 - 120 minutos</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editBreakTimeModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para configurar horario de empleado -->
    <div id="addScheduleConfigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Configurar Horario de Empleado</h3>
                <span class="close" onclick="closeModal('addScheduleConfigModal')">&times;</span>
            </div>
            <form id="addScheduleConfigForm">
                <div class="form-group">
                    <label for="scheduleEmployee">Empleado</label>
                    <select id="scheduleEmployee" class="form-control" required>
                        <option value="">Seleccionar empleado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="scheduleRole">Rol</label>
                    <select id="scheduleRole" class="form-control" required onchange="updateScheduleOptions()">
                        <option value="">Seleccionar rol</option>
                        <option value="FULL TIME">Full Time</option>
                        <option value="PART TIME">Part Time</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>D√≠as de Trabajo</label>
                    <div class="checkbox-group" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <label><input type="checkbox" name="workDays" value="1"> Lunes</label>
                        <label><input type="checkbox" name="workDays" value="2"> Martes</label>
                        <label><input type="checkbox" name="workDays" value="3"> Mi√©rcoles</label>
                        <label><input type="checkbox" name="workDays" value="4"> Jueves</label>
                        <label><input type="checkbox" name="workDays" value="5"> Viernes</label>
                        <label><input type="checkbox" name="workDays" value="6"> S√°bado</label>
                        <label><input type="checkbox" name="workDays" value="0"> Domingo</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="scheduleShift">Turno</label>
                    <select id="scheduleShift" class="form-control" required>
                        <option value="">Seleccionar turno</option>
                        <option value="TURNO_MANANA">Turno Ma√±ana (08:00-16:00)</option>
                        <option value="TURNO_TARDE">Turno Tarde (16:00-00:00)</option>
                        <option value="TURNO_NOCHE">Turno Noche (00:00-08:00)</option>
                        <option value="FIN_SEMANA_MANANA">Fin de Semana Ma√±ana (09:00-17:00)</option>
                        <option value="FIN_SEMANA_TARDE">Fin de Semana Tarde (17:00-01:00)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="scheduleStatus">Estado</label>
                    <select id="scheduleStatus" class="form-control" required>
                        <option value="ACTIVO">Activo</option>
                        <option value="INACTIVO">Inactivo</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal('addScheduleConfigModal')" style="background: #6B7280; color: white;">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Horario
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let employees = [];
        let roles = [];
        let schedules = [];
        
        // Sistema de cach√© para evitar llamadas repetitivas
        let cache = {
            employees: { data: null, timestamp: 0, ttl: 30000 }, // 30 segundos
            roles: { data: null, timestamp: 0, ttl: 60000 }, // 1 minuto
            schedules: { data: null, timestamp: 0, ttl: 30000 }, // 30 segundos
            employeeSchedules: { data: null, timestamp: 0, ttl: 30000 } // 30 segundos
        };
        
        // Sistema de cola de peticiones para evitar llamadas concurrentes
        let requestQueue = new Map();
        let isProcessingQueue = false;
        
        // Funci√≥n para verificar si el cach√© es v√°lido
        function isCacheValid(cacheKey) {
            const now = Date.now();
            return cache[cacheKey] && 
                   cache[cacheKey].data && 
                   (now - cache[cacheKey].timestamp) < cache[cacheKey].ttl;
        }
        
        // Funci√≥n para obtener datos del cach√© o hacer llamada a la API con cola
        async function getCachedData(cacheKey, apiUrl, options = {}) {
            // Verificar cach√© primero
            if (isCacheValid(cacheKey)) {
                console.log(`üì¶ Usando cach√© para ${cacheKey}`);
                return cache[cacheKey].data;
            }
            
            // Si ya hay una petici√≥n en curso para esta clave, esperar a que termine
            if (requestQueue.has(cacheKey)) {
                console.log(`‚è≥ Esperando petici√≥n en curso para ${cacheKey}`);
                return await requestQueue.get(cacheKey);
            }
            
            // Crear una nueva promesa para esta petici√≥n
            const requestPromise = makeApiRequest(cacheKey, apiUrl, options);
            requestQueue.set(cacheKey, requestPromise);
            
            try {
                const result = await requestPromise;
                return result;
            } finally {
                // Limpiar la cola cuando termine
                requestQueue.delete(cacheKey);
            }
        }
        
        // Funci√≥n para hacer la petici√≥n real a la API
        async function makeApiRequest(cacheKey, apiUrl, options = {}) {
            console.log(`üåê Haciendo llamada a la API para ${cacheKey}`);
            
            // Delay progresivo para evitar rate limiting
            const delay = Math.min(500 + (requestQueue.size * 100), 2000);
            await new Promise(resolve => setTimeout(resolve, delay));
            
            let retryCount = 0;
            const maxRetries = 3;
            
            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            ...options.headers
                        },
                        ...options
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        cache[cacheKey] = {
                            data: data,
                            timestamp: Date.now(),
                            ttl: cache[cacheKey]?.ttl || 30000
                        };
                        console.log(`‚úÖ Datos obtenidos y cacheados para ${cacheKey}`);
                        return data;
                    } else if (response.status === 429) {
                        retryCount++;
                        const waitTime = Math.min(1000 * Math.pow(2, retryCount), 10000);
                        console.warn(`‚ö†Ô∏è Rate limit alcanzado para ${cacheKey}, reintentando en ${waitTime}ms (intento ${retryCount}/${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                        continue;
                    } else {
                        console.error(`Error ${response.status} en ${cacheKey}:`, response.statusText);
                        return null;
                    }
                } catch (error) {
                    retryCount++;
                    if (retryCount >= maxRetries) {
                        console.error(`Error final en ${cacheKey}:`, error);
                        return null;
                    }
                    console.warn(`Error en ${cacheKey}, reintentando... (${retryCount}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                }
            }
            
            return null;
        }
        
        // Funci√≥n para limpiar cach√© espec√≠fico
        function clearCache(cacheKey) {
            if (cache[cacheKey]) {
                cache[cacheKey] = { data: null, timestamp: 0, ttl: cache[cacheKey].ttl };
            }
        }
        
        // Funci√≥n para limpiar todo el cach√©
        function clearAllCache() {
            Object.keys(cache).forEach(key => {
                cache[key] = { data: null, timestamp: 0, ttl: cache[key].ttl };
            });
        }

        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Inicializando aplicaci√≥n...');
            await checkAuth();
            await loadUserData();
            await loadDashboardData();
            await loadRoles();
            await loadSchedules();
            setupEventListeners();
            initializeDateInputs();
            console.log('Aplicaci√≥n inicializada correctamente');
        });

        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/';
                return;
            }

            try {
                const response = await fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/';
                    return;
                }

                const data = await response.json();
                currentUser = data.user;

                if (currentUser.permisos !== 'admin') {
                    window.location.href = '/dashboard';
                    return;
                }
            } catch (error) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/';
            }
        }

        async function loadUserData() {
            if (currentUser) {
                document.getElementById('userName').textContent = `${currentUser.nombre} ${currentUser.apellido}`;
                document.getElementById('userAvatar').textContent = currentUser.nombre.charAt(0);
            }
        }

        async function loadDashboardData() {
            try {
                const response = await fetch('/api/empleados/stats/overview', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateDashboardStats(data.data);
                }
            } catch (error) {
                showError('Error al cargar datos del dashboard');
            }
        }

        function updateDashboardStats(stats) {
            document.getElementById('totalEmployees').textContent = stats.empleadosActivos;
            document.getElementById('todayAttendance').textContent = stats.asistenciasHoy;
            document.getElementById('pendingVacations').textContent = stats.vacacionesPendientes;
        }

        async function loadRoles() {
            try {
                console.log('Cargando roles para selects...');
                const data = await getCachedData('roles', '/api/roles');
                if (data) {
                    console.log('Datos de roles para selects:', data);
                    roles = data.data;
                    populateRoleSelect();
                }
            } catch (error) {
                console.error('Error al cargar roles para selects:', error);
                showError('Error al cargar roles: ' + error.message);
            }
        }

        function populateRoleSelect() {
            console.log('Poblando select de roles...');
            const select = document.getElementById('employeeRole');
            if (!select) {
                console.error('No se encontr√≥ el elemento employeeRole');
                return;
            }
            select.innerHTML = '<option value="">Seleccionar rol...</option>';
            console.log('Roles disponibles:', roles.length);
            roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id;
                option.textContent = role.nombre;
                select.appendChild(option);
            });
        }
        
        // Funci√≥n para poblar select de roles en turnos personalizados
        function populateCustomShiftRoleSelect() {
            const select = document.getElementById('customShiftRole');
            if (!select) return;
            
            if (cachedData.roles && cachedData.roles.length > 0) {
                const roles = cachedData.roles;
                select.innerHTML = '<option value="">Seleccionar rol...</option>';
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = role.nombre;
                    select.appendChild(option);
                });
            } else {
                loadRoles();
            }
        }

        async function loadEmployees() {
            try {
                console.log('Cargando empleados...');
                const data = await getCachedData('employees', '/api/empleados');
                if (data) {
                    console.log('Datos de empleados:', data);
                    employees = data.data;
                    updateEmployeesTable();
                }
            } catch (error) {
                console.error('Error al cargar empleados:', error);
                showError('Error al cargar empleados: ' + error.message);
            }
        }

        function updateEmployeesTable() {
            console.log('Actualizando tabla de empleados...');
            const tbody = document.getElementById('employeesTable');
            if (!tbody) {
                console.error('No se encontr√≥ el elemento employeesTable');
                return;
            }
            tbody.innerHTML = '';

            console.log('Empleados a mostrar:', employees.length);
            employees.forEach(employee => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${employee.nombre} ${employee.apellido}</td>
                    <td>${employee.email}</td>
                    <td>${employee.rol_nombre || 'Sin rol'}</td>
                    <td>
                        <span class="break-time" style="display: inline-block; min-width: 40px; text-align: center; background: #E5E7EB; padding: 2px 6px; border-radius: 4px; font-size: 12px;">
                            ${employee.tiempo_colacion || 30}
                        </span>
                        <button class="btn btn-sm btn-outline-primary" onclick="editBreakTime(${employee.id}, ${employee.tiempo_colacion || 30})" style="margin-left: 5px; padding: 2px 6px; font-size: 10px;" title="Editar tiempo de colaci√≥n">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                    <td><span class="status-badge ${employee.activo ? 'badge-active' : 'badge-inactive'}">${employee.activo ? 'Activo' : 'Inactivo'}</span></td>
                    <td>${formatDate(employee.fecha_contratacion)}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editEmployee(${employee.id})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteEmployee(${employee.id})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Actualizar selects de empleados
            populateEmployeeSelects();
        }

        async function loadRolesTable() {
            try {
                console.log('Cargando roles...');
                const data = await getCachedData('roles', '/api/roles');
                if (data) {
                    console.log('Datos de roles:', data);
                    updateRolesTable(data.data);
                }
            } catch (error) {
                console.error('Error al cargar roles:', error);
                showError('Error al cargar roles: ' + error.message);
            }
        }

        function updateRolesTable(rolesData) {
            console.log('Actualizando tabla de roles...');
            const tbody = document.getElementById('rolesTable');
            if (!tbody) {
                console.error('No se encontr√≥ el elemento rolesTable');
                return;
            }
            tbody.innerHTML = '';

            console.log('Roles a mostrar:', rolesData.length);
            rolesData.forEach(role => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${role.nombre}</td>
                    <td>${role.descripcion || '-'}</td>
                    <td>${role.permisos}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editRole(${role.id})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteRole(${role.id})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function setupEventListeners() {
            // Navegaci√≥n del sidebar
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = item.dataset.section;
                    showSection(section);
                    
                    // Actualizar clase activa
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                });
            });

            // Men√∫ m√≥vil
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('open');
            });

            // Formulario de empleado
            document.getElementById('addEmployeeForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Formulario de empleado enviado');
                await addEmployee();
            });

            // Formulario de rol
            document.getElementById('addRoleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addRole();
            });

            // Formulario de horario
            document.getElementById('addScheduleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addSchedule();
            });

            // Formulario de asignar horario
            document.getElementById('assignScheduleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await assignSchedule();
            });

            // Bot√≥n de logout
            document.getElementById('logoutBtn').addEventListener('click', (e) => {
                e.preventDefault();
                console.log('Bot√≥n de logout clickeado');
                logout();
            });
        }

        function showSection(section) {
            console.log('Mostrando secci√≥n:', section);
            // Ocultar todas las secciones
            document.querySelectorAll('[id$="Section"]').forEach(sec => {
                sec.style.display = 'none';
            });

            // Mostrar secci√≥n seleccionada
            const targetSection = document.getElementById(section + 'Section');
            if (!targetSection) {
                console.error('No se encontr√≥ la secci√≥n:', section + 'Section');
                return;
            }
            targetSection.style.display = 'block';
            document.getElementById('pageTitle').textContent = getSectionTitle(section);

            // Cargar datos espec√≠ficos de la secci√≥n
            if (section === 'employees') {
                console.log('Cargando datos de empleados...');
                loadEmployees();
            } else if (section === 'partTime') {
                console.log('Cargando datos de empleados part-time...');
                loadPartTimeEmployees();
            } else if (section === 'roles') {
                console.log('Cargando datos de roles...');
                loadRolesTable();
            } else if (section === 'schedules') {
                console.log('Cargando datos de horarios...');
                // Generar calendario cuando se muestre la secci√≥n de horarios
                setTimeout(() => {
                    generateCalendar();
                    populateCustomShiftRoleSelect();
                    // Actualizar t√≠tulo del mes
                    const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                    const monthYearDisplay = document.getElementById('currentMonthYear');
                    if (monthYearDisplay) {
                        monthYearDisplay.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
                    }
                }, 100);
            } else if (section === 'attendance') {
                console.log('Cargando datos de asistencia...');
                loadAttendanceData();
            } else if (section === 'vacations') {
                console.log('Cargando datos de vacaciones...');
                loadVacationsData();
            } else if (section === 'profile') {
                console.log('Cargando datos del perfil...');
                loadProfileData();
            } else if (section === 'liquidaciones') {
                console.log('Cargando datos de liquidaciones...');
                loadPayrollsData();
            }
        }

        function getSectionTitle(section) {
            const titles = {
                dashboard: 'Dashboard',
                employees: 'Empleados',
                partTime: 'Empleados Part-Time',
                roles: 'Roles',
                schedules: 'Horarios',
                'schedule-config': 'Configurar Horarios',
                attendance: 'Asistencia',
                vacations: 'Vacaciones',
                reports: 'Reportes',
                profile: 'Mi Perfil',
                liquidaciones: 'Liquidaciones'
            };
            return titles[section] || 'Dashboard';
        }

        function showAddEmployeeModal() {
            // Resetear el formulario y t√≠tulo
            const form = document.getElementById('addEmployeeForm');
            form.reset();
            form.dataset.editingId = ''; // Limpiar el ID de edici√≥n
            document.querySelector('#addEmployeeModal .modal-title').textContent = 'Agregar Nuevo Empleado';
            
            // Resetear el bot√≥n de submit
            const submitBtn = document.querySelector('#addEmployeeForm button[type="submit"]');
            submitBtn.textContent = 'Agregar Empleado';
            
            // Resetear formulario de horarios
            resetScheduleForm();
            
            document.getElementById('addEmployeeModal').style.display = 'block';
        }
        
        // Funciones para el sistema de rotaci√≥n
        function showRotationConfigModal() {
            document.getElementById('rotationConfigModal').style.display = 'block';
            loadRotationStats();
        }
        
        async function loadRotationStats() {
            try {
                // Cargar estad√≠sticas de empleados
                const employeesResponse = await fetch('/api/empleados', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const employeesData = await employeesResponse.json();
                
                if (employeesData.success) {
                    const activeEmployees = employeesData.data.filter(emp => emp.activo && emp.email !== 'admin@sistema.com');
                    document.getElementById('activeEmployeesCount').textContent = activeEmployees.length;
                }
                
                // Cargar estad√≠sticas de horarios
                const schedulesResponse = await fetch('/api/horarios', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const schedulesData = await schedulesResponse.json();
                
                if (schedulesData.success) {
                    const baseSchedules = schedulesData.data.filter(s => 
                        ['Turno Ma√±ana', 'Turno Tarde', 'Turno Noche', 'Fin de Semana Ma√±ana', 'Fin de Semana Tarde'].includes(s.nombre)
                    );
                    document.getElementById('availableSchedulesCount').textContent = baseSchedules.length;
                }
                
                // Calcular semana actual
                const now = new Date();
                const start = new Date(now.getFullYear(), 0, 1);
                const diff = now - start;
                const oneWeek = 1000 * 60 * 60 * 24 * 7;
                const currentWeek = Math.floor(diff / oneWeek);
                document.getElementById('currentWeek').textContent = currentWeek;
                
            } catch (error) {
                console.error('Error cargando estad√≠sticas de rotaci√≥n:', error);
                showError('Error al cargar estad√≠sticas del sistema');
            }
        }
        
        async function executeSmartRotation() {
            try {
                showLoading('Ejecutando rotaci√≥n inteligente...');
                
                const response = await fetch('/api/rotacion/ejecutar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Rotaci√≥n ejecutada exitosamente. Los horarios han sido redistribuidos equitativamente.');
                    closeModal('rotationConfigModal');
                    
                    // Recargar datos
                    await loadEmployees();
                    if (typeof generateOfficialCalendar === 'function') {
                        await generateOfficialCalendar();
                    }
                } else {
                    showError(data.message || 'Error al ejecutar la rotaci√≥n');
                }
                
            } catch (error) {
                console.error('Error ejecutando rotaci√≥n:', error);
                showError('Error al ejecutar la rotaci√≥n');
            } finally {
                hideLoading();
            }
        }
        
        async function showRotationPreview() {
            try {
                showLoading('Generando vista previa...');
                
                const response = await fetch('/api/rotacion/preview', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Mostrar vista previa en un modal o alerta
                    let previewText = 'Vista Previa de Rotaci√≥n:\n\n';
                    data.preview.forEach(item => {
                        previewText += `${item.horario}: ${item.empleados.length} empleados\n`;
                        item.empleados.forEach(emp => {
                            previewText += `  - ${emp.nombre} ${emp.apellido}\n`;
                        });
                        previewText += '\n';
                    });
                    
                    alert(previewText);
                } else {
                    showError(data.message || 'Error al generar vista previa');
                }
                
            } catch (error) {
                console.error('Error generando vista previa:', error);
                showError('Error al generar vista previa');
            } finally {
                hideLoading();
            }
        }
        
        async function resetAllSchedules() {
            if (!confirm('¬øEst√°s seguro de que quieres resetear todos los horarios? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            try {
                showLoading('Reseteando horarios...');
                
                const response = await fetch('/api/rotacion/reset', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Horarios reseteados exitosamente. Todos los empleados han sido desasignados de sus horarios.');
                    closeModal('rotationConfigModal');
                    
                    // Recargar datos
                    await loadEmployees();
                    if (typeof generateOfficialCalendar === 'function') {
                        await generateOfficialCalendar();
                    }
                } else {
                    showError(data.message || 'Error al resetear horarios');
                }
                
            } catch (error) {
                console.error('Error reseteando horarios:', error);
                showError('Error al resetear horarios');
            } finally {
                hideLoading();
            }
        }

        function resetScheduleForm() {
            const days = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
            
            days.forEach(day => {
                // Resetear campos de tiempo
                document.getElementById(`${day}_entrada`).value = '';
                document.getElementById(`${day}_salida`).value = '';
                document.getElementById(`${day}_horas`).textContent = '0h';
                document.getElementById(`${day}_horas`).style.color = '#667eea';
                
                // Resetear checkboxes (lunes a viernes activos por defecto)
                const checkbox = document.getElementById(`${day}_activo`);
                if (['lunes', 'martes', 'miercoles', 'jueves', 'viernes'].includes(day)) {
                    checkbox.checked = true;
                    toggleDay(day);
                } else {
                    checkbox.checked = false;
                    toggleDay(day);
                }
                
                // Resetear estilos de borde
                document.getElementById(`${day}_entrada`).style.borderColor = '#E5E7EB';
                document.getElementById(`${day}_salida`).style.borderColor = '#E5E7EB';
            });
            
            // Resetear total
            document.getElementById('total_horas_semanales').textContent = '0';
            document.getElementById('hours_limit_status').textContent = '‚úÖ Dentro del l√≠mite legal (m√°x. 44h)';
            document.getElementById('hours_limit_status').className = 'hours-limit valid';
        }

        function showAddRoleModal() {
            // Resetear el formulario y t√≠tulo
            const form = document.getElementById('addRoleForm');
            form.reset();
            form.dataset.editingId = ''; // Limpiar el ID de edici√≥n
            document.querySelector('#addRoleModal .modal-title').textContent = 'Agregar Nuevo Rol';
            
            // Resetear el bot√≥n de submit
            const submitBtn = document.querySelector('#addRoleForm button[type="submit"]');
            submitBtn.textContent = 'Agregar Rol';
            
            document.getElementById('addRoleModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showAddScheduleModal() {
            // Resetear el formulario y t√≠tulo
            const form = document.getElementById('addScheduleConfigForm');
            form.reset();
            form.dataset.editingId = ''; // Limpiar el ID de edici√≥n
            document.querySelector('#addScheduleConfigModal .modal-title').textContent = 'Configurar Horario de Empleado';
            
            // Cargar empleados en el select
            loadEmployeesForSchedule();
            
            document.getElementById('addScheduleConfigModal').style.display = 'block';
        }

        async function loadEmployeesForSchedule() {
            try {
                const data = await getCachedData('employees', '/api/empleados');
                if (data) {
                    const employeeSelect = document.getElementById('scheduleEmployee');
                    employeeSelect.innerHTML = '<option value="">Seleccionar empleado</option>';
                    
                    data.data.forEach(employee => {
                        const option = document.createElement('option');
                        option.value = employee.id;
                        option.textContent = `${employee.nombre} ${employee.apellido}`;
                        employeeSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error al cargar empleados:', error);
            }
        }

        function updateScheduleOptions() {
            const role = document.getElementById('scheduleRole').value;
            const shiftSelect = document.getElementById('scheduleShift');
            
            // Limpiar opciones de turno
            shiftSelect.innerHTML = '<option value="">Seleccionar turno</option>';
            
            // Opciones para todos los roles (sistema de rotaci√≥n inteligente)
                shiftSelect.innerHTML += `
                <option value="TURNO_MANANA">Turno Ma√±ana (08:00-16:00)</option>
                <option value="TURNO_TARDE">Turno Tarde (16:00-00:00)</option>
                <option value="TURNO_NOCHE">Turno Noche (00:00-08:00)</option>
                <option value="FIN_SEMANA_MANANA">Fin de Semana Ma√±ana (09:00-17:00)</option>
                <option value="FIN_SEMANA_TARDE">Fin de Semana Tarde (17:00-01:00)</option>
            `;
        }

        // Funciones para el manejo de horarios personalizados
        function calculateHours(day) {
            const entrada = document.getElementById(`${day}_entrada`).value;
            const salida = document.getElementById(`${day}_salida`).value;
            const horasDisplay = document.getElementById(`${day}_horas`);
            
            if (entrada && salida) {
                const entradaTime = new Date(`2000-01-01T${entrada}`);
                const salidaTime = new Date(`2000-01-01T${salida}`);
                
                // Manejar horarios que cruzan medianoche
                if (salidaTime <= entradaTime) {
                    salidaTime.setDate(salidaTime.getDate() + 1);
                }
                
                const diffMs = salidaTime - entradaTime;
                const diffHours = diffMs / (1000 * 60 * 60);
                
                // Restar 30 minutos de colaci√≥n por ley chilena (solo si la jornada es mayor a 5.5 horas)
                let horasTrabajadas = diffHours;
                if (diffHours > 5.5) {
                    horasTrabajadas = diffHours - 0.5; // Restar 30 minutos de colaci√≥n
                }
                
                // Validar m√°ximo 10 horas por d√≠a (ley chilena) - considerando colaci√≥n
                if (diffHours > 10.5) { // 10 horas + 30 min colaci√≥n
                    horasDisplay.textContent = '10h (m√°x)';
                    horasDisplay.style.color = '#DC2626';
                    document.getElementById(`${day}_salida`).style.borderColor = '#DC2626';
                    showError(`‚ö†Ô∏è El d√≠a ${day.charAt(0).toUpperCase() + day.slice(1)} excede las 10 horas m√°ximas permitidas por ley (incluyendo colaci√≥n)`);
                } else {
                    // Mostrar horas trabajadas (descontando colaci√≥n)
                    horasDisplay.textContent = `${horasTrabajadas.toFixed(1)}h`;
                    horasDisplay.style.color = '#667eea';
                    document.getElementById(`${day}_salida`).style.borderColor = '#E5E7EB';
                    
                    // Mostrar tooltip con informaci√≥n de colaci√≥n
                    if (diffHours > 5.5) {
                        horasDisplay.title = `Jornada: ${diffHours.toFixed(1)}h - Colaci√≥n: 0.5h = ${horasTrabajadas.toFixed(1)}h trabajadas`;
                    } else {
                        horasDisplay.title = `Jornada: ${diffHours.toFixed(1)}h (sin colaci√≥n)`;
                    }
                }
                
                updateTotalHours();
            } else {
                horasDisplay.textContent = '0h';
                horasDisplay.style.color = '#667eea';
                horasDisplay.title = '';
                updateTotalHours();
            }
        }
        
        function toggleDay(day) {
            const checkbox = document.getElementById(`${day}_activo`);
            const dayElement = document.querySelector(`#${day}_entrada`).closest('.schedule-day');
            const entrada = document.getElementById(`${day}_entrada`);
            const salida = document.getElementById(`${day}_salida`);
            
            if (checkbox.checked) {
                dayElement.classList.remove('disabled');
                entrada.disabled = false;
                salida.disabled = false;
            } else {
                dayElement.classList.add('disabled');
                entrada.disabled = true;
                salida.disabled = true;
                entrada.value = '';
                salida.value = '';
                document.getElementById(`${day}_horas`).textContent = '0h';
                updateTotalHours();
            }
        }
        
        function updateTotalHours() {
            const days = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
            let totalHours = 0;
            let totalColacion = 0;
            let activeDays = 0;
            
            days.forEach(day => {
                const checkbox = document.getElementById(`${day}_activo`);
                if (checkbox.checked) {
                    activeDays++;
                    const horasText = document.getElementById(`${day}_horas`).textContent;
                    const horas = parseFloat(horasText.replace('h', '').replace(' (m√°x)', ''));
                    if (!isNaN(horas)) {
                        totalHours += horas;
                        
                        // Calcular colaci√≥n para este d√≠a
                        const entrada = document.getElementById(`${day}_entrada`).value;
                        const salida = document.getElementById(`${day}_salida`).value;
                        if (entrada && salida) {
                            const entradaTime = new Date(`2000-01-01T${entrada}`);
                            const salidaTime = new Date(`2000-01-01T${salida}`);
                            
                            if (salidaTime <= entradaTime) {
                                salidaTime.setDate(salidaTime.getDate() + 1);
                            }
                            
                            const diffMs = salidaTime - entradaTime;
                            const diffHours = diffMs / (1000 * 60 * 60);
                            
                            // Si la jornada es mayor a 5.5 horas, se descuenta colaci√≥n
                            if (diffHours > 5.5) {
                                totalColacion += 0.5;
                            }
                        }
                    }
                }
            });
            
            // Mostrar total de horas trabajadas (ya descontando colaci√≥n)
            document.getElementById('total_horas_semanales').textContent = totalHours.toFixed(1);
            
            // Validar l√≠mites legales chilenos
            const statusElement = document.getElementById('hours_limit_status');
            
            if (totalHours > 44) {
                statusElement.textContent = '‚ùå Excede l√≠mite legal (m√°x. 44h)';
                statusElement.className = 'hours-limit invalid';
            } else if (totalHours > 40) {
                statusElement.textContent = '‚ö†Ô∏è Cerca del l√≠mite legal (m√°x. 44h)';
                statusElement.className = 'hours-limit warning';
            } else {
                statusElement.textContent = '‚úÖ Dentro del l√≠mite legal (m√°x. 44h)';
                statusElement.className = 'hours-limit valid';
            }
            
            // Agregar informaci√≥n de colaci√≥n al status
            if (totalColacion > 0) {
                statusElement.textContent += ` | üçΩÔ∏è Colaci√≥n: ${totalColacion}h`;
            }
            
            // Validar m√≠nimo 4 d√≠as, m√°ximo 6 d√≠as
            if (activeDays < 4) {
                statusElement.textContent += ' | ‚ö†Ô∏è M√≠n. 4 d√≠as requeridos';
                statusElement.className = 'hours-limit warning';
            } else if (activeDays > 6) {
                statusElement.textContent += ' | ‚ùå M√°x. 6 d√≠as permitidos';
                statusElement.className = 'hours-limit invalid';
            }
        }
        
        function getScheduleData() {
            const days = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
            const scheduleData = [];
            
            days.forEach(day => {
                const checkbox = document.getElementById(`${day}_activo`);
                if (checkbox.checked) {
                    const entrada = document.getElementById(`${day}_entrada`).value;
                    const salida = document.getElementById(`${day}_salida`).value;
                    
                    if (entrada && salida) {
                        // Calcular si tiene colaci√≥n
                        const entradaTime = new Date(`2000-01-01T${entrada}`);
                        const salidaTime = new Date(`2000-01-01T${salida}`);
                        
                        if (salidaTime <= entradaTime) {
                            salidaTime.setDate(salidaTime.getDate() + 1);
                        }
                        
                        const diffMs = salidaTime - entradaTime;
                        const diffHours = diffMs / (1000 * 60 * 60);
                        const tieneColacion = diffHours > 5.5;
                        
                        scheduleData.push({
                            day: day,
                            entrada: entrada,
                            salida: salida,
                            activo: true,
                            tiene_colacion: tieneColacion,
                            horas_jornada: diffHours,
                            horas_trabajadas: tieneColacion ? diffHours - 0.5 : diffHours
                        });
                    }
                }
            });
            
            return scheduleData;
        }
        
        function validateSchedule() {
            const totalHours = parseFloat(document.getElementById('total_horas_semanales').textContent);
            const days = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
            let activeDays = 0;
            
            days.forEach(day => {
                const checkbox = document.getElementById(`${day}_activo`);
                if (checkbox.checked) {
                    activeDays++;
                }
            });
            
            // Validaciones seg√∫n ley chilena
            if (totalHours > 44) {
                showError('‚ùå El horario excede las 44 horas semanales m√°ximas permitidas por la ley chilena');
                return false;
            }
            
            if (activeDays < 4) {
                showError('‚ùå Se requiere un m√≠nimo de 4 d√≠as de trabajo por semana seg√∫n la ley chilena');
                return false;
            }
            
            if (activeDays > 6) {
                showError('‚ùå Se permite un m√°ximo de 6 d√≠as de trabajo por semana seg√∫n la ley chilena');
                return false;
            }
            
            return true;
        }

        async function addEmployee() {
            const form = document.getElementById('addEmployeeForm');
            const editingId = form.dataset.editingId;
            
            if (editingId) {
                // Estamos en modo edici√≥n
                await updateEmployee(editingId);
                return;
            }
            
            // Validar horario antes de continuar
            if (!validateSchedule()) {
                return;
            }
            
            console.log('Agregando empleado...');
            const formData = {
                nombre: document.getElementById('employeeName').value,
                apellido: document.getElementById('employeeLastName').value,
                email: document.getElementById('employeeEmail').value,
                telefono: document.getElementById('employeePhone').value,
                rol_id: document.getElementById('employeeRole').value,
                password: document.getElementById('employeePassword').value,
                horario_personalizado: getScheduleData()
            };
            console.log('Datos del formulario:', formData);

            try {
                const response = await fetch('/api/empleados', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Respuesta del servidor:', response.status);
                const data = await response.json();
                console.log('Datos de respuesta:', data);

                if (data.success) {
                    showSuccess('Empleado agregado exitosamente. Calendario de horarios regenerado.');
                    closeModal('addEmployeeModal');
                    document.getElementById('addEmployeeForm').reset();
                    
                    // Limpiar cach√© de empleados
                    clearCache('employees');
                    await loadEmployees();
                    
                    // Regenerar calendario de horarios
                    if (typeof generateOfficialCalendar === 'function') {
                        await generateOfficialCalendar();
                    }
                } else {
                    showError(data.message || 'Error al agregar empleado');
                }
            } catch (error) {
                console.error('Error al agregar empleado:', error);
                showError('Error al agregar empleado: ' + error.message);
            }
        }

        async function addRole() {
            const form = document.getElementById('addRoleForm');
            const editingId = form.dataset.editingId;
            
            if (editingId) {
                // Estamos en modo edici√≥n
                await updateRole(editingId);
                return;
            }
            
            const formData = {
                nombre: document.getElementById('roleName').value,
                descripcion: document.getElementById('roleDescription').value,
                permisos: document.getElementById('rolePermissions').value
            };

            try {
                const response = await fetch('/api/roles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Rol agregado exitosamente');
                    closeModal('addRoleModal');
                    document.getElementById('addRoleForm').reset();
                    
                    // Limpiar cach√© de roles
                    clearCache('roles');
                    loadRoles();
                    loadRolesTable();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Error al agregar rol');
            }
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        function showLoading(message = 'Cargando...') {
            const alert = document.getElementById('loadingAlert');
            const messageElement = document.getElementById('loadingMessage');
            messageElement.textContent = message;
            alert.style.display = 'flex';
        }

        function hideLoading() {
            const alert = document.getElementById('loadingAlert');
            alert.style.display = 'none';
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES');
        }

        function logout() {
            console.log('Cerrando sesi√≥n...');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            console.log('Redirigiendo a login...');
            window.location.href = '/';
        }

        // Funciones para horarios
        async function loadSchedules() {
            try {
                console.log('Cargando horarios...');
                const response = await fetch('/api/horarios', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                console.log('Respuesta de horarios:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Datos de horarios:', data);
                    schedules = data.data;
                } else {
                    console.error('Error en respuesta de horarios:', response.status);
                    showError('Error al cargar horarios');
                }
            } catch (error) {
                console.error('Error al cargar horarios:', error);
                showError('Error al cargar horarios: ' + error.message);
            }
        }

        function loadSchedulesTable() {
            console.log('Cargando tabla de horarios...');
            const tbody = document.getElementById('schedulesTable');
            if (!tbody) {
                console.log('Tabla de horarios no encontrada - usando calendario en su lugar');
                return;
            }
            tbody.innerHTML = '';

            console.log('Horarios a mostrar:', schedules.length);
            schedules.forEach(schedule => {
                const row = document.createElement('tr');
                const diasNombres = schedule.dias_semana.split(',').map(d => {
                    const dias = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                    return dias[parseInt(d)];
                }).join(', ');

                row.innerHTML = `
                    <td>${schedule.nombre}</td>
                    <td>${schedule.hora_entrada}</td>
                    <td>${schedule.hora_salida}</td>
                    <td>${diasNombres}</td>
                    <td><span class="status-badge ${schedule.activo ? 'badge-active' : 'badge-inactive'}">${schedule.activo ? 'Activo' : 'Inactivo'}</span></td>
                    <td>
                        <button class="btn btn-warning" onclick="editSchedule(${schedule.id})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteSchedule(${schedule.id})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-success" onclick="showAssignScheduleModal(${schedule.id})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-user-plus"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }


        async function addSchedule() {
            const form = document.getElementById('addScheduleForm');
            const editingId = form.dataset.editingId;
            
            if (editingId) {
                // Estamos en modo edici√≥n
                await updateSchedule(editingId);
                return;
            }
            
            const selectedDays = Array.from(document.querySelectorAll('.scheduleDays:checked')).map(cb => cb.value);
            
            if (selectedDays.length === 0) {
                showError('Selecciona al menos un d√≠a de la semana');
                return;
            }

            const formData = {
                nombre: document.getElementById('scheduleName').value,
                hora_entrada: document.getElementById('scheduleStartTime').value,
                hora_salida: document.getElementById('scheduleEndTime').value,
                dias_semana: selectedDays.join(','),
                descripcion: document.getElementById('scheduleDescription').value
            };

            try {
                const response = await fetch('/api/horarios', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Horario agregado exitosamente');
                    closeModal('addScheduleModal');
                    document.getElementById('addScheduleForm').reset();
                    await loadSchedules();
                    // Regenerar calendario en lugar de tabla
                    if (typeof generateCalendar === 'function') {
                        generateCalendar();
                    }
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Error al agregar horario');
            }
        }

        // Funciones para asistencia
        async function loadAttendanceData() {
            const fechaInicio = document.getElementById('attendanceDateFrom').value;
            const fechaFin = document.getElementById('attendanceDateTo').value;
            const empleadoId = document.getElementById('attendanceEmployeeFilter').value;

            let url = '/api/asistencia?';
            if (fechaInicio) url += `fecha_inicio=${fechaInicio}&`;
            if (fechaFin) url += `fecha_fin=${fechaFin}&`;
            if (empleadoId) url += `empleado_id=${empleadoId}&`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateAttendanceTable(data.data);
                }
            } catch (error) {
                showError('Error al cargar datos de asistencia');
            }
        }

        function updateAttendanceTable(attendance) {
            const tbody = document.getElementById('attendanceTable');
            tbody.innerHTML = '';

            attendance.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.nombre} ${record.apellido}</td>
                    <td>${formatDate(record.fecha)}</td>
                    <td>${record.hora_entrada || '-'}</td>
                    <td>${record.hora_salida || '-'}</td>
                    <td>${record.horas_trabajadas ? `${record.horas_trabajadas}h` : '-'}</td>
                    <td><span class="status-badge ${record.estado === 'presente' ? 'badge-present' : 'badge-absent'}">${record.estado}</span></td>
                    <td>
                        <button class="btn btn-warning" onclick="markAbsence(${record.empleado_id}, '${record.fecha}')" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Funciones para vacaciones
        async function loadVacationsData() {
            const estado = document.getElementById('vacationStatusFilter').value;

            let url = '/api/vacaciones?';
            if (estado) url += `estado=${estado}&`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateVacationsTable(data.data);
                }
            } catch (error) {
                showError('Error al cargar datos de vacaciones');
            }
        }

        function updateVacationsTable(vacations) {
            const tbody = document.getElementById('vacationsTable');
            tbody.innerHTML = '';

            vacations.forEach(vacation => {
                const row = document.createElement('tr');
                const statusClass = vacation.estado === 'aprobado' ? 'badge-approved' : 
                                  vacation.estado === 'rechazado' ? 'badge-rejected' : 'badge-pending';

                row.innerHTML = `
                    <td>${vacation.nombre} ${vacation.apellido}</td>
                    <td>${formatDate(vacation.fecha_inicio)}</td>
                    <td>${formatDate(vacation.fecha_fin)}</td>
                    <td>${vacation.dias_solicitados}</td>
                    <td><span class="status-badge ${statusClass}">${vacation.estado}</span></td>
                    <td>${vacation.motivo || '-'}</td>
                    <td>
                        ${vacation.estado === 'pendiente' ? `
                            <button class="btn btn-success" onclick="approveVacation(${vacation.id})" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-danger" onclick="rejectVacation(${vacation.id})" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function approveVacation(vacationId) {
            if (confirm('¬øAprobar esta solicitud de vacaciones?')) {
                try {
                    const response = await fetch(`/api/vacaciones/${vacationId}/estado`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ estado: 'aprobado' })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showSuccess('Vacaciones aprobadas exitosamente');
                        loadVacationsData();
                    } else {
                        showError(data.message);
                    }
                } catch (error) {
                    showError('Error al aprobar vacaciones');
                }
            }
        }

        async function rejectVacation(vacationId) {
            const motivo = prompt('Motivo del rechazo:');
            if (motivo) {
                try {
                    const response = await fetch(`/api/vacaciones/${vacationId}/estado`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ estado: 'rechazado', observaciones: motivo })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showSuccess('Vacaciones rechazadas');
                        loadVacationsData();
                    } else {
                        showError(data.message);
                    }
                } catch (error) {
                    showError('Error al rechazar vacaciones');
                }
            }
        }

        // Funciones para reportes
        async function generateAttendanceReport() {
            const fechaInicio = document.getElementById('reportAttendanceFrom').value;
            const fechaFin = document.getElementById('reportAttendanceTo').value;
            const empleadoId = document.getElementById('reportAttendanceEmployee').value;

            if (!fechaInicio || !fechaFin) {
                showError('Selecciona fechas de inicio y fin');
                return;
            }

            let url = `/api/reportes/asistencia?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
            if (empleadoId) url += `&empleado_id=${empleadoId}`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    downloadReport(data.data, 'reporte-asistencia');
                    showSuccess('Reporte generado exitosamente');
                }
            } catch (error) {
                showError('Error al generar reporte');
            }
        }

        async function generateHoursReport() {
            const fechaInicio = document.getElementById('reportHoursFrom').value;
            const fechaFin = document.getElementById('reportHoursTo').value;

            if (!fechaInicio || !fechaFin) {
                showError('Selecciona fechas de inicio y fin');
                return;
            }

            try {
                const response = await fetch(`/api/reportes/horas-trabajadas?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    downloadReport(data.data, 'reporte-horas');
                    showSuccess('Reporte generado exitosamente');
                }
            } catch (error) {
                showError('Error al generar reporte');
            }
        }

        async function generateVacationReport() {
            const a√±o = document.getElementById('reportVacationYear').value;

            try {
                const response = await fetch(`/api/vacaciones/estadisticas?a√±o=${a√±o}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    downloadReport(data.data, 'reporte-vacaciones');
                    showSuccess('Reporte generado exitosamente');
                }
            } catch (error) {
                showError('Error al generar reporte');
            }
        }

        function downloadReport(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Funciones auxiliares
        function initializeDateInputs() {
            const today = new Date().toISOString().split('T')[0];
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const lastMonthStr = lastMonth.toISOString().split('T')[0];

            // Establecer fechas por defecto (solo si los elementos existen)
            const attendanceDateFrom = document.getElementById('attendanceDateFrom');
            const attendanceDateTo = document.getElementById('attendanceDateTo');
            const reportAttendanceFrom = document.getElementById('reportAttendanceFrom');
            const reportAttendanceTo = document.getElementById('reportAttendanceTo');
            const reportHoursFrom = document.getElementById('reportHoursFrom');
            const reportHoursTo = document.getElementById('reportHoursTo');
            
            if (attendanceDateFrom) attendanceDateFrom.value = lastMonthStr;
            if (attendanceDateTo) attendanceDateTo.value = today;
            if (reportAttendanceFrom) reportAttendanceFrom.value = lastMonthStr;
            if (reportAttendanceTo) reportAttendanceTo.value = today;
            if (reportHoursFrom) reportHoursFrom.value = lastMonthStr;
            if (reportHoursTo) reportHoursTo.value = today;
        }

        function populateEmployeeSelects() {
            console.log('Poblando selects de empleados...');
            const selects = ['attendanceEmployeeFilter', 'reportAttendanceEmployee', 'assignEmployee'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = selectId === 'assignEmployee' ? 
                        '<option value="">Seleccionar empleado...</option>' : 
                        '<option value="">Todos los empleados</option>';
                    
                    console.log(`Poblando select ${selectId} con ${employees.length} empleados`);
                    employees.forEach(employee => {
                        const option = document.createElement('option');
                        option.value = employee.id;
                        option.textContent = `${employee.nombre} ${employee.apellido}`;
                        select.appendChild(option);
                    });
                } else {
                    console.log(`Elemento ${selectId} no encontrado - omitiendo`);
                }
            });
        }

        function populateScheduleSelect() {
            console.log('Poblando select de horarios...');
            const select = document.getElementById('assignSchedule');
            if (select) {
                select.innerHTML = '<option value="">Seleccionar horario...</option>';
                console.log('Horarios disponibles:', schedules.length);
                schedules.forEach(schedule => {
                    const option = document.createElement('option');
                    option.value = schedule.id;
                    option.textContent = schedule.nombre;
                    select.appendChild(option);
                });
            } else {
                console.warn('No se encontr√≥ el elemento assignSchedule');
            }
        }

        // Funciones adicionales que faltan
        function showAssignScheduleModal(scheduleId = null) {
            console.log('Mostrando modal de asignar horario...');
            populateEmployeeSelects();
            populateScheduleSelect();
            if (scheduleId) {
                document.getElementById('assignSchedule').value = scheduleId;
            }
            document.getElementById('assignScheduleModal').style.display = 'block';
        }

        async function assignSchedule() {
            console.log('Asignando horario...');
            const formData = {
                empleado_id: document.getElementById('assignEmployee').value,
                horario_id: document.getElementById('assignSchedule').value,
                fecha_inicio: document.getElementById('assignStartDate').value,
                fecha_fin: document.getElementById('assignEndDate').value || null
            };
            console.log('Datos del formulario de asignaci√≥n:', formData);

            try {
                const response = await fetch(`/api/horarios/${formData.horario_id}/asignar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Respuesta de asignaci√≥n:', response.status);
                const data = await response.json();
                console.log('Datos de respuesta de asignaci√≥n:', data);

                if (data.success) {
                    showSuccess('Horario asignado exitosamente');
                    closeModal('assignScheduleModal');
                    document.getElementById('assignScheduleForm').reset();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('Error al asignar horario:', error);
                showError('Error al asignar horario: ' + error.message);
            }
        }

        async function markAbsence(empleadoId, fecha) {
            console.log('Marcando ausencia...');
            const motivo = prompt('Motivo de la ausencia:');
            if (motivo) {
                try {
                    const response = await fetch('/api/asistencia/ausencia', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            empleado_id: empleadoId,
                            fecha: fecha,
                            motivo: motivo
                        })
                    });

                    console.log('Respuesta de ausencia:', response.status);
                    const data = await response.json();
                    console.log('Datos de respuesta de ausencia:', data);

                    if (data.success) {
                        showSuccess('Ausencia marcada exitosamente');
                        loadAttendanceData();
                    } else {
                        showError(data.message);
                    }
                } catch (error) {
                    console.error('Error al marcar ausencia:', error);
                    showError('Error al marcar ausencia: ' + error.message);
                }
            }
        }

        async function editEmployee(id) {
            console.log('Editando empleado:', id);
            const employee = employees.find(emp => emp.id === id);
            if (!employee) {
                console.error('Empleado no encontrado:', id);
                showError('Empleado no encontrado');
                return;
            }
            console.log('Empleado encontrado:', employee);

            // Llenar el formulario con los datos del empleado
            document.getElementById('employeeName').value = employee.nombre;
            document.getElementById('employeeLastName').value = employee.apellido;
            document.getElementById('employeeEmail').value = employee.email;
            document.getElementById('employeePhone').value = employee.telefono || '';
            document.getElementById('employeeRole').value = employee.rol_id || '';
            
            // Cambiar el t√≠tulo del modal
            document.querySelector('#addEmployeeModal .modal-title').textContent = 'Editar Empleado';
            
            // Cambiar el bot√≥n de submit
            const submitBtn = document.querySelector('#addEmployeeForm button[type="submit"]');
            submitBtn.textContent = 'Actualizar Empleado';
            
            // Marcar que estamos en modo edici√≥n
            document.getElementById('addEmployeeForm').dataset.editingId = id;
            
            // Mostrar el modal
            document.getElementById('addEmployeeModal').style.display = 'block';
        }

        async function updateEmployee(id) {
            console.log('Actualizando empleado:', id);
            const formData = {
                nombre: document.getElementById('employeeName').value,
                apellido: document.getElementById('employeeLastName').value,
                email: document.getElementById('employeeEmail').value,
                telefono: document.getElementById('employeePhone').value,
                rol_id: document.getElementById('employeeRole').value
            };
            console.log('Datos del formulario de actualizaci√≥n:', formData);

            try {
                const response = await fetch(`/api/empleados/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Respuesta de actualizaci√≥n:', response.status);
                const data = await response.json();
                console.log('Datos de respuesta de actualizaci√≥n:', data);

                if (data.success) {
                    showSuccess('Empleado actualizado exitosamente. Calendario de horarios regenerado.');
                    closeModal('addEmployeeModal');
                    document.getElementById('addEmployeeForm').reset();
                    await loadEmployees();
                    // Regenerar calendario de horarios
                    if (typeof generateOfficialCalendar === 'function') {
                        await generateOfficialCalendar();
                    }
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('Error al actualizar empleado:', error);
                showError('Error al actualizar empleado: ' + error.message);
            }
        }

        async function deleteEmployee(id) {
            console.log('Eliminando empleado:', id);
            if (confirm('¬øEst√°s seguro de que quieres eliminar este empleado?')) {
                try {
                    const response = await fetch(`/api/empleados/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    console.log('Respuesta de eliminaci√≥n:', response.status);
                    const data = await response.json();
                    console.log('Datos de respuesta de eliminaci√≥n:', data);

                    if (data.success) {
                        showSuccess('Empleado eliminado exitosamente. Calendario de horarios regenerado.');
                        await loadEmployees();
                        // Regenerar calendario de horarios
                        if (typeof generateOfficialCalendar === 'function') {
                            await generateOfficialCalendar();
                        }
                    } else {
                        showError(data.message);
                    }
                } catch (error) {
                    console.error('Error al eliminar empleado:', error);
                    showError('Error al eliminar empleado: ' + error.message);
                }
            }
        }

        async function editRole(id) {
            console.log('Editando rol:', id);
            const role = roles.find(r => r.id === id);
            if (!role) {
                console.error('Rol no encontrado:', id);
                showError('Rol no encontrado');
                return;
            }
            console.log('Rol encontrado:', role);

            // Llenar el formulario con los datos del rol
            document.getElementById('roleName').value = role.nombre;
            document.getElementById('roleDescription').value = role.descripcion || '';
            document.getElementById('rolePermissions').value = role.permisos || '';
            
            // Cambiar el t√≠tulo del modal
            document.querySelector('#addRoleModal .modal-title').textContent = 'Editar Rol';
            
            // Cambiar el bot√≥n de submit
            const submitBtn = document.querySelector('#addRoleForm button[type="submit"]');
            submitBtn.textContent = 'Actualizar Rol';
            
            // Marcar que estamos en modo edici√≥n
            document.getElementById('addRoleForm').dataset.editingId = id;
            
            // Mostrar el modal
            document.getElementById('addRoleModal').style.display = 'block';
        }

        async function updateRole(id) {
            console.log('Actualizando rol:', id);
            const formData = {
                nombre: document.getElementById('roleName').value,
                descripcion: document.getElementById('roleDescription').value,
                permisos: document.getElementById('rolePermissions').value
            };
            console.log('Datos del formulario de actualizaci√≥n de rol:', formData);

            try {
                const response = await fetch(`/api/roles/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Respuesta de actualizaci√≥n de rol:', response.status);
                const data = await response.json();
                console.log('Datos de respuesta de actualizaci√≥n de rol:', data);

                if (data.success) {
                    showSuccess('Rol actualizado exitosamente');
                    closeModal('addRoleModal');
                    document.getElementById('addRoleForm').reset();
                    loadRoles();
                    loadRolesTable();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('Error al actualizar rol:', error);
                showError('Error al actualizar rol: ' + error.message);
            }
        }

        async function deleteRole(id) {
            console.log('Eliminando rol:', id);
            if (confirm('¬øEst√°s seguro de que quieres eliminar este rol?')) {
                try {
                    const response = await fetch(`/api/roles/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    console.log('Respuesta de eliminaci√≥n de rol:', response.status);
                    const data = await response.json();
                    console.log('Datos de respuesta de eliminaci√≥n de rol:', data);

                    if (data.success) {
                        showSuccess('Rol eliminado exitosamente');
                        loadRoles();
                        loadRolesTable();
                    } else {
                        showError(data.message);
                    }
                } catch (error) {
                    console.error('Error al eliminar rol:', error);
                    showError('Error al eliminar rol: ' + error.message);
                }
            }
        }

        async function editSchedule(id) {
            console.log('Editando horario:', id);
            const schedule = schedules.find(s => s.id === id);
            if (!schedule) {
                console.error('Horario no encontrado:', id);
                showError('Horario no encontrado');
                return;
            }
            console.log('Horario encontrado:', schedule);

            // Llenar el formulario con los datos del horario
            document.getElementById('scheduleName').value = schedule.nombre;
            document.getElementById('scheduleStartTime').value = schedule.hora_entrada;
            document.getElementById('scheduleEndTime').value = schedule.hora_salida;
            document.getElementById('scheduleDescription').value = schedule.descripcion || '';
            
            // Marcar los d√≠as de la semana
            const diasArray = schedule.dias_semana.split(',');
            document.querySelectorAll('.scheduleDays').forEach(checkbox => {
                checkbox.checked = diasArray.includes(checkbox.value);
            });
            
            // Cambiar el t√≠tulo del modal
            document.querySelector('#addScheduleModal .modal-title').textContent = 'Editar Horario';
            
            // Cambiar el bot√≥n de submit
            const submitBtn = document.querySelector('#addScheduleForm button[type="submit"]');
            submitBtn.textContent = 'Actualizar Horario';
            
            // Marcar que estamos en modo edici√≥n
            document.getElementById('addScheduleForm').dataset.editingId = id;
            
            // Mostrar el modal
            document.getElementById('addScheduleModal').style.display = 'block';
        }

        async function updateSchedule(id) {
            console.log('Actualizando horario:', id);
            const selectedDays = Array.from(document.querySelectorAll('.scheduleDays:checked')).map(cb => cb.value);
            
            if (selectedDays.length === 0) {
                showError('Selecciona al menos un d√≠a de la semana');
                return;
            }

            const formData = {
                nombre: document.getElementById('scheduleName').value,
                hora_entrada: document.getElementById('scheduleStartTime').value,
                hora_salida: document.getElementById('scheduleEndTime').value,
                dias_semana: selectedDays.join(','),
                descripcion: document.getElementById('scheduleDescription').value
            };
            console.log('Datos del formulario de actualizaci√≥n de horario:', formData);

            try {
                const response = await fetch(`/api/horarios/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Respuesta de actualizaci√≥n de horario:', response.status);
                const data = await response.json();
                console.log('Datos de respuesta de actualizaci√≥n de horario:', data);

                if (data.success) {
                    showSuccess('Horario actualizado exitosamente');
                    closeModal('addScheduleModal');
                    document.getElementById('addScheduleForm').reset();
                    await loadSchedules();
                    // Regenerar calendario en lugar de tabla
                    if (typeof generateCalendar === 'function') {
                        generateCalendar();
                    }
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('Error al actualizar horario:', error);
                showError('Error al actualizar horario: ' + error.message);
            }
        }

        async function deleteSchedule(id) {
            console.log('Eliminando horario:', id);
            if (confirm('¬øEst√°s seguro de que quieres eliminar este horario?')) {
                try {
                    const response = await fetch(`/api/horarios/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    console.log('Respuesta de eliminaci√≥n de horario:', response.status);
                    const data = await response.json();
                    console.log('Datos de respuesta de eliminaci√≥n de horario:', data);

                    if (data.success) {
                        showSuccess('Horario eliminado exitosamente');
                        await loadSchedules();
                        // Regenerar calendario en lugar de tabla
                        if (typeof generateCalendar === 'function') {
                            generateCalendar();
                        }
                    } else {
                        showError(data.message);
                    }
                } catch (error) {
                    console.error('Error al eliminar horario:', error);
                    showError('Error al eliminar horario: ' + error.message);
                }
            }
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Variables para el calendario
        let currentDate = new Date();
        let scheduleData = {};
        let rotationSchedule = {};


        // Funci√≥n para generar el calendario
        async function generateCalendar() {
            console.log('Generando calendario...');
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonth = document.getElementById('currentMonth');
            
            // Actualizar t√≠tulo del mes
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            currentMonth.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            
            // Limpiar calendario
            calendarGrid.innerHTML = '';
            
            // Obtener primer d√≠a del mes y √∫ltimo d√≠a
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // Obtener el d√≠a de la semana del primer d√≠a (0=Domingo, 1=Lunes, etc.)
            // Ajustar para que lunes sea 0
            let firstDayOfWeek = firstDay.getDay();
            firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
            
            // Agregar celdas vac√≠as al inicio para alinear el primer d√≠a
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyElement = document.createElement('div');
                emptyElement.className = 'calendar-day empty-day';
                emptyElement.style.background = 'transparent';
                emptyElement.style.border = 'none';
                calendarGrid.appendChild(emptyElement);
            }
            
            // Obtener horarios una sola vez para todo el mes
            console.log('Obteniendo horarios para el mes...');
            const monthlySchedules = await getCachedData('employeeSchedules', '/api/horarios/empleados-calendario');
            
            if (!monthlySchedules || !monthlySchedules.horarios || monthlySchedules.horarios.length === 0) {
                console.log('No hay horarios configurados, mostrando calendario vac√≠o');
                // Generar d√≠as vac√≠os
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    
                    // Marcar si es hoy
                    const today = new Date();
                    if (dayDate.toDateString() === today.toDateString()) {
                        dayElement.classList.add('today');
                    }
                    
                    // Verificar si es feriado
                    const holiday = isHoliday(dayDate);
                    if (holiday) {
                        dayElement.classList.add('holiday');
                        dayElement.title = holiday.name;
                    }
                    
                    // N√∫mero del d√≠a
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = dayDate.getDate();
                    dayElement.appendChild(dayNumber);
                    
                    // Hacer el d√≠a clickeable
                    dayElement.style.cursor = 'pointer';
                    dayElement.addEventListener('click', () => showDayEmployees(dayDate));
                    
                    calendarGrid.appendChild(dayElement);
                }
                return;
            }
            
            // Generar d√≠as del mes con horarios pre-cargados
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // Marcar si es hoy
                const today = new Date();
                if (dayDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Verificar si es feriado
                const holiday = isHoliday(dayDate);
                if (holiday) {
                    dayElement.classList.add('holiday');
                    dayElement.title = holiday.name;
                }
                
                // N√∫mero del d√≠a
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = dayDate.getDate();
                dayElement.appendChild(dayNumber);
                
                // Obtener asignaciones de turnos para este d√≠a usando los horarios pre-cargados
                const assignments = getShiftAssignmentsFromSchedules(dayDate, monthlySchedules.horarios);
                assignments.forEach(assignment => {
                    const shiftElement = document.createElement('div');
                    shiftElement.className = `shift-assignment ${assignment.class}`;
                    shiftElement.textContent = assignment.name;
                    dayElement.appendChild(shiftElement);
                });
                
                // Hacer el d√≠a clickeable
                dayElement.style.cursor = 'pointer';
                dayElement.addEventListener('click', () => showDayEmployees(dayDate));
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // Funci√≥n para obtener asignaciones desde horarios pre-cargados (sin llamadas a API)
        function getShiftAssignmentsFromSchedules(date, employeeSchedules) {
            const assignments = [];
            const dayOfWeek = date.getDay(); // 0 = Domingo, 1 = Lunes, etc.
            
            if (!employeeSchedules || employeeSchedules.length === 0) {
                return assignments;
            }
            
            // Filtrar empleados que trabajan en este d√≠a de la semana
            const workingEmployees = employeeSchedules.filter(schedule => {
                if (schedule.estado !== 'ACTIVO') return false;
                
                // Verificar si el empleado trabaja en este d√≠a de la semana
                const workDays = schedule.dias_trabajo ? schedule.dias_trabajo.split(',').map(d => parseInt(d)) : [];
                return workDays.includes(dayOfWeek);
            });
            
            // Si no hay empleados trabajando en este d√≠a, no mostrar nada
            if (workingEmployees.length === 0) {
                return assignments;
            }
            
            // Agrupar por turno para asegurar que solo haya 3 personas trabajando
            const turnoGroups = {
                'TURNO_MANANA': [],
                'TURNO_TARDE': [],
                'TURNO_NOCHE': [],
                'FIN_SEMANA_MANANA': [],
                'FIN_SEMANA_TARDE': []
            };
            
            workingEmployees.forEach(schedule => {
                if (turnoGroups[schedule.turno]) {
                    turnoGroups[schedule.turno].push(schedule);
                }
            });
            
            // Seleccionar empleados por turno (sistema de rotaci√≥n inteligente)
            const selectedEmployees = [];
            
            // Turno Ma√±ana (Lunes a Viernes)
            if (dayOfWeek >= 1 && dayOfWeek <= 5 && turnoGroups['TURNO_MANANA'].length > 0) {
                const employee = turnoGroups['TURNO_MANANA'][0];
                selectedEmployees.push({
                    name: `${employee.nombre} ${employee.apellido}`,
                    class: 'turno-manana'
                });
            }
            
            // Turno Tarde (Lunes a Viernes)
            if (dayOfWeek >= 1 && dayOfWeek <= 5 && turnoGroups['TURNO_TARDE'].length > 0) {
                const employee = turnoGroups['TURNO_TARDE'][0];
                selectedEmployees.push({
                    name: `${employee.nombre} ${employee.apellido}`,
                    class: 'turno-tarde'
                });
            }
            
            // Turno Noche (Lunes a Viernes)
            if (dayOfWeek >= 1 && dayOfWeek <= 5 && turnoGroups['TURNO_NOCHE'].length > 0) {
                const employee = turnoGroups['TURNO_NOCHE'][0];
                selectedEmployees.push({
                    name: `${employee.nombre} ${employee.apellido}`,
                    class: 'turno-noche'
                });
            }
            
            // Fin de Semana Ma√±ana (S√°bado y Domingo)
            if ((dayOfWeek === 6 || dayOfWeek === 0) && turnoGroups['FIN_SEMANA_MANANA'].length > 0) {
                const employee = turnoGroups['FIN_SEMANA_MANANA'][0];
                selectedEmployees.push({
                    name: `${employee.nombre} ${employee.apellido}`,
                    class: 'fin-semana-manana'
                });
            }
            
            // Fin de Semana Tarde (S√°bado y Domingo)
            if ((dayOfWeek === 6 || dayOfWeek === 0) && turnoGroups['FIN_SEMANA_TARDE'].length > 0) {
                const employee = turnoGroups['FIN_SEMANA_TARDE'][0];
                selectedEmployees.push({
                    name: `${employee.nombre} ${employee.apellido}`,
                    class: 'fin-semana-tarde'
                });
            }
            
            return selectedEmployees;
        }

        // Funci√≥n para obtener asignaciones de turnos para una fecha (con llamada a API)
        async function getShiftAssignments(date) {
            const assignments = [];
            const dayOfWeek = date.getDay(); // 0 = Domingo, 1 = Lunes, etc.
            
            try {
                // Obtener horarios configurados desde la API con cach√©
                const data = await getCachedData('employeeSchedules', '/api/horarios/empleados-calendario');
                if (data) {
                    const employeeSchedules = data.horarios || [];
                    
                    // Si no hay horarios configurados, no mostrar ning√∫n empleado
                    if (employeeSchedules.length === 0) {
                        console.log('No hay horarios configurados, calendario vac√≠o');
                        return [];
                    }
                    
                    // Filtrar empleados que trabajan en este d√≠a de la semana
                    const workingEmployees = employeeSchedules.filter(schedule => {
                        if (schedule.estado !== 'ACTIVO') return false;
                        
                        // Verificar si el empleado trabaja en este d√≠a de la semana
                        const workDays = schedule.dias_trabajo ? schedule.dias_trabajo.split(',').map(d => parseInt(d)) : [];
                        return workDays.includes(dayOfWeek);
                    });
                    
                    // Si no hay empleados trabajando en este d√≠a, no mostrar nada
                    if (workingEmployees.length === 0) {
                        console.log(`No hay empleados trabajando el d√≠a ${dayOfWeek}`);
                        return [];
                    }
                    
                    // Agrupar por turno para asegurar que solo haya 3 personas trabajando
                    const turnoGroups = {
                        'TURNO_MANANA': [],
                        'TURNO_TARDE': [],
                        'TURNO_NOCHE': [],
                        'FIN_SEMANA_MANANA': [],
                        'FIN_SEMANA_TARDE': []
                    };
                    
                    workingEmployees.forEach(schedule => {
                        if (turnoGroups[schedule.turno]) {
                            turnoGroups[schedule.turno].push(schedule);
                        }
                    });
                    
                    // Seleccionar empleados por turno (sistema de rotaci√≥n inteligente)
                    const selectedEmployees = [];
                    
                    // Turno Ma√±ana (Lunes a Viernes)
                    if (dayOfWeek >= 1 && dayOfWeek <= 5 && turnoGroups['TURNO_MANANA'].length > 0) {
                        const employee = turnoGroups['TURNO_MANANA'][0];
                        selectedEmployees.push({
                            name: `${employee.nombre} ${employee.apellido}`,
                            class: 'turno-manana'
                        });
                    }
                    
                    // Turno Tarde (Lunes a Viernes)
                    if (dayOfWeek >= 1 && dayOfWeek <= 5 && turnoGroups['TURNO_TARDE'].length > 0) {
                        const employee = turnoGroups['TURNO_TARDE'][0];
                        selectedEmployees.push({
                            name: `${employee.nombre} ${employee.apellido}`,
                            class: 'turno-tarde'
                        });
                    }
                    
                    // Turno Noche (Lunes a Viernes)
                    if (dayOfWeek >= 1 && dayOfWeek <= 5 && turnoGroups['TURNO_NOCHE'].length > 0) {
                        const employee = turnoGroups['TURNO_NOCHE'][0];
                        selectedEmployees.push({
                            name: `${employee.nombre} ${employee.apellido}`,
                            class: 'turno-noche'
                        });
                    }
                    
                    // Fin de Semana Ma√±ana (S√°bado y Domingo)
                    if ((dayOfWeek === 6 || dayOfWeek === 0) && turnoGroups['FIN_SEMANA_MANANA'].length > 0) {
                        const employee = turnoGroups['FIN_SEMANA_MANANA'][0];
                        selectedEmployees.push({
                            name: `${employee.nombre} ${employee.apellido}`,
                            class: 'fin-semana-manana'
                        });
                    }
                    
                    // Fin de Semana Tarde (S√°bado y Domingo)
                    if ((dayOfWeek === 6 || dayOfWeek === 0) && turnoGroups['FIN_SEMANA_TARDE'].length > 0) {
                        const employee = turnoGroups['FIN_SEMANA_TARDE'][0];
                        selectedEmployees.push({
                            name: `${employee.nombre} ${employee.apellido}`,
                            class: 'fin-semana-tarde'
                        });
                    }
                    
                    return selectedEmployees;
                }
            } catch (error) {
                console.error('Error al obtener horarios de empleados:', error);
            }
            
            // Si no hay horarios configurados, no mostrar ning√∫n empleado
            console.log('No se pudieron obtener horarios, calendario vac√≠o');
            return [];
        }




        // Funci√≥n para obtener el n√∫mero de semana del a√±o
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }



        // Funciones para manejo de fotos de perfil
        function loadProfileData() {
            if (!currentUser) return;
            
            // Cargar informaci√≥n del perfil
            document.getElementById('profileName').textContent = currentUser.nombre || 'N/A';
            document.getElementById('profileLastName').textContent = currentUser.apellido || 'N/A';
            document.getElementById('profileEmail').textContent = currentUser.email || 'N/A';
            document.getElementById('profilePhone').textContent = currentUser.telefono || 'N/A';
            document.getElementById('profileRole').textContent = currentUser.rol || 'Administrador';
            document.getElementById('profileHireDate').textContent = currentUser.fecha_contratacion || 'N/A';
            
            // Cargar foto de perfil
            loadProfilePhoto();
            
            // Configurar evento para subir foto
            document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
        }

        function loadProfilePhoto() {
            fetch('/api/upload/profile-photo', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const profilePhoto = document.getElementById('profilePhoto');
                const removeBtn = document.getElementById('removePhotoBtn');
                
                if (data.success && data.photoPath) {
                    profilePhoto.innerHTML = `<img src="${data.photoPath}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    removeBtn.style.display = 'block';
                } else {
                    profilePhoto.innerHTML = '<i class="fas fa-user" style="font-size: 60px; color: #94A3B8;"></i>';
                    removeBtn.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error al cargar foto de perfil:', error);
            });
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar tama√±o del archivo (5MB m√°ximo)
            if (file.size > 5 * 1024 * 1024) {
                showError('El archivo es demasiado grande. M√°ximo 5MB.');
                return;
            }
            
            // Validar tipo de archivo
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                showError('Tipo de archivo no v√°lido. Solo se permiten im√°genes (JPEG, JPG, PNG, GIF, WEBP).');
                return;
            }
            
            // Crear FormData
            const formData = new FormData();
            formData.append('profilePhoto', file);
            
            // Subir archivo
            fetch('/api/upload/profile-photo', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('Foto de perfil actualizada correctamente');
                    loadProfilePhoto(); // Recargar la foto
                } else {
                    showError(data.message || 'Error al subir la foto');
                }
            })
            .catch(error => {
                console.error('Error al subir foto:', error);
                showError('Error al subir la foto');
            });
            
            // Limpiar el input
            event.target.value = '';
        }

        function removeProfilePhoto() {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar tu foto de perfil?')) {
                return;
            }
            
            fetch('/api/upload/profile-photo', {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('Foto de perfil eliminada correctamente');
                    loadProfilePhoto(); // Recargar la foto
                } else {
                    showError(data.message || 'Error al eliminar la foto');
                }
            })
            .catch(error => {
                console.error('Error al eliminar foto:', error);
                showError('Error al eliminar la foto');
            });
        }

        // Funciones para manejo de liquidaciones
        function loadPayrollsData() {
            loadAllPayrolls();
            loadEmployeesForPayroll();
            populateYearFilter();
        }

        function loadAllPayrolls() {
            fetch('/api/liquidaciones/all', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayPayrolls(data.liquidaciones);
                } else {
                    showError('Error al cargar liquidaciones');
                }
            })
            .catch(error => {
                console.error('Error al cargar liquidaciones:', error);
                showError('Error al cargar liquidaciones');
            });
        }

        function displayPayrolls(payrolls) {
            const tbody = document.getElementById('payrollsTableBody');
            tbody.innerHTML = '';

            if (payrolls.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No hay liquidaciones registradas</td></tr>';
                return;
            }

            payrolls.forEach(payroll => {
                const row = document.createElement('tr');
                const monthNames = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                
                row.innerHTML = `
                    <td>${payroll.nombre} ${payroll.apellido}</td>
                    <td>${monthNames[payroll.periodo_mes]} ${payroll.periodo_ano}</td>
                    <td>
                        <i class="fas fa-file-pdf" style="color: #EF4444; margin-right: 5px;"></i>
                        ${payroll.nombre_archivo}
                    </td>
                    <td>${formatFileSize(payroll.tama√±o_archivo)}</td>
                    <td>${payroll.subido_por_nombre || 'N/A'} ${payroll.subido_por_apellido || ''}</td>
                    <td>${formatDate(payroll.fecha_subida)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="downloadPayroll(${payroll.id})" title="Descargar">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletePayroll(${payroll.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadEmployeesForPayroll() {
            fetch('/api/empleados', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const select = document.getElementById('payrollEmployee');
                    const filterSelect = document.getElementById('payrollEmployeeFilter');
                    
                    // Limpiar opciones existentes
                    select.innerHTML = '<option value="">Seleccionar empleado...</option>';
                    filterSelect.innerHTML = '<option value="">Todos los empleados</option>';
                    
                    data.empleados.forEach(employee => {
                        const option = document.createElement('option');
                        option.value = employee.id;
                        option.textContent = `${employee.nombre} ${employee.apellido}`;
                        select.appendChild(option);
                        
                        const filterOption = option.cloneNode(true);
                        filterSelect.appendChild(filterOption);
                    });
                }
            })
            .catch(error => {
                console.error('Error al cargar empleados:', error);
            });
        }

        function populateYearFilter() {
            const currentYear = new Date().getFullYear();
            const yearSelect = document.getElementById('payrollYear');
            const yearFilterSelect = document.getElementById('payrollYearFilter');
            
            // Limpiar opciones existentes
            yearSelect.innerHTML = '<option value="">A√±o</option>';
            yearFilterSelect.innerHTML = '<option value="">Todos los a√±os</option>';
            
            // Agregar a√±os desde 2020 hasta el a√±o actual + 1
            for (let year = 2020; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
                
                const filterOption = option.cloneNode(true);
                yearFilterSelect.appendChild(filterOption);
            }
        }

        function showUploadPayrollModal() {
            document.getElementById('uploadPayrollModal').style.display = 'block';
            document.getElementById('uploadPayrollForm').reset();
        }

        function filterPayrolls() {
            // Esta funci√≥n se implementar√° para filtrar las liquidaciones
            loadAllPayrolls(); // Por ahora recargamos todas
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function downloadPayroll(payrollId) {
            window.open(`/api/liquidaciones/download/${payrollId}`, '_blank');
        }

        function deletePayroll(payrollId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta liquidaci√≥n?')) {
                return;
            }
            
            fetch(`/api/liquidaciones/${payrollId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('Liquidaci√≥n eliminada correctamente');
                    loadAllPayrolls();
                } else {
                    showError(data.message || 'Error al eliminar liquidaci√≥n');
                }
            })
            .catch(error => {
                console.error('Error al eliminar liquidaci√≥n:', error);
                showError('Error al eliminar liquidaci√≥n');
            });
        }

        // Funciones para manejo de tiempo de colaci√≥n
        let currentBreakTimeEmployeeId = null;

        function editBreakTime(employeeId, currentBreakTime) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) {
                showError('Empleado no encontrado');
                return;
            }

            currentBreakTimeEmployeeId = employeeId;
            document.getElementById('breakTimeEmployee').value = `${employee.nombre} ${employee.apellido}`;
            document.getElementById('breakTimeMinutes').value = currentBreakTime;
            document.getElementById('editBreakTimeModal').style.display = 'block';
        }

        function updateBreakTime() {
            if (!currentBreakTimeEmployeeId) {
                showError('No se ha seleccionado un empleado');
                return;
            }

            const newBreakTime = parseInt(document.getElementById('breakTimeMinutes').value);
            
            if (isNaN(newBreakTime) || newBreakTime < 0 || newBreakTime > 120) {
                showError('El tiempo de colaci√≥n debe ser un n√∫mero entre 0 y 120 minutos');
                return;
            }

            fetch(`/api/empleados/${currentBreakTimeEmployeeId}/colacion`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    tiempo_colacion: newBreakTime
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('Tiempo de colaci√≥n actualizado correctamente');
                    closeModal('editBreakTimeModal');
                    loadEmployees(); // Recargar empleados para actualizar la tabla
                } else {
                    showError(data.message || 'Error al actualizar tiempo de colaci√≥n');
                }
            })
            .catch(error => {
                console.error('Error al actualizar tiempo de colaci√≥n:', error);
                showError('Error al actualizar tiempo de colaci√≥n');
            });
        }

        // Configurar formulario de subida de liquidaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            const uploadForm = document.getElementById('uploadPayrollForm');
            if (uploadForm) {
                uploadForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData();
                    formData.append('empleado_id', document.getElementById('payrollEmployee').value);
                    formData.append('periodo_mes', document.getElementById('payrollMonth').value);
                    formData.append('periodo_ano', document.getElementById('payrollYear').value);
                    formData.append('observaciones', document.getElementById('payrollObservations').value);
                    formData.append('liquidacion', document.getElementById('payrollFile').files[0]);
                    
                    fetch('/api/liquidaciones/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showSuccess('Liquidaci√≥n subida correctamente');
                            closeModal('uploadPayrollModal');
                            loadAllPayrolls();
                        } else {
                            showError(data.message || 'Error al subir liquidaci√≥n');
                        }
                    })
                    .catch(error => {
                        console.error('Error al subir liquidaci√≥n:', error);
                        showError('Error al subir liquidaci√≥n');
                    });
                });
            }

            // Configurar formulario de edici√≥n de tiempo de colaci√≥n
            const breakTimeForm = document.getElementById('editBreakTimeForm');
            if (breakTimeForm) {
                breakTimeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    updateBreakTime();
                });
            }
        });

        // Funci√≥n para navegar al mes anterior
        async function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            await generateCalendar();
        }

        // Funci√≥n para navegar al mes siguiente
        async function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            await generateCalendar();
        }

        // Funci√≥n para generar rotaci√≥n de horarios
        function generateRotatingSchedule() {
            console.log('Generando calendario oficial de turnos...');
            generateOfficialCalendar();
            showSuccess('Calendario oficial de turnos generado exitosamente');
        }

        // Funci√≥n para generar el calendario oficial como el de septiembre
        async function generateOfficialCalendar() {
            const calendarContainer = document.getElementById('calendarContainer');
            if (!calendarContainer) {
                console.error('No se encontr√≥ el contenedor del calendario');
                return;
            }

            // Obtener empleados actuales de la base de datos
            let employees = [];
            try {
                const response = await fetch('/api/empleados', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                if (data.success) {
                    employees = data.data.map((emp, index) => ({
                        id: emp.id,
                        name: `${emp.nombre} ${emp.apellido}`,
                        color: ['purple', 'blue', 'black', 'orange', 'green', 'yellow'][index % 6]
                    }));
                    console.log('Empleados cargados para calendario:', employees.length);
                } else {
                    console.error('Error al cargar empleados:', data.message);
                    return;
                }
            } catch (error) {
                console.error('Error al obtener empleados:', error);
                return;
            }

            // Generar calendario para septiembre 2025 (semana espec√≠fica del ejemplo)
            const currentDate = new Date();
            const targetMonth = 8; // Septiembre (0-indexed)
            const targetYear = 2025;
            const monthNames = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 
                              'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];
            
            const daysInMonth = new Date(targetYear, targetMonth + 1, 0).getDate();
            const firstDay = new Date(targetYear, targetMonth, 1).getDay();
            
            // Ajustar para que lunes sea 0
            const adjustedFirstDay = (firstDay + 6) % 7;
            
            let calendarHTML = `
                <div class="official-calendar">
                    <div class="calendar-header">
                        <h2>${monthNames[targetMonth]}</h2>
                        <div class="calendar-days-header">
            `;
            
            // Generar encabezado de d√≠as
            const dayNames = ['LUN.', 'MAR.', 'MI√â.', 'JUE.', 'VIE.', 'S√ÅB.', 'DOM.'];
            for (let i = 0; i < 7; i++) {
                calendarHTML += `<div class="day-header">${dayNames[i]}</div>`;
            }
            calendarHTML += `</div>`;
            
            // Generar n√∫meros de d√≠as para todo el mes
            calendarHTML += `<div class="calendar-days-numbers">`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDate = new Date(targetYear, targetMonth, day);
                const isSunday = dayDate.getDay() === 0;
                const isSpecialDay = day === 18 || day === 19; // D√≠as especiales como en el calendario
                
                let dayClass = 'day-number';
                if (isSunday || isSpecialDay) {
                    dayClass += ' special-day';
                }
                
                calendarHTML += `<div class="${dayClass}">${day}</div>`;
            }
            calendarHTML += `</div>`;
            
            // Generar filas de empleados con sus turnos
            calendarHTML += `<div class="calendar-employees">`;
            
            // Verificar si hay empleados
            if (employees.length === 0) {
                calendarHTML += `
                    <div class="no-employees-message">
                        <div class="message-content">
                            <i class="fas fa-users"></i>
                            <h3>No hay empleados registrados</h3>
                            <p>Agrega empleados para generar el calendario de turnos</p>
                            <button class="btn btn-primary" onclick="showSection('employees')">
                                <i class="fas fa-plus"></i> Agregar Empleado
                            </button>
                        </div>
                    </div>
                `;
            } else {
                for (const employee of employees) {
                calendarHTML += `
                    <div class="employee-row">
                        <div class="employee-info ${employee.color}">
                            <div class="employee-name">${employee.name}</div>
                        </div>
                        <div class="employee-schedule">
                `;
                
                // Generar turnos para cada d√≠a del mes
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDate = new Date(targetYear, targetMonth, day);
                    const dayOfWeek = dayDate.getDay();
                    const isSunday = dayOfWeek === 0;
                    
                    // L√≥gica de turnos con rotaci√≥n equitativa para todos los empleados
                    let shiftClass = 'no-shift';
                    let shiftColor = '';
                    
                    // Todos los empleados usan el sistema de rotaci√≥n equitativa
                    shiftClass = await getStandardRotationShift(employee.name, day, dayOfWeek);
                    shiftColor = getShiftColor(shiftClass);
                    
                    calendarHTML += `<div class="shift-cell ${shiftClass}" style="background-color: ${shiftColor}"></div>`;
                }
                
                calendarHTML += `
                        </div>
                    </div>
                `;
                }
            }
            
            calendarHTML += `
                    </div>
                </div>
            `;
            
            calendarContainer.innerHTML = calendarHTML;
        }

        // Funci√≥n para mostrar empleados de un d√≠a espec√≠fico
        async function showDayEmployees(selectedDate) {
            console.log('Mostrando empleados para el d√≠a:', selectedDate);
            
            const dayEmployeesPanel = document.getElementById('dayEmployeesPanel');
            const selectedDayTitle = document.getElementById('selectedDayTitle');
            const dayEmployeesList = document.getElementById('dayEmployeesList');
            
            // Formatear fecha para mostrar
            const dateOptions = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const formattedDate = selectedDate.toLocaleDateString('es-ES', dateOptions);
            
            // Verificar si es feriado
            const holiday = isHoliday(selectedDate);
            if (holiday) {
                selectedDayTitle.innerHTML = `üéâ ${holiday.name} - ${formattedDate}`;
                selectedDayTitle.style.color = '#FF6B6B';
            } else {
                selectedDayTitle.textContent = `Empleados de turno - ${formattedDate}`;
                selectedDayTitle.style.color = '';
            }
            
            // Mostrar panel
            dayEmployeesPanel.style.display = 'block';
            
            // Mostrar loading
            dayEmployeesList.innerHTML = '<div class="no-employees">Cargando empleados...</div>';
            
            try {
                // Obtener empleados que trabajan en este d√≠a
                const dayOfWeek = selectedDate.getDay(); // 0 = Domingo, 1 = Lunes, etc.
                const dateString = selectedDate.toISOString().split('T')[0]; // YYYY-MM-DD
                
                // Obtener horarios de empleados
                const response = await fetch('/api/horarios/empleados-calendario', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Error al obtener horarios de empleados');
                }
                
                const data = await response.json();
                
                if (!data.success || !data.horarios || data.horarios.length === 0) {
                    dayEmployeesList.innerHTML = '<div class="no-employees">No hay empleados asignados para este d√≠a</div>';
                    return;
                }
                
                // Filtrar empleados que trabajan en este d√≠a
                const workingEmployees = data.horarios.filter(schedule => {
                    if (schedule.estado !== 'ACTIVO') return false;
                    
                    // Verificar si el empleado trabaja en este d√≠a de la semana
                    const workDays = schedule.dias_trabajo ? schedule.dias_trabajo.split(',').map(d => parseInt(d)) : [];
                    return workDays.includes(dayOfWeek);
                });
                
                if (workingEmployees.length === 0) {
                    dayEmployeesList.innerHTML = '<div class="no-employees">No hay empleados de turno para este d√≠a</div>';
                    return;
                }
                
                // Generar HTML para los empleados
                let employeesHTML = '';
                workingEmployees.forEach(employee => {
                    const shiftName = getShiftName(employee.horario_nombre);
                    const shiftColor = getShiftColor(employee.horario_nombre);
                    const roleClass = getRoleClass(employee.rol);
                    
                    employeesHTML += `
                        <div class="employee-card">
                            <div class="employee-name">${employee.nombre} ${employee.apellido}</div>
                            <div class="employee-role ${roleClass}">${employee.rol || 'Sin rol asignado'}</div>
                            <div class="employee-schedule">
                                <span class="schedule-time">${employee.hora_entrada} - ${employee.hora_salida}</span>
                                <span class="schedule-shift" style="background-color: ${shiftColor}">${shiftName}</span>
                            </div>
                        </div>
                    `;
                });
                
                // Agregar informaci√≥n de feriado si aplica
                if (holiday) {
                    const holidayInfo = `
                        <div class="holiday-info" style="background: linear-gradient(135deg, #FF6B6B, #FF8E8E); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                            <h4 style="margin: 0 0 5px 0; font-size: 18px;">üéâ ${holiday.name}</h4>
                            <p style="margin: 0; font-size: 14px; opacity: 0.9;">D√≠a feriado en Chile</p>
                        </div>
                    `;
                    dayEmployeesList.innerHTML = holidayInfo + employeesHTML;
                } else {
                    dayEmployeesList.innerHTML = employeesHTML;
                }
                
            } catch (error) {
                console.error('Error al cargar empleados del d√≠a:', error);
                dayEmployeesList.innerHTML = '<div class="no-employees">Error al cargar empleados del d√≠a</div>';
            }
        }
        
        // Funci√≥n para obtener el nombre del turno
        function getShiftName(horarioNombre) {
            const shiftNames = {
                'Turno Ma√±ana': 'Ma√±ana',
                'Turno Tarde': 'Tarde', 
                'Turno Noche': 'Noche',
                'Fin de Semana Ma√±ana': 'Fin Sem. Ma√±ana',
                'Fin de Semana Tarde': 'Fin Sem. Tarde'
            };
            return shiftNames[horarioNombre] || horarioNombre;
        }
        
        // Funci√≥n para obtener el color del turno
        function getShiftColor(horarioNombre) {
            const shiftColors = {
                'Centralista Turno Ma√±ana': '#3B82F6',
                'Centralista Turno Tarde': '#3B82F6',
                'Despachador Turno Ma√±ana': '#10B981',
                'Despachador Turno Tarde': '#10B981',
                'Turno Noche': '#1F2937'
            };
            return shiftColors[horarioNombre] || '#6c757d';
        }
        
        // Funci√≥n para obtener la clase CSS del rol
        function getRoleClass(rol) {
            const roleClasses = {
                'Centralista': 'role-centralista',
                'Despachador': 'role-despachador',
                'Turno Noche': 'role-turno-noche',
                'Administrador': 'role-administrador'
            };
            return roleClasses[rol] || '';
        }
        
        // Funci√≥n para obtener la clase CSS del calendario por rol
        function getCalendarRoleClass(rol) {
            const roleClasses = {
                'Centralista': 'centralista',
                'Despachador': 'despachador',
                'Turno Noche': 'turno-noche',
                'Administrador': 'administrador'
            };
            return roleClasses[rol] || '';
        }
        
        // Funci√≥n para obtener feriados chilenos
        function getChileanHolidays(year) {
            const holidays = [];
            
            // Feriados fijos
            holidays.push({
                date: new Date(year, 0, 1), // 1 de enero
                name: 'A√±o Nuevo',
                type: 'fijo'
            });
            
            holidays.push({
                date: new Date(year, 4, 1), // 1 de mayo
                name: 'D√≠a del Trabajador',
                type: 'fijo'
            });
            
            holidays.push({
                date: new Date(year, 4, 21), // 21 de mayo
                name: 'D√≠a de las Glorias Navales',
                type: 'fijo'
            });
            
            holidays.push({
                date: new Date(year, 8, 18), // 18 de septiembre
                name: 'Fiestas Patrias',
                type: 'fijo'
            });
            
            holidays.push({
                date: new Date(year, 8, 19), // 19 de septiembre
                name: 'Glorias del Ej√©rcito',
                type: 'fijo'
            });
            
            holidays.push({
                date: new Date(year, 9, 12), // 12 de octubre
                name: 'Encuentro de Dos Mundos',
                type: 'fijo'
            });
            
            holidays.push({
                date: new Date(year, 10, 1), // 1 de noviembre
                name: 'D√≠a de Todos los Santos',
                type: 'fijo'
            });
            
            holidays.push({
                date: new Date(year, 11, 8), // 8 de diciembre
                name: 'Inmaculada Concepci√≥n',
                type: 'fijo'
            });
            
            holidays.push({
                date: new Date(year, 11, 25), // 25 de diciembre
                name: 'Navidad',
                type: 'fijo'
            });
            
            // Feriados variables (Semana Santa)
            const easterDate = calculateEaster(year);
            const goodFriday = new Date(easterDate);
            goodFriday.setDate(easterDate.getDate() - 2);
            
            const holySaturday = new Date(easterDate);
            holySaturday.setDate(easterDate.getDate() - 1);
            
            holidays.push({
                date: goodFriday,
                name: 'Viernes Santo',
                type: 'variable'
            });
            
            holidays.push({
                date: holySaturday,
                name: 'S√°bado Santo',
                type: 'variable'
            });
            
            return holidays;
        }
        
        // Funci√≥n para calcular la fecha de Pascua (algoritmo de Gauss)
        function calculateEaster(year) {
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const n = Math.floor((h + l - 7 * m + 114) / 31);
            const p = (h + l - 7 * m + 114) % 31;
            
            return new Date(year, n - 1, p + 1);
        }
        
        // Funci√≥n para verificar si una fecha es feriado
        function isHoliday(date) {
            const year = date.getFullYear();
            const holidays = getChileanHolidays(year);
            
            return holidays.find(holiday => 
                holiday.date.getDate() === date.getDate() &&
                holiday.date.getMonth() === date.getMonth() &&
                holiday.date.getFullYear() === date.getFullYear()
            );
        }
        
        // Funci√≥n para mostrar/ocultar secci√≥n de turnos personalizados
        function toggleCustomShifts() {
            const section = document.getElementById('customShiftsSection');
            const icon = document.getElementById('customShiftsToggleIcon');
            const button = event.target.closest('button');
            
            if (section.style.display === 'none' || section.style.display === '') {
                // Mostrar secci√≥n
                section.style.display = 'block';
                section.classList.add('show');
                section.classList.remove('hide');
                
                // Rotar icono
                icon.style.transform = 'rotate(180deg)';
                
                // Cambiar estilo del bot√≥n
                button.classList.add('active');
                
                // Cargar roles en el select si no est√°n cargados
                populateCustomShiftRoleSelect();
                
            } else {
                // Ocultar secci√≥n
                section.classList.add('hide');
                section.classList.remove('show');
                
                // Rotar icono
                icon.style.transform = 'rotate(0deg)';
                
                // Cambiar estilo del bot√≥n
                button.classList.remove('active');
                
                // Ocultar despu√©s de la animaci√≥n
                setTimeout(() => {
                    section.style.display = 'none';
                }, 300);
            }
        }
        
        // Variable para almacenar el turno actual siendo editado
        let currentEditingShift = null;
        
        // Funci√≥n para mostrar/ocultar secci√≥n de edici√≥n de turnos
        function toggleEditShifts() {
            const section = document.getElementById('editShiftsSection');
            const icon = document.getElementById('editShiftsToggleIcon');
            const button = event.target.closest('button');
            
            if (section.style.display === 'none' || section.style.display === '') {
                // Mostrar secci√≥n
                section.style.display = 'block';
                section.classList.add('show');
                section.classList.remove('hide');
                
                // Rotar icono
                icon.style.transform = 'rotate(180deg)';
                
                // Cambiar estilo del bot√≥n
                button.classList.add('active');
                
                // Cargar turnos disponibles
                loadShiftsForEdit();
                
            } else {
                // Ocultar secci√≥n
                section.classList.add('hide');
                section.classList.remove('show');
                
                // Rotar icono
                icon.style.transform = 'rotate(0deg)';
                
                // Cambiar estilo del bot√≥n
                button.classList.remove('active');
                
                // Ocultar despu√©s de la animaci√≥n
                setTimeout(() => {
                    section.style.display = 'none';
                }, 300);
            }
        }
        
        // Funci√≥n para cargar turnos disponibles para edici√≥n
        async function loadShiftsForEdit() {
            try {
                const response = await fetch('/api/horarios', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                const select = document.getElementById('selectShiftToEdit');
                
                if (data.success && data.data) {
                    select.innerHTML = '<option value="">Seleccionar turno...</option>';
                    data.data.forEach(shift => {
                        const option = document.createElement('option');
                        option.value = shift.id;
                        option.textContent = `${shift.nombre} (${shift.hora_entrada} - ${shift.hora_salida})`;
                        select.appendChild(option);
                    });
                }
                
                // Tambi√©n cargar roles en el select de edici√≥n
                populateEditShiftRoleSelect();
                
            } catch (error) {
                console.error('Error al cargar turnos para edici√≥n:', error);
                showError('Error al cargar turnos disponibles');
            }
        }
        
        // Funci√≥n para poblar select de roles en edici√≥n
        function populateEditShiftRoleSelect() {
            const select = document.getElementById('editShiftRole');
            if (!select) return;
            
            if (cachedData.roles && cachedData.roles.length > 0) {
                const roles = cachedData.roles;
                select.innerHTML = '<option value="">Seleccionar rol...</option>';
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = role.nombre;
                    select.appendChild(option);
                });
            } else {
                loadRoles();
            }
        }
        
        // Funci√≥n para cargar datos del turno seleccionado
        async function loadShiftForEdit() {
            const shiftId = document.getElementById('selectShiftToEdit').value;
            
            if (!shiftId) {
                document.getElementById('shiftEditForm').style.display = 'none';
                currentEditingShift = null;
                return;
            }
            
            try {
                showLoading('Cargando datos del turno...');
                
                const response = await fetch(`/api/horarios/${shiftId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.success && data.data) {
                    currentEditingShift = data.data;
                    populateShiftEditForm(data.data);
                    document.getElementById('shiftEditForm').style.display = 'block';
                } else {
                    showError('Error al cargar datos del turno');
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error al cargar turno:', error);
                showError('Error al cargar datos del turno');
            }
        }
        
        // Funci√≥n para poblar el formulario de edici√≥n
        function populateShiftEditForm(shift) {
            // Informaci√≥n b√°sica
            document.getElementById('editShiftName').value = shift.nombre || '';
            document.getElementById('editShiftStart').value = shift.hora_entrada || '';
            document.getElementById('editShiftEnd').value = shift.hora_salida || '';
            
            // Rol (si est√° disponible)
            if (shift.rol_id) {
                document.getElementById('editShiftRole').value = shift.rol_id;
            }
            
            // D√≠as de la semana
            if (shift.dias_semana) {
                const days = shift.dias_semana.split(',');
                for (let i = 1; i <= 7; i++) {
                    const checkbox = document.getElementById(`editDay${i}`);
                    if (checkbox) {
                        checkbox.checked = days.includes(i.toString());
                    }
                }
            }
            
            // Configuraciones adicionales (valores por defecto si no est√°n en la BD)
            document.getElementById('editBreakDuration').value = shift.break_duration || '30';
            document.getElementById('editMaxHours').value = shift.max_hours || '10';
            document.getElementById('editMinEmployees').value = shift.min_employees || '1';
            document.getElementById('editMaxEmployees').value = shift.max_employees || '1';
            
            // Checkboxes
            document.getElementById('editWorkHolidays').checked = shift.work_holidays || false;
            document.getElementById('editWeekendOnly').checked = shift.weekend_only || false;
            document.getElementById('editFlexibleHours').checked = shift.flexible_hours || false;
            document.getElementById('editOvertimeAllowed').checked = shift.overtime_allowed || false;
            document.getElementById('editRotationRequired').checked = shift.rotation_required || false;
            document.getElementById('editPriorityShift').checked = shift.priority_shift || false;
            document.getElementById('editShiftActive').checked = shift.activo !== 0;
            document.getElementById('editShiftVisible').checked = shift.visible !== 0;
        }
        
        // Funci√≥n para guardar cambios del turno
        async function saveShiftEdit() {
            if (!currentEditingShift) {
                showError('No hay turno seleccionado para editar');
                return;
            }
            
            try {
                showLoading('Guardando cambios del turno...');
                
                // Recopilar datos del formulario
                const shiftData = {
                    nombre: document.getElementById('editShiftName').value,
                    hora_entrada: document.getElementById('editShiftStart').value,
                    hora_salida: document.getElementById('editShiftEnd').value,
                    rol_id: document.getElementById('editShiftRole').value,
                    dias_semana: getSelectedDays(),
                    break_duration: document.getElementById('editBreakDuration').value,
                    max_hours: document.getElementById('editMaxHours').value,
                    min_employees: document.getElementById('editMinEmployees').value,
                    max_employees: document.getElementById('editMaxEmployees').value,
                    work_holidays: document.getElementById('editWorkHolidays').checked,
                    weekend_only: document.getElementById('editWeekendOnly').checked,
                    flexible_hours: document.getElementById('editFlexibleHours').checked,
                    overtime_allowed: document.getElementById('editOvertimeAllowed').checked,
                    rotation_required: document.getElementById('editRotationRequired').checked,
                    priority_shift: document.getElementById('editPriorityShift').checked,
                    activo: document.getElementById('editShiftActive').checked ? 1 : 0,
                    visible: document.getElementById('editShiftVisible').checked ? 1 : 0
                };
                
                const response = await fetch(`/api/horarios/${currentEditingShift.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(shiftData)
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.success) {
                    showSuccess('Turno actualizado exitosamente');
                    
                    // Regenerar calendario
                    if (typeof generateCalendar === 'function') {
                        generateCalendar();
                    }
                    
                    // Recargar lista de turnos
                    loadShiftsForEdit();
                } else {
                    showError(data.message || 'Error al actualizar turno');
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error al guardar turno:', error);
                showError('Error al guardar cambios del turno');
            }
        }
        
        // Funci√≥n para obtener d√≠as seleccionados
        function getSelectedDays() {
            const days = [];
            for (let i = 1; i <= 7; i++) {
                const checkbox = document.getElementById(`editDay${i}`);
                if (checkbox && checkbox.checked) {
                    days.push(i);
                }
            }
            return days.join(',');
        }
        
        // Funci√≥n para restaurar valores originales
        function resetShiftEdit() {
            if (currentEditingShift) {
                populateShiftEditForm(currentEditingShift);
                showSuccess('Formulario restaurado a valores originales');
            }
        }
        
        // Funci√≥n para duplicar turno
        async function duplicateShift() {
            if (!currentEditingShift) {
                showError('No hay turno seleccionado para duplicar');
                return;
            }
            
            try {
                showLoading('Duplicando turno...');
                
                const duplicateData = {
                    nombre: `${currentEditingShift.nombre} (Copia)`,
                    hora_entrada: currentEditingShift.hora_entrada,
                    hora_salida: currentEditingShift.hora_salida,
                    rol_id: currentEditingShift.rol_id,
                    dias_semana: currentEditingShift.dias_semana,
                    break_duration: currentEditingShift.break_duration || '30',
                    max_hours: currentEditingShift.max_hours || '10',
                    min_employees: currentEditingShift.min_employees || '1',
                    max_employees: currentEditingShift.max_employees || '1',
                    work_holidays: currentEditingShift.work_holidays || false,
                    weekend_only: currentEditingShift.weekend_only || false,
                    flexible_hours: currentEditingShift.flexible_hours || false,
                    overtime_allowed: currentEditingShift.overtime_allowed || false,
                    rotation_required: currentEditingShift.rotation_required || false,
                    priority_shift: currentEditingShift.priority_shift || false,
                    activo: 1,
                    visible: 1
                };
                
                const response = await fetch('/api/horarios', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(duplicateData)
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.success) {
                    showSuccess('Turno duplicado exitosamente');
                    loadShiftsForEdit();
                    
                    // Regenerar calendario
                    if (typeof generateCalendar === 'function') {
                        generateCalendar();
                    }
                } else {
                    showError(data.message || 'Error al duplicar turno');
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error al duplicar turno:', error);
                showError('Error al duplicar turno');
            }
        }
        
        // Funci√≥n para eliminar turno
        async function deleteShift() {
            if (!currentEditingShift) {
                showError('No hay turno seleccionado para eliminar');
                return;
            }
            
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar el turno "${currentEditingShift.nombre}"? Esta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                showLoading('Eliminando turno...');
                
                const response = await fetch(`/api/horarios/${currentEditingShift.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.success) {
                    showSuccess('Turno eliminado exitosamente');
                    
                    // Limpiar formulario
                    document.getElementById('shiftEditForm').style.display = 'none';
                    document.getElementById('selectShiftToEdit').value = '';
                    currentEditingShift = null;
                    
                    // Recargar lista de turnos
                    loadShiftsForEdit();
                    
                    // Regenerar calendario
                    if (typeof generateCalendar === 'function') {
                        generateCalendar();
                    }
                } else {
                    showError(data.message || 'Error al eliminar turno');
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error al eliminar turno:', error);
                showError('Error al eliminar turno');
            }
        }
        
        // ===== FUNCIONES PARA EMPLEADOS PART-TIME =====
        
        // Funci√≥n para mostrar/ocultar formulario de empleado part-time
        async function togglePartTimeForm() {
            const form = document.getElementById('partTimeForm');
            const icon = document.getElementById('partTimeToggleIcon');
            const button = event.target.closest('button');
            
            if (form.style.display === 'none' || form.style.display === '') {
                // Mostrar formulario
                form.style.display = 'block';
                form.classList.add('show');
                form.classList.remove('hide');
                
                // Rotar icono
                icon.style.transform = 'rotate(180deg)';
                
                // Cambiar estilo del bot√≥n
                button.classList.add('active');
                
                // Cargar roles disponibles
                await populatePartTimeRoleSelect();
                
                // Establecer fecha de hoy por defecto
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('partTimeStartDate').value = today;
                
            } else {
                // Ocultar formulario
                form.classList.add('hide');
                form.classList.remove('show');
                
                // Rotar icono
                icon.style.transform = 'rotate(0deg)';
                
                // Cambiar estilo del bot√≥n
                button.classList.remove('active');
                
                // Ocultar despu√©s de la animaci√≥n
                setTimeout(() => {
                    form.style.display = 'none';
                }, 300);
            }
        }
        
        // Funci√≥n para poblar select de roles para part-time
        async function populatePartTimeRoleSelect() {
            const select = document.getElementById('partTimeRole');
            if (!select) return;
            
            try {
                const rolesData = await getCachedData('roles', '/api/roles');
                if (rolesData && rolesData.success && rolesData.data && rolesData.data.length > 0) {
                    const roles = rolesData.data;
                    select.innerHTML = '<option value="">Sin rol espec√≠fico (Flexible)</option>';
                    roles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.id;
                        option.textContent = role.nombre;
                        select.appendChild(option);
                    });
                } else {
                    // Si no hay roles, mantener solo la opci√≥n flexible
                    select.innerHTML = '<option value="">Sin rol espec√≠fico (Flexible)</option>';
                }
            } catch (error) {
                console.error('Error al cargar roles para part-time:', error);
                select.innerHTML = '<option value="">Sin rol espec√≠fico (Flexible)</option>';
            }
        }
        
        // Funci√≥n para agregar empleado part-time
        async function addPartTimeEmployee() {
            try {
                // Validar campos requeridos
                const name = document.getElementById('partTimeName').value.trim();
                const email = document.getElementById('partTimeEmail').value.trim();
                const role = document.getElementById('partTimeRole').value;
                
                if (!name || !email) {
                    showError('Por favor completa los campos requeridos (Nombre y Email)');
                    return;
                }
                
                // Validar email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showError('Por favor ingresa un email v√°lido');
                    return;
                }
                
                showLoading('Contratando empleado part-time...');
                
                // Recopilar datos del formulario
                const employeeData = {
                    nombre: name,
                    email: email,
                    telefono: document.getElementById('partTimePhone').value.trim(),
                    rol_id: role,
                    tipo_empleado: 'PART_TIME',
                    dias_disponibles: getPartTimeSelectedDays(),
                    max_horas_semana: document.getElementById('partTimeMaxHours').value,
                    disponible_fines_semana: document.getElementById('partTimeWeekends').checked,
                    disponible_feriados: document.getElementById('partTimeHolidays').checked,
                    cobertura_vacaciones: document.getElementById('partTimeVacationCover').checked,
                    cobertura_enfermedades: document.getElementById('partTimeSickCover').checked,
                    cobertura_emergencias: document.getElementById('partTimeEmergencyCover').checked,
                    cobertura_horas_extra: document.getElementById('partTimeOvertimeCover').checked,
                    salario_hora: document.getElementById('partTimeSalary').value || null,
                    fecha_inicio: document.getElementById('partTimeStartDate').value,
                    notas: document.getElementById('partTimeNotes').value.trim(),
                    activo: 1
                };
                
                const response = await fetch('/api/empleados/part-time', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(employeeData)
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.success) {
                    showSuccess('Empleado part-time contratado exitosamente');
                    
                    // Limpiar formulario y ocultar
                    clearPartTimeForm();
                    togglePartTimeForm();
                    
                    // Recargar lista de empleados part-time
                    loadPartTimeEmployees();
                    
                    // Actualizar contadores del dashboard
                    if (typeof loadDashboardData === 'function') {
                        loadDashboardData();
                    }
                } else {
                    showError(data.message || 'Error al contratar empleado part-time');
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error al agregar empleado part-time:', error);
                showError('Error al contratar empleado part-time');
            }
        }
        
        // Funci√≥n para obtener d√≠as seleccionados para part-time
        function getPartTimeSelectedDays() {
            const days = [];
            for (let i = 1; i <= 7; i++) {
                const checkbox = document.getElementById(`partTimeDay${i}`);
                if (checkbox && checkbox.checked) {
                    days.push(i);
                }
            }
            return days.join(',');
        }
        
        // Funci√≥n para limpiar formulario part-time
        function clearPartTimeForm() {
            document.getElementById('partTimeName').value = '';
            document.getElementById('partTimeEmail').value = '';
            document.getElementById('partTimePhone').value = '';
            document.getElementById('partTimeRole').value = ''; // Mantener "Sin rol espec√≠fico (Flexible)"
            document.getElementById('partTimeSalary').value = '';
            document.getElementById('partTimeNotes').value = '';
            
            // Limpiar checkboxes de d√≠as
            for (let i = 1; i <= 7; i++) {
                const checkbox = document.getElementById(`partTimeDay${i}`);
                if (checkbox) checkbox.checked = false;
            }
            
            // Limpiar otros checkboxes
            document.getElementById('partTimeWeekends').checked = false;
            document.getElementById('partTimeHolidays').checked = false;
            document.getElementById('partTimeVacationCover').checked = true;
            document.getElementById('partTimeSickCover').checked = true;
            document.getElementById('partTimeEmergencyCover').checked = true;
            document.getElementById('partTimeOvertimeCover').checked = false;
            
            // Restablecer valores por defecto
            document.getElementById('partTimeMaxHours').value = '20';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('partTimeStartDate').value = today;
        }
        
        // Funci√≥n para cargar empleados part-time
        async function loadPartTimeEmployees() {
            try {
                console.log('Cargando empleados part-time...');
                const response = await fetch('/api/empleados?tipo=PART_TIME', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                console.log('Respuesta de empleados part-time:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Datos de empleados part-time:', data);
                
                const container = document.getElementById('partTimeTableContainer');
                
                if (data.success && data.data && data.data.length > 0) {
                    const employees = data.data;
                    container.innerHTML = '';
                    
                    employees.forEach(employee => {
                        const card = createPartTimeEmployeeCard(employee);
                        container.appendChild(card);
                    });
                } else {
                    container.innerHTML = '<p class="text-muted text-center">No hay empleados part-time registrados</p>';
                }
                
            } catch (error) {
                console.error('Error al cargar empleados part-time:', error);
                document.getElementById('partTimeTableContainer').innerHTML = 
                    '<p class="text-danger text-center">Error al cargar empleados part-time: ' + error.message + '</p>';
            }
        }
        
        // Funci√≥n para crear tarjeta de empleado part-time
        function createPartTimeEmployeeCard(employee) {
            const card = document.createElement('div');
            card.className = 'part-time-employee-card';
            
            // Obtener d√≠as disponibles
            const availableDays = employee.dias_disponibles ? 
                employee.dias_disponibles.split(',').map(d => {
                    const days = ['', 'L', 'M', 'X', 'J', 'V', 'S', 'D'];
                    return days[parseInt(d)];
                }).join(', ') : 'No especificado';
            
            // Crear badges de cobertura
            const coverageBadges = [];
            
            // Badge especial para empleados flexibles
            if (!employee.rol_nombre) {
                coverageBadges.push('<span class="coverage-badge" style="background: #e3f2fd; color: #1976d2; border-color: #bbdefb;">üîÑ Flexible</span>');
            }
            
            if (employee.cobertura_vacaciones) coverageBadges.push('<span class="coverage-badge active">Vacaciones</span>');
            if (employee.cobertura_enfermedades) coverageBadges.push('<span class="coverage-badge active">Enfermedades</span>');
            if (employee.cobertura_emergencias) coverageBadges.push('<span class="coverage-badge active">Emergencias</span>');
            if (employee.cobertura_horas_extra) coverageBadges.push('<span class="coverage-badge active">Horas Extra</span>');
            
            card.innerHTML = `
                <div class="part-time-employee-header">
                    <div class="part-time-employee-name">${employee.nombre}</div>
                    <div class="part-time-employee-role">${employee.rol_nombre || 'Flexible (Cualquier rol)'}</div>
                </div>
                
                <div class="part-time-employee-details">
                    <div class="part-time-detail-item">
                        <i class="fas fa-envelope"></i>
                        <span>${employee.email}</span>
                    </div>
                    <div class="part-time-detail-item">
                        <i class="fas fa-phone"></i>
                        <span>${employee.telefono || 'No especificado'}</span>
                    </div>
                    <div class="part-time-detail-item">
                        <i class="fas fa-calendar-week"></i>
                        <span>D√≠as: ${availableDays}</span>
                    </div>
                    <div class="part-time-detail-item">
                        <i class="fas fa-clock"></i>
                        <span>M√°x: ${employee.max_horas_semana || '20'}h/semana</span>
                    </div>
                    <div class="part-time-detail-item">
                        <i class="fas fa-dollar-sign"></i>
                        <span>$${employee.salario_hora || 'No especificado'}/hora</span>
                    </div>
                    <div class="part-time-detail-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Inicio: ${employee.fecha_contratacion ? new Date(employee.fecha_contratacion).toLocaleDateString() : 'No especificado'}</span>
                    </div>
                </div>
                
                <div class="part-time-coverage-badges">
                    ${coverageBadges.join('')}
                </div>
                
                ${employee.notas ? `<div style="margin-bottom: 10px; font-size: 14px; color: #6c757d; font-style: italic;">"${employee.notas}"</div>` : ''}
                
                <div class="part-time-actions">
                    <button onclick="editPartTimeEmployee(${employee.id})" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button onclick="editPartTimeSchedule(${employee.id}, '${employee.nombre}')" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-clock"></i> Horarios
                    </button>
                    <button onclick="viewPartTimeSchedule(${employee.id})" class="btn btn-sm btn-outline-info">
                        <i class="fas fa-calendar"></i> Ver
                    </button>
                    <button onclick="deletePartTimeEmployee(${employee.id})" class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            `;
            
            return card;
        }
        
        // Variable para almacenar el empleado part-time actual siendo editado
        let currentPartTimeEmployee = null;
        
        // Funci√≥n para editar empleado part-time
        function editPartTimeEmployee(employeeId) {
            // TODO: Implementar edici√≥n de empleado part-time
            showInfo('Funci√≥n de edici√≥n en desarrollo');
        }
        
        // Funci√≥n para editar horarios de empleado part-time
        async function editPartTimeSchedule(employeeId, employeeName) {
            try {
                currentPartTimeEmployee = { id: employeeId, name: employeeName };
                
                // Actualizar t√≠tulo del modal
                document.getElementById('partTimeScheduleModalTitle').textContent = 
                    `Editar Horarios - ${employeeName}`;
                
                showLoading('Cargando horarios disponibles...');
                
                // Cargar horarios disponibles y horarios actuales del empleado
                const [schedulesResponse, employeeResponse] = await Promise.all([
                    fetch('/api/horarios', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    }),
                    fetch(`/api/empleados/${employeeId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    })
                ]);
                
                const schedulesData = await schedulesResponse.json();
                const employeeData = await employeeResponse.json();
                
                hideLoading();
                
                if (!schedulesData.success || !employeeData.success) {
                    showError('Error al cargar datos para edici√≥n de horarios');
                    return;
                }
                
                // Generar contenido del editor
                generateScheduleEditor(schedulesData.data, employeeData.data);
                
                // Mostrar modal
                document.getElementById('partTimeScheduleModal').style.display = 'block';
                
            } catch (error) {
                hideLoading();
                console.error('Error al abrir editor de horarios:', error);
                showError('Error al cargar editor de horarios');
            }
        }
        
        // Funci√≥n para generar el editor de horarios
        function generateScheduleEditor(schedules, employee) {
            const content = document.getElementById('partTimeScheduleContent');
            
            // Obtener horarios actuales del empleado (si los tiene)
            const currentSchedules = employee.horarios_asignados || [];
            
            // Crear grid de d√≠as de la semana
            const days = [
                { id: 1, name: 'Lunes', short: 'L' },
                { id: 2, name: 'Martes', short: 'M' },
                { id: 3, name: 'Mi√©rcoles', short: 'X' },
                { id: 4, name: 'Jueves', short: 'J' },
                { id: 5, name: 'Viernes', short: 'V' },
                { id: 6, name: 'S√°bado', short: 'S' },
                { id: 7, name: 'Domingo', short: 'D' }
            ];
            
            let html = `
                <div class="schedule-editor">
                    <h4 style="color: #495057; margin-bottom: 15px;">
                        <i class="fas fa-calendar-week"></i> Asignar Horarios por D√≠a
                    </h4>
                    <p style="color: #6c757d; margin-bottom: 20px;">
                        Selecciona los turnos que trabajar√° ${employee.nombre} en cada d√≠a de la semana.
                    </p>
                    
                    <div class="schedule-grid">
            `;
            
            // Crear columnas para cada d√≠a
            days.forEach(day => {
                html += `
                    <div class="day-column">
                        <div class="day-header">${day.name}</div>
                        <div class="day-shifts" id="day-${day.id}">
                `;
                
                // Agregar opciones de turnos para este d√≠a
                if (schedules && schedules.length > 0) {
                    schedules.forEach(schedule => {
                        const isChecked = currentSchedules.some(cs => 
                            cs.dia_semana === day.id && cs.horario_id === schedule.id
                        );
                        
                        html += `
                            <div class="shift-option">
                                <label>
                                    <input type="checkbox" 
                                           value="${schedule.id}" 
                                           data-day="${day.id}"
                                           data-schedule-name="${schedule.nombre}"
                                           data-schedule-time="${schedule.hora_entrada} - ${schedule.hora_salida}"
                                           ${isChecked ? 'checked' : ''}>
                                    <div>
                                        <div class="shift-name">${schedule.nombre}</div>
                                        <div class="shift-time">${schedule.hora_entrada} - ${schedule.hora_salida}</div>
                                    </div>
                                </label>
                            </div>
                        `;
                    });
                } else {
                    html += '<div class="no-shifts">No hay turnos disponibles</div>';
                }
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    
                    <div class="schedule-summary">
                        <div class="summary-title">
                            <i class="fas fa-list"></i> Resumen de Horarios Asignados
                        </div>
                        <div id="scheduleSummaryContent">
                            <!-- Se actualizar√° din√°micamente -->
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            
            // Agregar event listeners para actualizar el resumen
            document.querySelectorAll('input[type="checkbox"][data-day]').forEach(checkbox => {
                checkbox.addEventListener('change', updateScheduleSummary);
            });
            
            // Actualizar resumen inicial
            updateScheduleSummary();
        }
        
        // Funci√≥n para actualizar el resumen de horarios
        function updateScheduleSummary() {
            const summaryContent = document.getElementById('scheduleSummaryContent');
            const days = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
            
            let summaryHTML = '';
            let totalShifts = 0;
            
            for (let dayId = 1; dayId <= 7; dayId++) {
                const dayShifts = [];
                const checkboxes = document.querySelectorAll(`input[data-day="${dayId}"]:checked`);
                
                checkboxes.forEach(checkbox => {
                    const scheduleName = checkbox.getAttribute('data-schedule-name');
                    const scheduleTime = checkbox.getAttribute('data-schedule-time');
                    dayShifts.push(`${scheduleName} (${scheduleTime})`);
                    totalShifts++;
                });
                
                summaryHTML += `
                    <div class="summary-item">
                        <div class="summary-day">${days[dayId - 1]}</div>
                        <div class="summary-shifts">
                            ${dayShifts.length > 0 ? dayShifts.join(', ') : 'Sin turnos asignados'}
                        </div>
                    </div>
                `;
            }
            
            // Agregar total
            summaryHTML += `
                <div class="summary-item" style="border-top: 2px solid #dee2e6; margin-top: 10px; padding-top: 10px;">
                    <div class="summary-day" style="font-weight: 600;">Total de Turnos</div>
                    <div class="summary-shifts" style="font-weight: 600;">${totalShifts} turnos asignados</div>
                </div>
            `;
            
            summaryContent.innerHTML = summaryHTML;
        }
        
        // Funci√≥n para guardar horarios de empleado part-time
        async function savePartTimeSchedule() {
            if (!currentPartTimeEmployee) {
                showError('No hay empleado seleccionado');
                return;
            }
            
            try {
                showLoading('Guardando horarios...');
                
                // Recopilar horarios seleccionados
                const selectedSchedules = [];
                const checkboxes = document.querySelectorAll('input[type="checkbox"][data-day]:checked');
                
                checkboxes.forEach(checkbox => {
                    selectedSchedules.push({
                        dia_semana: parseInt(checkbox.getAttribute('data-day')),
                        horario_id: parseInt(checkbox.value),
                        horario_nombre: checkbox.getAttribute('data-schedule-name'),
                        horario_tiempo: checkbox.getAttribute('data-schedule-time')
                    });
                });
                
                // Enviar datos al servidor
                const response = await fetch(`/api/empleados/${currentPartTimeEmployee.id}/horarios`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        horarios: selectedSchedules
                    })
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.success) {
                    showSuccess('Horarios guardados exitosamente');
                    closeModal('partTimeScheduleModal');
                    
                    // Recargar lista de empleados part-time
                    loadPartTimeEmployees();
                } else {
                    showError(data.message || 'Error al guardar horarios');
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error al guardar horarios:', error);
                showError('Error al guardar horarios');
            }
        }
        
        // Funci√≥n para ver horarios de empleado part-time
        function viewPartTimeSchedule(employeeId) {
            // TODO: Implementar vista de horarios
            showInfo('Funci√≥n de horarios en desarrollo');
        }
        
        // Funci√≥n para eliminar empleado part-time
        async function deletePartTimeEmployee(employeeId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este empleado part-time? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            try {
                showLoading('Eliminando empleado part-time...');
                
                const response = await fetch(`/api/empleados/${employeeId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.success) {
                    showSuccess('Empleado part-time eliminado exitosamente');
                    loadPartTimeEmployees();
                    
                    // Actualizar contadores del dashboard
                    if (typeof loadDashboardData === 'function') {
                        loadDashboardData();
                    }
                } else {
                    showError(data.message || 'Error al eliminar empleado part-time');
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error al eliminar empleado part-time:', error);
                showError('Error al eliminar empleado part-time');
            }
        }
        
        // Funci√≥n para limpiar formulario de turnos personalizados
        function clearCustomShiftForm() {
            document.getElementById('customShiftName').value = '';
            document.getElementById('customShiftRole').value = '';
            document.getElementById('customShiftStart').value = '';
            document.getElementById('customShiftEnd').value = '';
            
            // Limpiar checkboxes de d√≠as
            document.querySelectorAll('.days-checkboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            showSuccess('Formulario limpiado');
        }
        
        // Funci√≥n para mostrar modal de feriados
        function showHolidaysModal() {
            const holidaysList = document.getElementById('holidaysList');
            const currentYear = new Date().getFullYear();
            const holidays = getChileanHolidays(currentYear);
            
            let holidaysHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h4 style="color: #495057; margin-bottom: 10px;">Feriados de ${currentYear}</h4>
                    <p style="color: #6c757d; font-size: 14px;">D√≠as festivos oficiales en Chile</p>
                </div>
                <div style="display: grid; gap: 10px;">
            `;
            
            holidays.forEach(holiday => {
                const dateStr = holiday.date.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric'
                });
                
                const typeIcon = holiday.type === 'fijo' ? 'üìÖ' : 'üê£';
                const typeText = holiday.type === 'fijo' ? 'Fijo' : 'Variable';
                
                holidaysHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #FF6B6B;">
                        <div>
                            <div style="font-weight: 600; color: #495057;">${typeIcon} ${holiday.name}</div>
                            <div style="font-size: 14px; color: #6c757d;">${dateStr}</div>
                        </div>
                        <div style="font-size: 12px; color: #6c757d; background: #e9ecef; padding: 4px 8px; border-radius: 12px;">
                            ${typeText}
                        </div>
                    </div>
                `;
            });
            
            holidaysHTML += '</div>';
            
            holidaysList.innerHTML = holidaysHTML;
            document.getElementById('holidaysModal').style.display = 'block';
        }
        
        // Funci√≥n para agregar turno personalizado
        async function addCustomShift() {
            try {
                const nombre = document.getElementById('customShiftName').value.trim();
                const rolId = document.getElementById('customShiftRole').value;
                const horaEntrada = document.getElementById('customShiftStart').value;
                const horaSalida = document.getElementById('customShiftEnd').value;
                
                // Obtener d√≠as seleccionados
                const diasCheckboxes = document.querySelectorAll('.days-checkboxes input[type="checkbox"]:checked');
                const diasSemana = Array.from(diasCheckboxes).map(cb => cb.value).join(',');
                
                // Validaciones
                if (!nombre) {
                    showError('Por favor ingresa el nombre del turno');
                    return;
                }
                
                if (!rolId) {
                    showError('Por favor selecciona un rol');
                    return;
                }
                
                if (!horaEntrada || !horaSalida) {
                    showError('Por favor ingresa las horas de entrada y salida');
                    return;
                }
                
                if (diasSemana === '') {
                    showError('Por favor selecciona al menos un d√≠a de la semana');
                    return;
                }
                
                showLoading('Agregando turno personalizado...');
                
                const response = await fetch('/api/horarios', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        nombre: nombre,
                        hora_entrada: horaEntrada,
                        hora_salida: horaSalida,
                        dias_semana: diasSemana,
                        rol_id: rolId,
                        activo: 1
                    })
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.success) {
                    showSuccess('Turno personalizado agregado exitosamente');
                    
                    // Limpiar formulario
                    clearCustomShiftForm();
                    
                    // Ocultar secci√≥n despu√©s de un breve delay
                    setTimeout(() => {
                        toggleCustomShifts();
                    }, 1500);
                    
                    // Regenerar calendario
                    if (typeof generateCalendar === 'function') {
                        generateCalendar();
                    }
                } else {
                    showError(data.message || 'Error al agregar turno personalizado');
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error al agregar turno personalizado:', error);
                showError('Error al agregar turno personalizado');
            }
        }
        
        // Funci√≥n para cambiar mes en el calendario
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar();
            
            // Actualizar t√≠tulo del mes
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const monthYearDisplay = document.getElementById('currentMonthYear');
            if (monthYearDisplay) {
                monthYearDisplay.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            }
        }

        // Funci√≥n para mostrar el modal de edici√≥n de horarios
        async function showEditScheduleModal() {
            console.log('Mostrando modal de edici√≥n de horarios...');
            
            // Cargar horarios actuales
            await loadCurrentSchedules();
            
            // Mostrar modal
            document.getElementById('editScheduleModal').style.display = 'block';
        }
        
        // Funci√≥n para cargar los horarios actuales en el modal
        async function loadCurrentSchedules() {
            try {
                const response = await fetch('/api/horarios', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar horarios');
                }
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    // Mapear horarios por nombre
                    const horariosMap = {};
                    data.data.forEach(horario => {
                        horariosMap[horario.nombre] = horario;
                    });
                    
                    // Actualizar campos del modal
                    if (horariosMap['Centralista Turno Ma√±ana']) {
                        document.getElementById('centralistaMananaEntrada').value = horariosMap['Centralista Turno Ma√±ana'].hora_entrada;
                        document.getElementById('centralistaMananaSalida').value = horariosMap['Centralista Turno Ma√±ana'].hora_salida;
                    }
                    
                    if (horariosMap['Centralista Turno Tarde']) {
                        document.getElementById('centralistaTardeEntrada').value = horariosMap['Centralista Turno Tarde'].hora_entrada;
                        document.getElementById('centralistaTardeSalida').value = horariosMap['Centralista Turno Tarde'].hora_salida;
                    }
                    
                    if (horariosMap['Despachador Turno Ma√±ana']) {
                        document.getElementById('despachadorMananaEntrada').value = horariosMap['Despachador Turno Ma√±ana'].hora_entrada;
                        document.getElementById('despachadorMananaSalida').value = horariosMap['Despachador Turno Ma√±ana'].hora_salida;
                    }
                    
                    if (horariosMap['Despachador Turno Tarde']) {
                        document.getElementById('despachadorTardeEntrada').value = horariosMap['Despachador Turno Tarde'].hora_entrada;
                        document.getElementById('despachadorTardeSalida').value = horariosMap['Despachador Turno Tarde'].hora_salida;
                    }
                    
                    if (horariosMap['Turno Noche']) {
                        document.getElementById('nocheEntrada').value = horariosMap['Turno Noche'].hora_entrada;
                        document.getElementById('nocheSalida').value = horariosMap['Turno Noche'].hora_salida;
                    }
                }
            } catch (error) {
                console.error('Error al cargar horarios actuales:', error);
                showError('Error al cargar horarios actuales');
            }
        }
        
        // Funci√≥n para guardar los cambios de horarios
        async function saveScheduleChanges() {
            try {
                showLoading('Guardando cambios de horarios...');
                
                const horariosToUpdate = [
                    {
                        nombre: 'Centralista Turno Ma√±ana',
                        entrada: document.getElementById('centralistaMananaEntrada').value,
                        salida: document.getElementById('centralistaMananaSalida').value
                    },
                    {
                        nombre: 'Centralista Turno Tarde',
                        entrada: document.getElementById('centralistaTardeEntrada').value,
                        salida: document.getElementById('centralistaTardeSalida').value
                    },
                    {
                        nombre: 'Despachador Turno Ma√±ana',
                        entrada: document.getElementById('despachadorMananaEntrada').value,
                        salida: document.getElementById('despachadorMananaSalida').value
                    },
                    {
                        nombre: 'Despachador Turno Tarde',
                        entrada: document.getElementById('despachadorTardeEntrada').value,
                        salida: document.getElementById('despachadorTardeSalida').value
                    },
                    {
                        nombre: 'Turno Noche',
                        entrada: document.getElementById('nocheEntrada').value,
                        salida: document.getElementById('nocheSalida').value
                    }
                ];
                
                // Actualizar cada horario
                for (const horario of horariosToUpdate) {
                    await updateScheduleTime(horario.nombre, horario.entrada, horario.salida);
                }
                
                showSuccess('Horarios actualizados exitosamente');
                closeModal('editScheduleModal');
                
                // Regenerar calendario
                if (typeof generateCalendar === 'function') {
                    generateCalendar();
                }
                
            } catch (error) {
                console.error('Error al guardar cambios:', error);
                showError('Error al guardar cambios de horarios');
            } finally {
                hideLoading();
            }
        }
        
        // Funci√≥n para actualizar un horario espec√≠fico
        async function updateScheduleTime(nombre, entrada, salida) {
            try {
                // Primero obtener el ID del horario
                const response = await fetch('/api/horarios', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Error al obtener horarios');
                }
                
                const data = await response.json();
                
                if (!data.success || !data.data) {
                    throw new Error('No se pudieron obtener los horarios');
                }
                
                // Buscar el horario por nombre
                const horario = data.data.find(h => h.nombre === nombre);
                
                if (!horario) {
                    console.warn(`Horario ${nombre} no encontrado`);
                    return;
                }
                
                // Actualizar el horario
                const updateResponse = await fetch(`/api/horarios/${horario.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        nombre: horario.nombre,
                        hora_entrada: entrada,
                        hora_salida: salida,
                        dias_semana: horario.dias_semana,
                        descripcion: horario.descripcion
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error(`Error al actualizar ${nombre}`);
                }
                
                console.log(`Horario ${nombre} actualizado exitosamente`);
                
            } catch (error) {
                console.error(`Error al actualizar horario ${nombre}:`, error);
                throw error;
            }
        }

        // Funciones para definir turnos espec√≠ficos de cada empleado seg√∫n el calendario oficial


        // Funci√≥n para obtener la lista actual de empleados
        async function getCurrentEmployees() {
            try {
                console.log('üîç Obteniendo empleados desde la API...');
                const response = await fetch('/api/empleados', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                console.log('üì° Respuesta de empleados:', response.status);
                const data = await response.json();
                console.log('üìä Datos de empleados:', data);
                
                if (data.success && data.data && data.data.length > 0) {
                    const employeeNames = data.data.map(emp => `${emp.nombre} ${emp.apellido}`);
                    console.log('‚úÖ Empleados obtenidos:', employeeNames);
                    return employeeNames;
                } else {
                    console.log('‚ö†Ô∏è No hay empleados en la respuesta o respuesta fallida');
                }
            } catch (error) {
                console.error('‚ùå Error al obtener empleados:', error);
            }
            
            // Fallback a lista vac√≠a si no hay empleados cargados
            console.log('üîÑ No hay empleados registrados, devolviendo lista vac√≠a');
            return [];
        }


        // Funci√≥n para generar resumen semanal
        function generateWeeklySummary() {
            console.log('Generando resumen semanal...');
            const tbody = document.getElementById('weeklySummaryTable');
            tbody.innerHTML = '';
            
            // Generar resumen para las pr√≥ximas 5 semanas
            for (let week = 0; week < 5; week++) {
                // Fila para Central de Transporte
                const centralRow = document.createElement('tr');
                
                // Nombre del empleado de Central de Transporte
                const centralEmployeeCell = document.createElement('td');
                const centralEmployee = getEmployeeName((week % 2) + 1);
                centralEmployeeCell.textContent = `${centralEmployee} - Central Transporte`;
                centralRow.appendChild(centralEmployeeCell);
                
                // Turnos para cada semana - Central de Transporte
                for (let weekNum = 0; weekNum < 5; weekNum++) {
                    const shiftIndex = (weekNum + week) % 2;
                    const shift = getCentralTransporteShift(shiftIndex);
                    
                    const shiftCell = document.createElement('td');
                    shiftCell.className = `summary-cell ${shift.class}`;
                    shiftCell.textContent = shift.name;
                    centralRow.appendChild(shiftCell);
                }
                
                // Horas totales - Central de Transporte (44 horas)
                const centralTotalCell = document.createElement('td');
                centralTotalCell.className = 'summary-cell total-hours';
                centralTotalCell.textContent = '44 hrs';
                centralRow.appendChild(centralTotalCell);
                
                tbody.appendChild(centralRow);
                
                // Fila para Despacho Central
                const despachoRow = document.createElement('tr');
                
                // Nombre del empleado de Despacho Central
                const despachoEmployeeCell = document.createElement('td');
                const despachoEmployee = getEmployeeName((week % 2) + 3);
                despachoEmployeeCell.textContent = `${despachoEmployee} - Despacho Central`;
                despachoRow.appendChild(despachoEmployeeCell);
                
                // Turnos para cada semana - Despacho Central
                for (let weekNum = 0; weekNum < 5; weekNum++) {
                    const shiftIndex = (weekNum + week) % 2;
                    const shift = getDespachoCentralShift(shiftIndex);
                    
                    const shiftCell = document.createElement('td');
                    shiftCell.className = `summary-cell ${shift.class}`;
                    shiftCell.textContent = shift.name;
                    despachoRow.appendChild(shiftCell);
                }
                
                // Horas totales - Despacho Central (44 horas)
                const despachoTotalCell = document.createElement('td');
                despachoTotalCell.className = 'summary-cell total-hours';
                despachoTotalCell.textContent = '44 hrs';
                despachoRow.appendChild(despachoTotalCell);
                
                tbody.appendChild(despachoRow);
                
                // Fila para Turno Noche
                const nocheRow = document.createElement('tr');
                
                // Nombre del empleado de Turno Noche
                const nocheEmployeeCell = document.createElement('td');
                const nocheIndex = week % 5;
                const nocheShift = getTurnoNocheShift(nocheIndex);
                nocheEmployeeCell.textContent = nocheShift.name;
                nocheRow.appendChild(nocheEmployeeCell);
                
                // Turnos para cada semana - Turno Noche
                for (let weekNum = 0; weekNum < 5; weekNum++) {
                    const shiftIndex = (weekNum + week) % 5;
                    const shift = getTurnoNocheShift(shiftIndex);
                    
                    const shiftCell = document.createElement('td');
                    shiftCell.className = `summary-cell ${shift.class}`;
                    shiftCell.textContent = 'Turno Noche';
                    nocheRow.appendChild(shiftCell);
                }
                
                // Horas totales - Turno Noche (44 horas)
                const nocheTotalCell = document.createElement('td');
                nocheTotalCell.className = 'summary-cell total-hours';
                nocheTotalCell.textContent = '44 hrs';
                nocheRow.appendChild(nocheTotalCell);
                
                tbody.appendChild(nocheRow);
            }
        }

        // Funci√≥n para exportar horarios
        function exportSchedule() {
            console.log('Exportando horarios...');
            const data = {
                month: currentDate.getMonth() + 1,
                year: currentDate.getFullYear(),
                schedule: rotationSchedule,
                generated: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `horarios_${currentDate.getFullYear()}_${currentDate.getMonth() + 1}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Horarios exportados exitosamente');
        }
    </script>
</body>
</html>
