<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Sistema de Asistencia</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #F8FAFC;
            color: #1E293B;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 30px 20px;
            border-bottom: 1px solid #E2E8F0;
            text-align: center;
        }

        .sidebar-header h2 {
            color: #667eea;
            font-size: 20px;
            font-weight: 700;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            padding: 15px 25px;
            color: #64748B;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #F1F5F9;
            color: #667eea;
            border-left-color: #667eea;
        }

        .nav-item i {
            width: 20px;
            margin-right: 12px;
        }

        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #1E293B;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .logout-btn {
            background: #EF4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: #DC2626;
        }

        .content {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .stat-icon.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.success { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .stat-icon.warning { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
        .stat-icon.info { background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1E293B;
        }

        .stat-label {
            color: #64748B;
            font-size: 14px;
            margin-top: 5px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1E293B;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #E2E8F0;
        }

        .data-table th {
            background: #F8FAFC;
            font-weight: 600;
            color: #475569;
        }

        .data-table tr:hover {
            background: #F8FAFC;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-active {
            background: #D1FAE5;
            color: #065F46;
        }

        .badge-inactive {
            background: #FEE2E2;
            color: #991B1B;
        }

        .badge-pending {
            background: #FEF3C7;
            color: #92400E;
        }

        .badge-approved {
            background: #D1FAE5;
            color: #065F46;
        }

        .badge-rejected {
            background: #FEE2E2;
            color: #991B1B;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1E293B;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: #64748B;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #A7F3D0;
        }

        .alert-error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FECACA;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748B;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block;
            }

            .content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Estilos para el calendario de turnos */
        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            margin-bottom: 10px;
        }

        .day-header {
            background: #F8FAFC;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            color: #64748B;
            border-radius: 8px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
        }

        .calendar-day {
            min-height: 120px;
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
            padding: 10px;
            border-radius: 8px;
            position: relative;
            transition: all 0.3s ease;
        }

        .calendar-day:hover {
            background: #F1F5F9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .calendar-day.other-month {
            background: #F1F5F9;
            color: #94A3B8;
        }

        .calendar-day.today {
            background: #EFF6FF;
            border-color: #3B82F6;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1E293B;
        }

        .day-number.other-month {
            color: #94A3B8;
        }

        .shift-assignment {
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .shift-assignment.central-transporte-manana {
            background: #4CAF50;
        }

        /* Estilos para el calendario oficial */
        .official-calendar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 20px 0;
        }

        .calendar-header h2 {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: #1E293B;
            margin: 20px 0;
            text-transform: uppercase;
        }

        .calendar-days-header {
            display: grid;
            grid-template-columns: 200px repeat(7, 1fr);
            gap: 2px;
            background: #F1F5F9;
            padding: 10px;
        }

        .day-header {
            text-align: center;
            font-weight: 600;
            color: #475569;
            padding: 8px;
            font-size: 12px;
        }

        .calendar-days-numbers {
            display: grid;
            grid-template-columns: 200px repeat(7, 1fr);
            gap: 2px;
            background: #F8FAFC;
            padding: 0 10px 10px 10px;
        }

        .day-number {
            text-align: center;
            font-weight: 600;
            color: #1E293B;
            padding: 8px;
            font-size: 14px;
        }

        .day-number.special-day {
            color: #DC2626;
            font-weight: 700;
        }

        .calendar-employees {
            background: white;
        }

        .employee-row {
            display: grid;
            grid-template-columns: 200px repeat(7, 1fr);
            gap: 2px;
            border-bottom: 1px solid #E2E8F0;
            min-height: 60px;
        }

        .employee-row:last-child {
            border-bottom: none;
        }

        .employee-info {
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-right: 2px solid #E2E8F0;
        }

        .employee-info.purple {
            background: #F3E8FF;
            border-left: 4px solid #800080;
        }

        .employee-info.blue {
            background: #EFF6FF;
            border-left: 4px solid #0000FF;
        }

        .employee-info.black {
            background: #F3F4F6;
            border-left: 4px solid #000000;
        }

        .employee-info.orange {
            background: #FFF7ED;
            border-left: 4px solid #FFA500;
        }

        .employee-info.green {
            background: #F0FDF4;
            border-left: 4px solid #00FF00;
        }

        .employee-info.yellow {
            background: #FEFCE8;
            border-left: 4px solid #FFFF00;
        }

        .employee-name {
            font-weight: 700;
            color: #1E293B;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .employee-shift {
            font-size: 12px;
            color: #64748B;
            font-weight: 500;
        }

        .employee-schedule {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .shift-cell {
            min-height: 60px;
            border: 1px solid #E2E8F0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .shift-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .shift-cell.orange-shift {
            background-color: #FFA500;
            border-color: #E67E22;
        }

        .shift-cell.green-shift {
            background-color: #00FF00;
            border-color: #27AE60;
        }

        .shift-cell.yellow-shift {
            background-color: #FFFF00;
            border-color: #F1C40F;
        }

        .shift-cell.blue-shift {
            background-color: #0000FF;
            border-color: #2980B9;
        }

        .shift-cell.purple-shift {
            background-color: #800080;
            border-color: #8E44AD;
        }

        .shift-cell.black-shift {
            background-color: #000000;
            border-color: #2C3E50;
        }

        .shift-cell.red-shift {
            background-color: #FF0000;
            border-color: #E74C3C;
        }

        .shift-cell.no-shift {
            background-color: #FFFFFF;
            border-color: #E2E8F0;
        }

        .shift-cell.holiday {
            background-color: #FF0000;
            border-color: #E74C3C;
            position: relative;
        }

        .shift-cell.holiday::after {
            content: "FERIADO";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
        }

        .no-employees-message {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            background: #F8F9FA;
            border-radius: 12px;
            margin: 20px;
            border: 2px dashed #DEE2E6;
        }

        .message-content {
            text-align: center;
            color: #6C757D;
        }

        .message-content i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #ADB5BD;
        }

        .message-content h3 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .message-content p {
            font-size: 16px;
            margin-bottom: 24px;
            color: #6C757D;
        }

        .message-content .btn {
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
        }

        .shift-assignment.central-transporte-tarde {
            background: #FF9800;
        }

        .shift-assignment.despacho-central-manana {
            background: #2196F3;
        }

        .shift-assignment.despacho-central-tarde {
            background: #9C27B0;
        }

        .shift-assignment.turno-noche {
            background: #607D8B;
        }

        .schedule-legend {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .schedule-legend h4 {
            margin-bottom: 15px;
            color: #1E293B;
            font-weight: 600;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .legend-item span:last-child {
            font-size: 14px;
            color: #64748B;
        }

        /* Estilos para el resumen semanal */
        .weekly-summary {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .weekly-summary h3 {
            margin-bottom: 15px;
            color: #1E293B;
            font-weight: 600;
        }

        .summary-cell {
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .summary-cell.central-transporte-manana {
            background: #E8F5E8;
            color: #2E7D32;
        }

        .summary-cell.central-transporte-tarde {
            background: #FFF3E0;
            color: #E65100;
        }

        .summary-cell.despacho-central-manana {
            background: #E3F2FD;
            color: #1565C0;
        }

        .summary-cell.despacho-central-tarde {
            background: #F3E5F5;
            color: #7B1FA2;
        }

        .summary-cell.turno-noche {
            background: #ECEFF1;
            color: #455A64;
        }

        .summary-cell.total-hours {
            background: #E8F5E8;
            color: #2E7D32;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-cog"></i> Administraci√≥n</h2>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" data-section="dashboard">
                <i class="fas fa-chart-pie"></i> Dashboard
            </a>
            <a href="#" class="nav-item" data-section="employees">
                <i class="fas fa-users"></i> Empleados
            </a>
            <a href="#" class="nav-item" data-section="roles">
                <i class="fas fa-user-tag"></i> Roles
            </a>
            <a href="#" class="nav-item" data-section="schedules">
                <i class="fas fa-clock"></i> Horarios
            </a>
            <a href="#" class="nav-item" data-section="attendance">
                <i class="fas fa-calendar-check"></i> Asistencia
            </a>
            <a href="#" class="nav-item" data-section="vacations">
                <i class="fas fa-plane"></i> Vacaciones
            </a>

            <a href="#" class="nav-item" data-section="dias-libres">
                <i class="fas fa-calendar-times"></i> D√≠as Libres
            </a>
            <a href="#" class="nav-item" data-section="reports">
                <i class="fas fa-chart-bar"></i> Reportes
            </a>
            <a href="#" class="nav-item" data-section="profile">
                <i class="fas fa-user"></i> Mi Perfil
            </a>
            <a href="#" class="nav-item" data-section="liquidaciones">
                <i class="fas fa-file-invoice-dollar"></i> Liquidaciones
            </a>
        </nav>
    </div>

    <div class="main-content">
        <header class="header">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="pageTitle">Dashboard</h1>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <span id="userName">Administrador</span>
                <button class="logout-btn" onclick="logout()" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </header>

        <div class="content">
            <div class="alert alert-success" id="successAlert"></div>
            <div class="alert alert-error" id="errorAlert"></div>

            <!-- Dashboard Section -->
            <div id="dashboardSection">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon primary">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalEmployees">0</div>
                        <div class="stat-label">Empleados Activos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon success">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="todayAttendance">0</div>
                        <div class="stat-label">Asistencias Hoy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon warning">
                                <i class="fas fa-plane"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="pendingVacations">0</div>
                        <div class="stat-label">Vacaciones Pendientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon info">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalHours">0h</div>
                        <div class="stat-label">Horas Trabajadas</div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Actividad Reciente</h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Empleado</th>
                                    <th>Acci√≥n</th>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivityTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Employees Section -->
            <div id="employeesSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">
                        Gesti√≥n de Empleados
                        <button class="btn btn-primary" onclick="showAddEmployeeModal()">
                            <i class="fas fa-plus"></i> Nuevo Empleado
                        </button>
                    </h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Rol</th>
                                    <th>Colaci√≥n (min)</th>
                                    <th>Estado</th>
                                    <th>Fecha Contrataci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="employeesTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Roles Section -->
            <div id="rolesSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">
                        Gesti√≥n de Roles
                        <button class="btn btn-primary" onclick="showAddRoleModal()">
                            <i class="fas fa-plus"></i> Nuevo Rol
                        </button>
                    </h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Descripci√≥n</th>
                                    <th>Permisos</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="rolesTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Schedules Section -->
            <div id="schedulesSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">
                        Gesti√≥n de Horarios
                        <button class="btn btn-primary" onclick="showAddScheduleModal()">
                            <i class="fas fa-plus"></i> Nuevo Horario
                        </button>
                    </h2>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Entrada</th>
                                    <th>Salida</th>
                                    <th>D√≠as</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="schedulesTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Attendance Section -->
            <div id="attendanceSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">Asistencia de Empleados</h2>
                    
                    <!-- Filtros de asistencia -->
                    <div class="filters-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Fecha Inicio</label>
                            <input type="date" id="attendanceDateFrom" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Fecha Fin</label>
                            <input type="date" id="attendanceDateTo" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Empleado</label>
                            <select id="attendanceEmployeeFilter" class="form-control">
                                <option value="">Todos los empleados</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: end;">
                            <button class="btn btn-primary" onclick="loadAttendanceData()">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                    </div>

                    <!-- Tabla de asistencia -->
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Empleado</th>
                                    <th>Fecha</th>
                                    <th>Hora Entrada</th>
                                    <th>Hora Salida</th>
                                    <th>Horas Trabajadas</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTable">
                                <!-- Los datos se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="section">
                    <h2 class="section-title">Calendario de Turnos</h2>
                    
                    <!-- Controles del calendario -->
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center;">
                        <button class="btn btn-secondary" onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i> Mes Anterior
                        </button>
                        <h3 id="currentMonth" style="margin: 0; min-width: 200px; text-align: center;"></h3>
                        <button class="btn btn-secondary" onclick="nextMonth()">
                            Mes Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                        <button class="btn btn-primary" onclick="generateRotatingSchedule()">
                            <i class="fas fa-sync"></i> Generar Rotaci√≥n
                        </button>
                        <button class="btn btn-success" onclick="exportSchedule()">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>

                    <!-- Calendario de turnos -->
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <div class="day-header">Lun</div>
                            <div class="day-header">Mar</div>
                            <div class="day-header">Mi√©</div>
                            <div class="day-header">Jue</div>
                            <div class="day-header">Vie</div>
                            <div class="day-header">S√°b</div>
                            <div class="day-header">Dom</div>
                        </div>
                        <div id="calendarGrid" class="calendar-grid">
                            <!-- El calendario se generar√° din√°micamente -->
                        </div>
                    </div>

                    <!-- Leyenda de turnos -->
                    <div class="schedule-legend" style="margin-top: 20px;">
                        <h4>Leyenda de Turnos:</h4>
                        <div class="legend-items">
                            <div class="legend-item">
                                <span class="legend-color" style="background-color: #4CAF50;"></span>
                                <span>Central Transporte - Ma√±ana (07:00-16:00) - Lunes a Domingo</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background-color: #FF9800;"></span>
                                <span>Central Transporte - Tarde (16:00-23:30) - Lunes a Domingo</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background-color: #2196F3;"></span>
                                <span>Despacho Central - Ma√±ana (07:00-15:00) - Lunes a S√°bado</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background-color: #9C27B0;"></span>
                                <span>Despacho Central - Tarde (15:00-23:00) - Lunes a S√°bado</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color" style="background-color: #607D8B;"></span>
                                <span>Turno Noche (23:30-07:30) - Lunes a Domingo (24/7)</span>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: #F8FAFC; border-radius: 8px; border-left: 4px solid #3B82F6;">
                            <strong>üìã Informaci√≥n del Sistema:</strong><br>
                            ‚Ä¢ Siempre hay 3 personas trabajando al mismo tiempo<br>
                            ‚Ä¢ Central de Transporte: 1 persona (Lunes a Domingo)<br>
                            ‚Ä¢ Despacho Central: 1 persona (Lunes a S√°bado)<br>
                            ‚Ä¢ Turno Noche: 1 persona (Lunes a Domingo - 24/7)<br>
                            ‚Ä¢ Total: 5 empleados rotando entre los 3 turnos<br>
                            ‚Ä¢ Todos los empleados trabajan 44 horas semanales<br>
                            ‚Ä¢ Turno Noche: Rotaci√≥n entre Empleado 1, Empleado 2, Empleado 3, Empleado 4 y Empleado 5
                        </div>
                    </div>

                    <!-- Tabla de resumen semanal -->
                    <div class="table-container" style="margin-top: 30px;">
                        <h3>Resumen Semanal de Turnos</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Empleado</th>
                                    <th>Semana 1</th>
                                    <th>Semana 2</th>
                                    <th>Semana 3</th>
                                    <th>Semana 4</th>
                                    <th>Semana 5</th>
                                    <th>Horas Totales</th>
                                </tr>
                            </thead>
                            <tbody id="weeklySummaryTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Vacations Section -->
            <div id="vacationsSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">Gesti√≥n de Vacaciones</h2>
                    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                        <select id="vacationStatusFilter" class="form-control" style="width: auto;">
                            <option value="">Todos los estados</option>
                            <option value="pendiente">Pendientes</option>
                            <option value="aprobado">Aprobadas</option>
                            <option value="rechazado">Rechazadas</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadVacationsData()">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Empleado</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Fin</th>
                                    <th>D√≠as</th>
                                    <th>Estado</th>
                                    <th>Motivo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="vacationsTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profileSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">Mi Perfil</h2>
                    
                    <div class="profile-container" style="display: flex; gap: 30px; align-items: flex-start;">
                        <!-- Foto de perfil -->
                        <div class="profile-photo-section" style="flex: 0 0 200px;">
                            <div class="profile-photo-container" style="text-align: center;">
                                <div class="profile-photo" id="profilePhoto" style="width: 150px; height: 150px; border-radius: 50%; background: #E2E8F0; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; border: 3px solid #CBD5E1; overflow: hidden;">
                                    <i class="fas fa-user" style="font-size: 60px; color: #94A3B8;"></i>
                                </div>
                                <input type="file" id="photoInput" accept="image/*" style="display: none;">
                                <button class="btn" onclick="document.getElementById('photoInput').click()" style="background: #3B82F6; color: white; margin-bottom: 10px;">
                                    <i class="fas fa-camera"></i> Cambiar Foto
                                </button>
                                <button class="btn" onclick="removeProfilePhoto()" style="background: #EF4444; color: white; display: none;" id="removePhotoBtn">
                                    <i class="fas fa-trash"></i> Eliminar Foto
                                </button>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n del perfil -->
                        <div class="profile-info" style="flex: 1;">
                            <div class="info-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <h3 style="margin-top: 0; color: #1E293B;">Informaci√≥n Personal</h3>
                                <div class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="info-item">
                                        <label style="font-weight: 600; color: #475569;">Nombre:</label>
                                        <p id="profileName" style="margin: 5px 0; color: #1E293B;"></p>
                                    </div>
                                    <div class="info-item">
                                        <label style="font-weight: 600; color: #475569;">Apellido:</label>
                                        <p id="profileLastName" style="margin: 5px 0; color: #1E293B;"></p>
                                    </div>
                                    <div class="info-item">
                                        <label style="font-weight: 600; color: #475569;">Email:</label>
                                        <p id="profileEmail" style="margin: 5px 0; color: #1E293B;"></p>
                                    </div>
                                    <div class="info-item">
                                        <label style="font-weight: 600; color: #475569;">Tel√©fono:</label>
                                        <p id="profilePhone" style="margin: 5px 0; color: #1E293B;"></p>
                                    </div>
                                    <div class="info-item">
                                        <label style="font-weight: 600; color: #475569;">Rol:</label>
                                        <p id="profileRole" style="margin: 5px 0; color: #1E293B;"></p>
                                    </div>
                                    <div class="info-item">
                                        <label style="font-weight: 600; color: #475569;">Fecha de Contrataci√≥n:</label>
                                        <p id="profileHireDate" style="margin: 5px 0; color: #1E293B;"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Liquidaciones Section -->
            <div id="liquidacionesSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">
                        Gesti√≥n de Liquidaciones
                        <button class="btn btn-primary" onclick="showUploadPayrollModal()">
                            <i class="fas fa-upload"></i> Subir Liquidaci√≥n
                        </button>
                    </h2>
                    
                    <!-- Filtros -->
                    <div class="filters" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div class="form-group" style="margin: 0;">
                            <label>Empleado:</label>
                            <select id="payrollEmployeeFilter" onchange="filterPayrolls()">
                                <option value="">Todos los empleados</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>A√±o:</label>
                            <select id="payrollYearFilter" onchange="filterPayrolls()">
                                <option value="">Todos los a√±os</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Mes:</label>
                            <select id="payrollMonthFilter" onchange="filterPayrolls()">
                                <option value="">Todos los meses</option>
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tabla de liquidaciones -->
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Empleado</th>
                                    <th>Per√≠odo</th>
                                    <th>Archivo</th>
                                    <th>Tama√±o</th>
                                    <th>Subido por</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="payrollsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" style="display: none;">
                <div class="section">
                    <h2 class="section-title">Generar Reportes</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="stat-card">
                            <h3>Reporte de Asistencia</h3>
                            <div class="form-group">
                                <label>Fecha Inicio</label>
                                <input type="date" id="reportAttendanceFrom" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Fecha Fin</label>
                                <input type="date" id="reportAttendanceTo" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Empleado</label>
                                <select id="reportAttendanceEmployee" class="form-control">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="generateAttendanceReport()">
                                <i class="fas fa-download"></i> Generar Reporte
                            </button>
                        </div>
                        
                        <div class="stat-card">
                            <h3>Reporte de Horas</h3>
                            <div class="form-group">
                                <label>Fecha Inicio</label>
                                <input type="date" id="reportHoursFrom" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Fecha Fin</label>
                                <input type="date" id="reportHoursTo" class="form-control">
                            </div>
                            <button class="btn btn-primary" onclick="generateHoursReport()">
                                <i class="fas fa-download"></i> Generar Reporte
                            </button>
                        </div>
                        
                        <div class="stat-card">
                            <h3>Reporte de Vacaciones</h3>
                            <div class="form-group">
                                <label>A√±o</label>
                                <select id="reportVacationYear" class="form-control">
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="generateVacationReport()">
                                <i class="fas fa-download"></i> Generar Reporte
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar empleado -->
    <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agregar Nuevo Empleado</h3>
                <span class="close" onclick="closeModal('addEmployeeModal')">&times;</span>
            </div>
            <form id="addEmployeeForm">
                <div class="form-group">
                    <label for="employeeName">Nombre</label>
                    <input type="text" id="employeeName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="employeeLastName">Apellido</label>
                    <input type="text" id="employeeLastName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="employeeEmail">Email</label>
                    <input type="email" id="employeeEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="employeePhone">Tel√©fono</label>
                    <input type="tel" id="employeePhone" class="form-control">
                </div>
                <div class="form-group">
                    <label for="employeeRole">Rol</label>
                    <select id="employeeRole" class="form-control" required>
                        <option value="">Seleccionar rol...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="employeePassword">Contrase√±a</label>
                    <input type="password" id="employeePassword" class="form-control" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal('addEmployeeModal')" style="background: #6B7280; color: white;">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar Empleado</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar rol -->
    <div id="addRoleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agregar Nuevo Rol</h3>
                <span class="close" onclick="closeModal('addRoleModal')">&times;</span>
            </div>
            <form id="addRoleForm">
                <div class="form-group">
                    <label for="roleName">Nombre del Rol</label>
                    <input type="text" id="roleName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="roleDescription">Descripci√≥n</label>
                    <textarea id="roleDescription" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="rolePermissions">Permisos</label>
                    <select id="rolePermissions" class="form-control" required>
                        <option value="admin">Administrador</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="empleado">Empleado</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal('addRoleModal')" style="background: #6B7280; color: white;">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar Rol</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar horario -->
    <div id="addScheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agregar Nuevo Horario</h3>
                <span class="close" onclick="closeModal('addScheduleModal')">&times;</span>
            </div>
            <form id="addScheduleForm">
                <div class="form-group">
                    <label for="scheduleName">Nombre del Horario</label>
                    <input type="text" id="scheduleName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="scheduleStartTime">Hora de Entrada</label>
                    <input type="time" id="scheduleStartTime" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="scheduleEndTime">Hora de Salida</label>
                    <input type="time" id="scheduleEndTime" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>D√≠as de la Semana</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                        <label><input type="checkbox" value="1" class="scheduleDays"> Lunes</label>
                        <label><input type="checkbox" value="2" class="scheduleDays"> Martes</label>
                        <label><input type="checkbox" value="3" class="scheduleDays"> Mi√©rcoles</label>
                        <label><input type="checkbox" value="4" class="scheduleDays"> Jueves</label>
                        <label><input type="checkbox" value="5" class="scheduleDays"> Viernes</label>
                        <label><input type="checkbox" value="6" class="scheduleDays"> S√°bado</label>
                        <label><input type="checkbox" value="0" class="scheduleDays"> Domingo</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="scheduleDescription">Descripci√≥n</label>
                    <textarea id="scheduleDescription" class="form-control" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal('addScheduleModal')" style="background: #6B7280; color: white;">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar Horario</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para asignar horario a empleado -->
    <div id="assignScheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Asignar Horario a Empleado</h3>
                <span class="close" onclick="closeModal('assignScheduleModal')">&times;</span>
            </div>
            <form id="assignScheduleForm">
                <div class="form-group">
                    <label for="assignEmployee">Empleado</label>
                    <select id="assignEmployee" class="form-control" required>
                        <option value="">Seleccionar empleado...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assignSchedule">Horario</label>
                    <select id="assignSchedule" class="form-control" required>
                        <option value="">Seleccionar horario...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assignStartDate">Fecha de Inicio</label>
                    <input type="date" id="assignStartDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="assignEndDate">Fecha de Fin (opcional)</label>
                    <input type="date" id="assignEndDate" class="form-control">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal('assignScheduleModal')" style="background: #6B7280; color: white;">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Asignar Horario</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para subir liquidaci√≥n -->
    <div id="uploadPayrollModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Subir Liquidaci√≥n de Sueldo</h3>
                <span class="close" onclick="closeModal('uploadPayrollModal')">&times;</span>
            </div>
            <form id="uploadPayrollForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="payrollEmployee">Empleado *</label>
                    <select id="payrollEmployee" class="form-control" required>
                        <option value="">Seleccionar empleado...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payrollPeriod">Per√≠odo *</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="payrollMonth" class="form-control" required style="flex: 1;">
                            <option value="">Mes</option>
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                        <select id="payrollYear" class="form-control" required style="flex: 1;">
                            <option value="">A√±o</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="payrollFile">Archivo de Liquidaci√≥n *</label>
                    <input type="file" id="payrollFile" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx" required>
                    <small style="color: #666;">Formatos permitidos: PDF, DOC, DOCX, XLS, XLSX (m√°ximo 10MB)</small>
                </div>
                <div class="form-group">
                    <label for="payrollObservations">Observaciones</label>
                    <textarea id="payrollObservations" class="form-control" rows="3" placeholder="Observaciones adicionales (opcional)"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('uploadPayrollModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Subir Liquidaci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para editar tiempo de colaci√≥n -->
    <div id="editBreakTimeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Editar Tiempo de Colaci√≥n</h3>
                <span class="close" onclick="closeModal('editBreakTimeModal')">&times;</span>
            </div>
            <form id="editBreakTimeForm">
                <div class="form-group">
                    <label for="breakTimeEmployee">Empleado</label>
                    <input type="text" id="breakTimeEmployee" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="breakTimeMinutes">Tiempo de Colaci√≥n (minutos)</label>
                    <input type="number" id="breakTimeMinutes" class="form-control" min="0" max="120" required>
                    <small style="color: #666;">Rango permitido: 0 - 120 minutos</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editBreakTimeModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let employees = [];
        let roles = [];
        let schedules = [];

        // Inicializar aplicaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Inicializando aplicaci√≥n...');
            await checkAuth();
            await loadUserData();
            await loadDashboardData();
            await loadRoles();
            await loadSchedules();
            setupEventListeners();
            initializeDateInputs();
            console.log('Aplicaci√≥n inicializada correctamente');
        });

        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/';
                return;
            }

            try {
                const response = await fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/';
                    return;
                }

                const data = await response.json();
                currentUser = data.user;

                if (currentUser.permisos !== 'admin') {
                    window.location.href = '/dashboard';
                    return;
                }
            } catch (error) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/';
            }
        }

        async function loadUserData() {
            if (currentUser) {
                document.getElementById('userName').textContent = `${currentUser.nombre} ${currentUser.apellido}`;
                document.getElementById('userAvatar').textContent = currentUser.nombre.charAt(0);
            }
        }

        async function loadDashboardData() {
            try {
                const response = await fetch('/api/empleados/stats/overview', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateDashboardStats(data.data);
                }
            } catch (error) {
                showError('Error al cargar datos del dashboard');
            }
        }

        function updateDashboardStats(stats) {
            document.getElementById('totalEmployees').textContent = stats.empleadosActivos;
            document.getElementById('todayAttendance').textContent = stats.asistenciasHoy;
            document.getElementById('pendingVacations').textContent = stats.vacacionesPendientes;
        }

        async function loadRoles() {
            try {
                console.log('Cargando roles para selects...');
                const response = await fetch('/api/roles', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                console.log('Respuesta de roles para selects:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Datos de roles para selects:', data);
                    roles = data.data;
                    populateRoleSelect();
                } else {
                    console.error('Error en respuesta de roles para selects:', response.status);
                    showError('Error al cargar roles');
                }
            } catch (error) {
                console.error('Error al cargar roles para selects:', error);
                showError('Error al cargar roles: ' + error.message);
            }
        }

        function populateRoleSelect() {
            console.log('Poblando select de roles...');
            const select = document.getElementById('employeeRole');
            if (!select) {
                console.error('No se encontr√≥ el elemento employeeRole');
                return;
            }
            select.innerHTML = '<option value="">Seleccionar rol...</option>';
            console.log('Roles disponibles:', roles.length);
            roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id;
                option.textContent = role.nombre;
                select.appendChild(option);
            });
        }

        async function loadEmployees() {
            try {
                console.log('Cargando empleados...');
                const response = await fetch('/api/empleados', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                console.log('Respuesta de empleados:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Datos de empleados:', data);
                    employees = data.data;
                    updateEmployeesTable();
                } else {
                    console.error('Error en respuesta:', response.status);
                    showError('Error al cargar empleados');
                }
            } catch (error) {
                console.error('Error al cargar empleados:', error);
                showError('Error al cargar empleados: ' + error.message);
            }
        }

        function updateEmployeesTable() {
            console.log('Actualizando tabla de empleados...');
            const tbody = document.getElementById('employeesTable');
            if (!tbody) {
                console.error('No se encontr√≥ el elemento employeesTable');
                return;
            }
            tbody.innerHTML = '';

            console.log('Empleados a mostrar:', employees.length);
            employees.forEach(employee => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${employee.nombre} ${employee.apellido}</td>
                    <td>${employee.email}</td>
                    <td>${employee.rol_nombre || 'Sin rol'}</td>
                    <td>
                        <span class="break-time" style="display: inline-block; min-width: 40px; text-align: center; background: #E5E7EB; padding: 2px 6px; border-radius: 4px; font-size: 12px;">
                            ${employee.tiempo_colacion || 30}
                        </span>
                        <button class="btn btn-sm btn-outline-primary" onclick="editBreakTime(${employee.id}, ${employee.tiempo_colacion || 30})" style="margin-left: 5px; padding: 2px 6px; font-size: 10px;" title="Editar tiempo de colaci√≥n">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                    <td><span class="status-badge ${employee.activo ? 'badge-active' : 'badge-inactive'}">${employee.activo ? 'Activo' : 'Inactivo'}</span></td>
                    <td>${formatDate(employee.fecha_contratacion)}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editEmployee(${employee.id})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteEmployee(${employee.id})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Actualizar selects de empleados
            populateEmployeeSelects();
        }

        async function loadRolesTable() {
            try {
                console.log('Cargando roles...');
                const response = await fetch('/api/roles', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                console.log('Respuesta de roles:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Datos de roles:', data);
                    updateRolesTable(data.data);
                } else {
                    console.error('Error en respuesta de roles:', response.status);
                    showError('Error al cargar roles');
                }
            } catch (error) {
                console.error('Error al cargar roles:', error);
                showError('Error al cargar roles: ' + error.message);
            }
        }

        function updateRolesTable(rolesData) {
            console.log('Actualizando tabla de roles...');
            const tbody = document.getElementById('rolesTable');
            if (!tbody) {
                console.error('No se encontr√≥ el elemento rolesTable');
                return;
            }
            tbody.innerHTML = '';

            console.log('Roles a mostrar:', rolesData.length);
            rolesData.forEach(role => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${role.nombre}</td>
                    <td>${role.descripcion || '-'}</td>
                    <td>${role.permisos}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editRole(${role.id})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteRole(${role.id})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function setupEventListeners() {
            // Navegaci√≥n del sidebar
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = item.dataset.section;
                    showSection(section);
                    
                    // Actualizar clase activa
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                });
            });

            // Men√∫ m√≥vil
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('open');
            });

            // Formulario de empleado
            document.getElementById('addEmployeeForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Formulario de empleado enviado');
                await addEmployee();
            });

            // Formulario de rol
            document.getElementById('addRoleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addRole();
            });

            // Formulario de horario
            document.getElementById('addScheduleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addSchedule();
            });

            // Formulario de asignar horario
            document.getElementById('assignScheduleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await assignSchedule();
            });

            // Bot√≥n de logout
            document.getElementById('logoutBtn').addEventListener('click', (e) => {
                e.preventDefault();
                console.log('Bot√≥n de logout clickeado');
                logout();
            });
        }

        function showSection(section) {
            console.log('Mostrando secci√≥n:', section);
            // Ocultar todas las secciones
            document.querySelectorAll('[id$="Section"]').forEach(sec => {
                sec.style.display = 'none';
            });

            // Mostrar secci√≥n seleccionada
            const targetSection = document.getElementById(section + 'Section');
            if (!targetSection) {
                console.error('No se encontr√≥ la secci√≥n:', section + 'Section');
                return;
            }
            targetSection.style.display = 'block';
            document.getElementById('pageTitle').textContent = getSectionTitle(section);

            // Cargar datos espec√≠ficos de la secci√≥n
            if (section === 'employees') {
                console.log('Cargando datos de empleados...');
                loadEmployees();
            } else if (section === 'roles') {
                console.log('Cargando datos de roles...');
                loadRolesTable();
            } else if (section === 'schedules') {
                console.log('Cargando datos de horarios...');
                loadSchedulesTable();
            } else if (section === 'attendance') {
                console.log('Cargando datos de asistencia...');
                loadAttendanceData();
            } else if (section === 'vacations') {
                console.log('Cargando datos de vacaciones...');
                loadVacationsData();
            } else if (section === 'profile') {
                console.log('Cargando datos del perfil...');
                loadProfileData();
            } else if (section === 'liquidaciones') {
                console.log('Cargando datos de liquidaciones...');
                loadPayrollsData();
            }
        }

        function getSectionTitle(section) {
            const titles = {
                dashboard: 'Dashboard',
                employees: 'Empleados',
                roles: 'Roles',
                schedules: 'Horarios',
                attendance: 'Asistencia',
                vacations: 'Vacaciones',
                reports: 'Reportes',
                profile: 'Mi Perfil',
                liquidaciones: 'Liquidaciones'
            };
            return titles[section] || 'Dashboard';
        }

        function showAddEmployeeModal() {
            // Resetear el formulario y t√≠tulo
            const form = document.getElementById('addEmployeeForm');
            form.reset();
            form.dataset.editingId = ''; // Limpiar el ID de edici√≥n
            document.querySelector('#addEmployeeModal .modal-title').textContent = 'Agregar Nuevo Empleado';
            
            // Resetear el bot√≥n de submit
            const submitBtn = document.querySelector('#addEmployeeForm button[type="submit"]');
            submitBtn.textContent = 'Agregar Empleado';
            
            document.getElementById('addEmployeeModal').style.display = 'block';
        }

        function showAddRoleModal() {
            // Resetear el formulario y t√≠tulo
            const form = document.getElementById('addRoleForm');
            form.reset();
            form.dataset.editingId = ''; // Limpiar el ID de edici√≥n
            document.querySelector('#addRoleModal .modal-title').textContent = 'Agregar Nuevo Rol';
            
            // Resetear el bot√≥n de submit
            const submitBtn = document.querySelector('#addRoleForm button[type="submit"]');
            submitBtn.textContent = 'Agregar Rol';
            
            document.getElementById('addRoleModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        async function addEmployee() {
            const form = document.getElementById('addEmployeeForm');
            const editingId = form.dataset.editingId;
            
            if (editingId) {
                // Estamos en modo edici√≥n
                await updateEmployee(editingId);
                return;
            }
            
            console.log('Agregando empleado...');
            const formData = {
                nombre: document.getElementById('employeeName').value,
                apellido: document.getElementById('employeeLastName').value,
                email: document.getElementById('employeeEmail').value,
                telefono: document.getElementById('employeePhone').value,
                rol_id: document.getElementById('employeeRole').value,
                password: document.getElementById('employeePassword').value
            };
            console.log('Datos del formulario:', formData);

            try {
                const response = await fetch('/api/empleados', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Respuesta del servidor:', response.status);
                const data = await response.json();
                console.log('Datos de respuesta:', data);

                if (data.success) {
                    showSuccess('Empleado agregado exitosamente. Calendario de horarios regenerado.');
                    closeModal('addEmployeeModal');
                    document.getElementById('addEmployeeForm').reset();
                    await loadEmployees();
                    // Regenerar calendario de horarios
                    if (typeof generateOfficialCalendar === 'function') {
                        await generateOfficialCalendar();
                    }
                } else {
                    showError(data.message || 'Error al agregar empleado');
                }
            } catch (error) {
                console.error('Error al agregar empleado:', error);
                showError('Error al agregar empleado: ' + error.message);
            }
        }

        async function addRole() {
            const form = document.getElementById('addRoleForm');
            const editingId = form.dataset.editingId;
            
            if (editingId) {
                // Estamos en modo edici√≥n
                await updateRole(editingId);
                return;
            }
            
            const formData = {
                nombre: document.getElementById('roleName').value,
                descripcion: document.getElementById('roleDescription').value,
                permisos: document.getElementById('rolePermissions').value
            };

            try {
                const response = await fetch('/api/roles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Rol agregado exitosamente');
                    closeModal('addRoleModal');
                    document.getElementById('addRoleForm').reset();
                    loadRoles();
                    loadRolesTable();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Error al agregar rol');
            }
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES');
        }

        function logout() {
            console.log('Cerrando sesi√≥n...');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            console.log('Redirigiendo a login...');
            window.location.href = '/';
        }

        // Funciones para horarios
        async function loadSchedules() {
            try {
                console.log('Cargando horarios...');
                const response = await fetch('/api/horarios', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                console.log('Respuesta de horarios:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Datos de horarios:', data);
                    schedules = data.data;
                } else {
                    console.error('Error en respuesta de horarios:', response.status);
                    showError('Error al cargar horarios');
                }
            } catch (error) {
                console.error('Error al cargar horarios:', error);
                showError('Error al cargar horarios: ' + error.message);
            }
        }

        function loadSchedulesTable() {
            console.log('Cargando tabla de horarios...');
            const tbody = document.getElementById('schedulesTable');
            if (!tbody) {
                console.error('No se encontr√≥ el elemento schedulesTable');
                return;
            }
            tbody.innerHTML = '';

            console.log('Horarios a mostrar:', schedules.length);
            schedules.forEach(schedule => {
                const row = document.createElement('tr');
                const diasNombres = schedule.dias_semana.split(',').map(d => {
                    const dias = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                    return dias[parseInt(d)];
                }).join(', ');

                row.innerHTML = `
                    <td>${schedule.nombre}</td>
                    <td>${schedule.hora_entrada}</td>
                    <td>${schedule.hora_salida}</td>
                    <td>${diasNombres}</td>
                    <td><span class="status-badge ${schedule.activo ? 'badge-active' : 'badge-inactive'}">${schedule.activo ? 'Activo' : 'Inactivo'}</span></td>
                    <td>
                        <button class="btn btn-warning" onclick="editSchedule(${schedule.id})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteSchedule(${schedule.id})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-success" onclick="showAssignScheduleModal(${schedule.id})" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-user-plus"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showAddScheduleModal() {
            // Resetear el formulario y t√≠tulo
            const form = document.getElementById('addScheduleForm');
            form.reset();
            form.dataset.editingId = ''; // Limpiar el ID de edici√≥n
            document.querySelector('#addScheduleModal .modal-title').textContent = 'Agregar Nuevo Horario';
            
            // Resetear el bot√≥n de submit
            const submitBtn = document.querySelector('#addScheduleForm button[type="submit"]');
            submitBtn.textContent = 'Agregar Horario';
            
            document.getElementById('addScheduleModal').style.display = 'block';
        }

        async function addSchedule() {
            const form = document.getElementById('addScheduleForm');
            const editingId = form.dataset.editingId;
            
            if (editingId) {
                // Estamos en modo edici√≥n
                await updateSchedule(editingId);
                return;
            }
            
            const selectedDays = Array.from(document.querySelectorAll('.scheduleDays:checked')).map(cb => cb.value);
            
            if (selectedDays.length === 0) {
                showError('Selecciona al menos un d√≠a de la semana');
                return;
            }

            const formData = {
                nombre: document.getElementById('scheduleName').value,
                hora_entrada: document.getElementById('scheduleStartTime').value,
                hora_salida: document.getElementById('scheduleEndTime').value,
                dias_semana: selectedDays.join(','),
                descripcion: document.getElementById('scheduleDescription').value
            };

            try {
                const response = await fetch('/api/horarios', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('Horario agregado exitosamente');
                    closeModal('addScheduleModal');
                    document.getElementById('addScheduleForm').reset();
                    await loadSchedules();
                    loadSchedulesTable();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Error al agregar horario');
            }
        }

        // Funciones para asistencia
        async function loadAttendanceData() {
            const fechaInicio = document.getElementById('attendanceDateFrom').value;
            const fechaFin = document.getElementById('attendanceDateTo').value;
            const empleadoId = document.getElementById('attendanceEmployeeFilter').value;

            let url = '/api/asistencia?';
            if (fechaInicio) url += `fecha_inicio=${fechaInicio}&`;
            if (fechaFin) url += `fecha_fin=${fechaFin}&`;
            if (empleadoId) url += `empleado_id=${empleadoId}&`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateAttendanceTable(data.data);
                }
            } catch (error) {
                showError('Error al cargar datos de asistencia');
            }
        }

        function updateAttendanceTable(attendance) {
            const tbody = document.getElementById('attendanceTable');
            tbody.innerHTML = '';

            attendance.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.nombre} ${record.apellido}</td>
                    <td>${formatDate(record.fecha)}</td>
                    <td>${record.hora_entrada || '-'}</td>
                    <td>${record.hora_salida || '-'}</td>
                    <td>${record.horas_trabajadas ? `${record.horas_trabajadas}h` : '-'}</td>
                    <td><span class="status-badge ${record.estado === 'presente' ? 'badge-present' : 'badge-absent'}">${record.estado}</span></td>
                    <td>
                        <button class="btn btn-warning" onclick="markAbsence(${record.empleado_id}, '${record.fecha}')" style="padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Funciones para vacaciones
        async function loadVacationsData() {
            const estado = document.getElementById('vacationStatusFilter').value;

            let url = '/api/vacaciones?';
            if (estado) url += `estado=${estado}&`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateVacationsTable(data.data);
                }
            } catch (error) {
                showError('Error al cargar datos de vacaciones');
            }
        }

        function updateVacationsTable(vacations) {
            const tbody = document.getElementById('vacationsTable');
            tbody.innerHTML = '';

            vacations.forEach(vacation => {
                const row = document.createElement('tr');
                const statusClass = vacation.estado === 'aprobado' ? 'badge-approved' : 
                                  vacation.estado === 'rechazado' ? 'badge-rejected' : 'badge-pending';

                row.innerHTML = `
                    <td>${vacation.nombre} ${vacation.apellido}</td>
                    <td>${formatDate(vacation.fecha_inicio)}</td>
                    <td>${formatDate(vacation.fecha_fin)}</td>
                    <td>${vacation.dias_solicitados}</td>
                    <td><span class="status-badge ${statusClass}">${vacation.estado}</span></td>
                    <td>${vacation.motivo || '-'}</td>
                    <td>
                        ${vacation.estado === 'pendiente' ? `
                            <button class="btn btn-success" onclick="approveVacation(${vacation.id})" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-danger" onclick="rejectVacation(${vacation.id})" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function approveVacation(vacationId) {
            if (confirm('¬øAprobar esta solicitud de vacaciones?')) {
                try {
                    const response = await fetch(`/api/vacaciones/${vacationId}/estado`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ estado: 'aprobado' })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showSuccess('Vacaciones aprobadas exitosamente');
                        loadVacationsData();
                    } else {
                        showError(data.message);
                    }
                } catch (error) {
                    showError('Error al aprobar vacaciones');
                }
            }
        }

        async function rejectVacation(vacationId) {
            const motivo = prompt('Motivo del rechazo:');
            if (motivo) {
                try {
                    const response = await fetch(`/api/vacaciones/${vacationId}/estado`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ estado: 'rechazado', observaciones: motivo })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showSuccess('Vacaciones rechazadas');
                        loadVacationsData();
                    } else {
                        showError(data.message);
                    }
                } catch (error) {
                    showError('Error al rechazar vacaciones');
                }
            }
        }

        // Funciones para reportes
        async function generateAttendanceReport() {
            const fechaInicio = document.getElementById('reportAttendanceFrom').value;
            const fechaFin = document.getElementById('reportAttendanceTo').value;
            const empleadoId = document.getElementById('reportAttendanceEmployee').value;

            if (!fechaInicio || !fechaFin) {
                showError('Selecciona fechas de inicio y fin');
                return;
            }

            let url = `/api/reportes/asistencia?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
            if (empleadoId) url += `&empleado_id=${empleadoId}`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    downloadReport(data.data, 'reporte-asistencia');
                    showSuccess('Reporte generado exitosamente');
                }
            } catch (error) {
                showError('Error al generar reporte');
            }
        }

        async function generateHoursReport() {
            const fechaInicio = document.getElementById('reportHoursFrom').value;
            const fechaFin = document.getElementById('reportHoursTo').value;

            if (!fechaInicio || !fechaFin) {
                showError('Selecciona fechas de inicio y fin');
                return;
            }

            try {
                const response = await fetch(`/api/reportes/horas-trabajadas?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    downloadReport(data.data, 'reporte-horas');
                    showSuccess('Reporte generado exitosamente');
                }
            } catch (error) {
                showError('Error al generar reporte');
            }
        }

        async function generateVacationReport() {
            const a√±o = document.getElementById('reportVacationYear').value;

            try {
                const response = await fetch(`/api/vacaciones/estadisticas?a√±o=${a√±o}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    downloadReport(data.data, 'reporte-vacaciones');
                    showSuccess('Reporte generado exitosamente');
                }
            } catch (error) {
                showError('Error al generar reporte');
            }
        }

        function downloadReport(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Funciones auxiliares
        function initializeDateInputs() {
            const today = new Date().toISOString().split('T')[0];
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const lastMonthStr = lastMonth.toISOString().split('T')[0];

            // Establecer fechas por defecto (solo si los elementos existen)
            const attendanceDateFrom = document.getElementById('attendanceDateFrom');
            const attendanceDateTo = document.getElementById('attendanceDateTo');
            const reportAttendanceFrom = document.getElementById('reportAttendanceFrom');
            const reportAttendanceTo = document.getElementById('reportAttendanceTo');
            const reportHoursFrom = document.getElementById('reportHoursFrom');
            const reportHoursTo = document.getElementById('reportHoursTo');
            
            if (attendanceDateFrom) attendanceDateFrom.value = lastMonthStr;
            if (attendanceDateTo) attendanceDateTo.value = today;
            if (reportAttendanceFrom) reportAttendanceFrom.value = lastMonthStr;
            if (reportAttendanceTo) reportAttendanceTo.value = today;
            if (reportHoursFrom) reportHoursFrom.value = lastMonthStr;
            if (reportHoursTo) reportHoursTo.value = today;
        }

        function populateEmployeeSelects() {
            console.log('Poblando selects de empleados...');
            const selects = ['attendanceEmployeeFilter', 'reportAttendanceEmployee', 'assignEmployee'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = selectId === 'assignEmployee' ? 
                        '<option value="">Seleccionar empleado...</option>' : 
                        '<option value="">Todos los empleados</option>';
                    
                    console.log(`Poblando select ${selectId} con ${employees.length} empleados`);
                    employees.forEach(employee => {
                        const option = document.createElement('option');
                        option.value = employee.id;
                        option.textContent = `${employee.nombre} ${employee.apellido}`;
                        select.appendChild(option);
                    });
                } else {
                    console.log(`Elemento ${selectId} no encontrado - omitiendo`);
                }
            });
        }

        function populateScheduleSelect() {
            console.log('Poblando select de horarios...');
            const select = document.getElementById('assignSchedule');
            if (select) {
                select.innerHTML = '<option value="">Seleccionar horario...</option>';
                console.log('Horarios disponibles:', schedules.length);
                schedules.forEach(schedule => {
                    const option = document.createElement('option');
                    option.value = schedule.id;
                    option.textContent = schedule.nombre;
                    select.appendChild(option);
                });
            } else {
                console.warn('No se encontr√≥ el elemento assignSchedule');
            }
        }

        // Funciones adicionales que faltan
        function showAssignScheduleModal(scheduleId = null) {
            console.log('Mostrando modal de asignar horario...');
            populateEmployeeSelects();
            populateScheduleSelect();
            if (scheduleId) {
                document.getElementById('assignSchedule').value = scheduleId;
            }
            document.getElementById('assignScheduleModal').style.display = 'block';
        }

        async function assignSchedule() {
            console.log('Asignando horario...');
            const formData = {
                empleado_id: document.getElementById('assignEmployee').value,
                horario_id: document.getElementById('assignSchedule').value,
                fecha_inicio: document.getElementById('assignStartDate').value,
                fecha_fin: document.getElementById('assignEndDate').value || null
            };
            console.log('Datos del formulario de asignaci√≥n:', formData);

            try {
                const response = await fetch(`/api/horarios/${formData.horario_id}/asignar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Respuesta de asignaci√≥n:', response.status);
                const data = await response.json();
                console.log('Datos de respuesta de asignaci√≥n:', data);

                if (data.success) {
                    showSuccess('Horario asignado exitosamente');
                    closeModal('assignScheduleModal');
                    document.getElementById('assignScheduleForm').reset();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('Error al asignar horario:', error);
                showError('Error al asignar horario: ' + error.message);
            }
        }

        async function markAbsence(empleadoId, fecha) {
            console.log('Marcando ausencia...');
            const motivo = prompt('Motivo de la ausencia:');
            if (motivo) {
                try {
                    const response = await fetch('/api/asistencia/ausencia', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            empleado_id: empleadoId,
                            fecha: fecha,
                            motivo: motivo
                        })
                    });

                    console.log('Respuesta de ausencia:', response.status);
                    const data = await response.json();
                    console.log('Datos de respuesta de ausencia:', data);

                    if (data.success) {
                        showSuccess('Ausencia marcada exitosamente');
                        loadAttendanceData();
                    } else {
                        showError(data.message);
                    }
                } catch (error) {
                    console.error('Error al marcar ausencia:', error);
                    showError('Error al marcar ausencia: ' + error.message);
                }
            }
        }

        async function editEmployee(id) {
            console.log('Editando empleado:', id);
            const employee = employees.find(emp => emp.id === id);
            if (!employee) {
                console.error('Empleado no encontrado:', id);
                showError('Empleado no encontrado');
                return;
            }
            console.log('Empleado encontrado:', employee);

            // Llenar el formulario con los datos del empleado
            document.getElementById('employeeName').value = employee.nombre;
            document.getElementById('employeeLastName').value = employee.apellido;
            document.getElementById('employeeEmail').value = employee.email;
            document.getElementById('employeePhone').value = employee.telefono || '';
            document.getElementById('employeeRole').value = employee.rol_id || '';
            
            // Cambiar el t√≠tulo del modal
            document.querySelector('#addEmployeeModal .modal-title').textContent = 'Editar Empleado';
            
            // Cambiar el bot√≥n de submit
            const submitBtn = document.querySelector('#addEmployeeForm button[type="submit"]');
            submitBtn.textContent = 'Actualizar Empleado';
            
            // Marcar que estamos en modo edici√≥n
            document.getElementById('addEmployeeForm').dataset.editingId = id;
            
            // Mostrar el modal
            document.getElementById('addEmployeeModal').style.display = 'block';
        }

        async function updateEmployee(id) {
            console.log('Actualizando empleado:', id);
            const formData = {
                nombre: document.getElementById('employeeName').value,
                apellido: document.getElementById('employeeLastName').value,
                email: document.getElementById('employeeEmail').value,
                telefono: document.getElementById('employeePhone').value,
                rol_id: document.getElementById('employeeRole').value
            };
            console.log('Datos del formulario de actualizaci√≥n:', formData);

            try {
                const response = await fetch(`/api/empleados/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Respuesta de actualizaci√≥n:', response.status);
                const data = await response.json();
                console.log('Datos de respuesta de actualizaci√≥n:', data);

                if (data.success) {
                    showSuccess('Empleado actualizado exitosamente. Calendario de horarios regenerado.');
                    closeModal('addEmployeeModal');
                    document.getElementById('addEmployeeForm').reset();
                    await loadEmployees();
                    // Regenerar calendario de horarios
                    if (typeof generateOfficialCalendar === 'function') {
                        await generateOfficialCalendar();
                    }
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('Error al actualizar empleado:', error);
                showError('Error al actualizar empleado: ' + error.message);
            }
        }

        async function deleteEmployee(id) {
            console.log('Eliminando empleado:', id);
            if (confirm('¬øEst√°s seguro de que quieres eliminar este empleado?')) {
                try {
                    const response = await fetch(`/api/empleados/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    console.log('Respuesta de eliminaci√≥n:', response.status);
                    const data = await response.json();
                    console.log('Datos de respuesta de eliminaci√≥n:', data);

                    if (data.success) {
                        showSuccess('Empleado eliminado exitosamente. Calendario de horarios regenerado.');
                        await loadEmployees();
                        // Regenerar calendario de horarios
                        if (typeof generateOfficialCalendar === 'function') {
                            await generateOfficialCalendar();
                        }
                    } else {
                        showError(data.message);
                    }
                } catch (error) {
                    console.error('Error al eliminar empleado:', error);
                    showError('Error al eliminar empleado: ' + error.message);
                }
            }
        }

        async function editRole(id) {
            console.log('Editando rol:', id);
            const role = roles.find(r => r.id === id);
            if (!role) {
                console.error('Rol no encontrado:', id);
                showError('Rol no encontrado');
                return;
            }
            console.log('Rol encontrado:', role);

            // Llenar el formulario con los datos del rol
            document.getElementById('roleName').value = role.nombre;
            document.getElementById('roleDescription').value = role.descripcion || '';
            document.getElementById('rolePermissions').value = role.permisos || '';
            
            // Cambiar el t√≠tulo del modal
            document.querySelector('#addRoleModal .modal-title').textContent = 'Editar Rol';
            
            // Cambiar el bot√≥n de submit
            const submitBtn = document.querySelector('#addRoleForm button[type="submit"]');
            submitBtn.textContent = 'Actualizar Rol';
            
            // Marcar que estamos en modo edici√≥n
            document.getElementById('addRoleForm').dataset.editingId = id;
            
            // Mostrar el modal
            document.getElementById('addRoleModal').style.display = 'block';
        }

        async function updateRole(id) {
            console.log('Actualizando rol:', id);
            const formData = {
                nombre: document.getElementById('roleName').value,
                descripcion: document.getElementById('roleDescription').value,
                permisos: document.getElementById('rolePermissions').value
            };
            console.log('Datos del formulario de actualizaci√≥n de rol:', formData);

            try {
                const response = await fetch(`/api/roles/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Respuesta de actualizaci√≥n de rol:', response.status);
                const data = await response.json();
                console.log('Datos de respuesta de actualizaci√≥n de rol:', data);

                if (data.success) {
                    showSuccess('Rol actualizado exitosamente');
                    closeModal('addRoleModal');
                    document.getElementById('addRoleForm').reset();
                    loadRoles();
                    loadRolesTable();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('Error al actualizar rol:', error);
                showError('Error al actualizar rol: ' + error.message);
            }
        }

        async function deleteRole(id) {
            console.log('Eliminando rol:', id);
            if (confirm('¬øEst√°s seguro de que quieres eliminar este rol?')) {
                try {
                    const response = await fetch(`/api/roles/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    console.log('Respuesta de eliminaci√≥n de rol:', response.status);
                    const data = await response.json();
                    console.log('Datos de respuesta de eliminaci√≥n de rol:', data);

                    if (data.success) {
                        showSuccess('Rol eliminado exitosamente');
                        loadRoles();
                        loadRolesTable();
                    } else {
                        showError(data.message);
                    }
                } catch (error) {
                    console.error('Error al eliminar rol:', error);
                    showError('Error al eliminar rol: ' + error.message);
                }
            }
        }

        async function editSchedule(id) {
            console.log('Editando horario:', id);
            const schedule = schedules.find(s => s.id === id);
            if (!schedule) {
                console.error('Horario no encontrado:', id);
                showError('Horario no encontrado');
                return;
            }
            console.log('Horario encontrado:', schedule);

            // Llenar el formulario con los datos del horario
            document.getElementById('scheduleName').value = schedule.nombre;
            document.getElementById('scheduleStartTime').value = schedule.hora_entrada;
            document.getElementById('scheduleEndTime').value = schedule.hora_salida;
            document.getElementById('scheduleDescription').value = schedule.descripcion || '';
            
            // Marcar los d√≠as de la semana
            const diasArray = schedule.dias_semana.split(',');
            document.querySelectorAll('.scheduleDays').forEach(checkbox => {
                checkbox.checked = diasArray.includes(checkbox.value);
            });
            
            // Cambiar el t√≠tulo del modal
            document.querySelector('#addScheduleModal .modal-title').textContent = 'Editar Horario';
            
            // Cambiar el bot√≥n de submit
            const submitBtn = document.querySelector('#addScheduleForm button[type="submit"]');
            submitBtn.textContent = 'Actualizar Horario';
            
            // Marcar que estamos en modo edici√≥n
            document.getElementById('addScheduleForm').dataset.editingId = id;
            
            // Mostrar el modal
            document.getElementById('addScheduleModal').style.display = 'block';
        }

        async function updateSchedule(id) {
            console.log('Actualizando horario:', id);
            const selectedDays = Array.from(document.querySelectorAll('.scheduleDays:checked')).map(cb => cb.value);
            
            if (selectedDays.length === 0) {
                showError('Selecciona al menos un d√≠a de la semana');
                return;
            }

            const formData = {
                nombre: document.getElementById('scheduleName').value,
                hora_entrada: document.getElementById('scheduleStartTime').value,
                hora_salida: document.getElementById('scheduleEndTime').value,
                dias_semana: selectedDays.join(','),
                descripcion: document.getElementById('scheduleDescription').value
            };
            console.log('Datos del formulario de actualizaci√≥n de horario:', formData);

            try {
                const response = await fetch(`/api/horarios/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Respuesta de actualizaci√≥n de horario:', response.status);
                const data = await response.json();
                console.log('Datos de respuesta de actualizaci√≥n de horario:', data);

                if (data.success) {
                    showSuccess('Horario actualizado exitosamente');
                    closeModal('addScheduleModal');
                    document.getElementById('addScheduleForm').reset();
                    await loadSchedules();
                    loadSchedulesTable();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('Error al actualizar horario:', error);
                showError('Error al actualizar horario: ' + error.message);
            }
        }

        async function deleteSchedule(id) {
            console.log('Eliminando horario:', id);
            if (confirm('¬øEst√°s seguro de que quieres eliminar este horario?')) {
                try {
                    const response = await fetch(`/api/horarios/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    console.log('Respuesta de eliminaci√≥n de horario:', response.status);
                    const data = await response.json();
                    console.log('Datos de respuesta de eliminaci√≥n de horario:', data);

                    if (data.success) {
                        showSuccess('Horario eliminado exitosamente');
                        await loadSchedules();
                        loadSchedulesTable();
                    } else {
                        showError(data.message);
                    }
                } catch (error) {
                    console.error('Error al eliminar horario:', error);
                    showError('Error al eliminar horario: ' + error.message);
                }
            }
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Variables para el calendario
        let currentDate = new Date();
        let scheduleData = {};
        let rotationSchedule = {};

        // Funci√≥n para cargar datos de asistencia (ahora con calendario)
        async function loadAttendanceData() {
            console.log('Cargando datos de asistencia con calendario...');
            await loadEmployees();
            await loadSchedules();
            generateCalendar();
            generateWeeklySummary();
        }

        // Funci√≥n para generar el calendario
        function generateCalendar() {
            console.log('Generando calendario...');
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonth = document.getElementById('currentMonth');
            
            // Actualizar t√≠tulo del mes
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            currentMonth.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            
            // Limpiar calendario
            calendarGrid.innerHTML = '';
            
            // Obtener primer d√≠a del mes y √∫ltimo d√≠a
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay() + 1); // Lunes
            
            // Generar 42 d√≠as (6 semanas)
            for (let i = 0; i < 42; i++) {
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // Marcar si es del mes actual
                if (dayDate.getMonth() !== currentDate.getMonth()) {
                    dayElement.classList.add('other-month');
                }
                
                // Marcar si es hoy
                const today = new Date();
                if (dayDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // N√∫mero del d√≠a
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = dayDate.getDate();
                dayElement.appendChild(dayNumber);
                
                // Asignaciones de turnos
                const assignments = getShiftAssignments(dayDate);
                assignments.forEach(assignment => {
                    const shiftElement = document.createElement('div');
                    shiftElement.className = `shift-assignment ${assignment.class}`;
                    shiftElement.textContent = assignment.name;
                    dayElement.appendChild(shiftElement);
                });
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // Funci√≥n para obtener asignaciones de turnos para una fecha
        function getShiftAssignments(date) {
            const assignments = [];
            const dayOfWeek = date.getDay(); // 0 = Domingo, 1 = Lunes, etc.
            
            // Central de Transporte trabaja de lunes a domingo (todos los d√≠as)
            // Despacho Central trabaja de lunes a s√°bado (1-6)
            // Turno Noche trabaja todos los d√≠as (24/7)
            
            // Obtener la semana del a√±o
            const weekNumber = getWeekNumber(date);
            
            // Siempre hay 3 personas trabajando al mismo tiempo
            // Una en Central de Transporte, otra en Despacho Central, y una en Turno Noche
            // Total: 5 empleados rotando entre los 3 turnos
            
            // Central de Transporte - siempre presente
            if (dayOfWeek >= 1 && dayOfWeek <= 7) { // Lunes a Domingo
                const centralIndex = weekNumber % 2; // Rotaci√≥n entre 2 turnos de Central
                const centralShift = getCentralTransporteShift(centralIndex);
                const centralEmployee = getEmployeeName((weekNumber % 2) + 1);
                assignments.push({
                    name: `${centralEmployee} - ${centralShift.name}`,
                    class: centralShift.class
                });
            }
            
            // Despacho Central - solo lunes a s√°bado
            if (dayOfWeek >= 1 && dayOfWeek <= 6) { // Lunes a S√°bado
                const despachoIndex = weekNumber % 2; // Rotaci√≥n entre 2 turnos de Despacho
                const despachoShift = getDespachoCentralShift(despachoIndex);
                const despachoEmployee = getEmployeeName((weekNumber % 2) + 3);
                assignments.push({
                    name: `${despachoEmployee} - ${despachoShift.name}`,
                    class: despachoShift.class
                });
            }
            
            // Turno Noche - siempre presente (24/7)
            const nocheIndex = weekNumber % 5; // Rotaci√≥n entre 5 empleados de turno noche
            const nocheShift = getTurnoNocheShift(nocheIndex);
            assignments.push({
                name: nocheShift.name,
                class: nocheShift.class
            });
            
            return assignments;
        }

        // Funci√≥n para obtener el n√∫mero de semana del a√±o
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // Funci√≥n para obtener turno por √≠ndice (mantener para compatibilidad)
        function getShiftByIndex(index) {
            const shifts = [
                { name: 'Central Transporte - Ma√±ana', class: 'central-transporte-manana' },
                { name: 'Central Transporte - Tarde', class: 'central-transporte-tarde' },
                { name: 'Despacho Central - Ma√±ana', class: 'despacho-central-manana' },
                { name: 'Despacho Central - Tarde', class: 'despacho-central-tarde' },
                { name: 'Turno Noche', class: 'turno-noche' }
            ];
            return shifts[index];
        }

        // Funci√≥n para obtener turnos de Central de Transporte
        function getCentralTransporteShift(index) {
            const shifts = [
                { name: 'Central Transporte - Ma√±ana', class: 'central-transporte-manana' },
                { name: 'Central Transporte - Tarde', class: 'central-transporte-tarde' }
            ];
            return shifts[index];
        }

        // Funci√≥n para obtener turnos de Despacho Central
        function getDespachoCentralShift(index) {
            const shifts = [
                { name: 'Despacho Central - Ma√±ana', class: 'despacho-central-manana' },
                { name: 'Despacho Central - Tarde', class: 'despacho-central-tarde' }
            ];
            return shifts[index];
        }

        // Funci√≥n para obtener turnos de noche con nombres de empleados
        function getTurnoNocheShift(index) {
            const empleadosNoche = [
                'Empleado 1',
                'Empleado 2', 
                'Empleado 3',
                'Empleado 4',
                'Empleado 5'
            ];
            
            const empleado = empleadosNoche[index];
            return {
                name: `Turno Noche - ${empleado}`,
                class: 'turno-noche'
            };
        }

        // Funci√≥n para obtener nombres de empleados
        function getEmployeeName(index) {
            const empleados = [
                'Empleado 1',
                'Empleado 2', 
                'Empleado 3',
                'Empleado 4',
                'Empleado 5'
            ];
            
            return empleados[index - 1] || 'Empleado Desconocido';
        }

        function getEmployeeFreeDays(employeeId, workingDays) {
            // Generar d√≠as libres consecutivos (seguidos) para cada empleado
            // Usar el ID del empleado como semilla para consistencia
            
            const freeDaysCount = 7 - workingDays;
            
            // Crear una funci√≥n de hash simple basada en el ID del empleado
            const seed = employeeId * 7; // Multiplicar por 7 para variaci√≥n
            
            // Generar el d√≠a de inicio de los d√≠as libres consecutivos
            // Posibles d√≠as de inicio: 0-5 (para 2 d√≠as consecutivos)
            const possibleStartDays = [0, 1, 2, 3, 4, 5]; // Domingo a Viernes
            const startDayIndex = seed % possibleStartDays.length;
            const startDay = possibleStartDays[startDayIndex];
            
            // Generar d√≠as libres consecutivos
            const freeDays = [];
            for (let i = 0; i < freeDaysCount; i++) {
                freeDays.push((startDay + i) % 7);
            }
            
            return freeDays.sort((a, b) => a - b);
        }

        function getFreeDaysText(employeeId, freeDaysCount) {
            const freeDays = getEmployeeFreeDays(employeeId, 7 - freeDaysCount);
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            return freeDays.map(day => dayNames[day]).join(', ');
        }

        // Funciones para manejo de fotos de perfil
        function loadProfileData() {
            if (!currentUser) return;
            
            // Cargar informaci√≥n del perfil
            document.getElementById('profileName').textContent = currentUser.nombre || 'N/A';
            document.getElementById('profileLastName').textContent = currentUser.apellido || 'N/A';
            document.getElementById('profileEmail').textContent = currentUser.email || 'N/A';
            document.getElementById('profilePhone').textContent = currentUser.telefono || 'N/A';
            document.getElementById('profileRole').textContent = currentUser.rol || 'Administrador';
            document.getElementById('profileHireDate').textContent = currentUser.fecha_contratacion || 'N/A';
            
            // Cargar foto de perfil
            loadProfilePhoto();
            
            // Configurar evento para subir foto
            document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
        }

        function loadProfilePhoto() {
            fetch('/api/upload/profile-photo', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const profilePhoto = document.getElementById('profilePhoto');
                const removeBtn = document.getElementById('removePhotoBtn');
                
                if (data.success && data.photoPath) {
                    profilePhoto.innerHTML = `<img src="${data.photoPath}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    removeBtn.style.display = 'block';
                } else {
                    profilePhoto.innerHTML = '<i class="fas fa-user" style="font-size: 60px; color: #94A3B8;"></i>';
                    removeBtn.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error al cargar foto de perfil:', error);
            });
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar tama√±o del archivo (5MB m√°ximo)
            if (file.size > 5 * 1024 * 1024) {
                showError('El archivo es demasiado grande. M√°ximo 5MB.');
                return;
            }
            
            // Validar tipo de archivo
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                showError('Tipo de archivo no v√°lido. Solo se permiten im√°genes (JPEG, JPG, PNG, GIF, WEBP).');
                return;
            }
            
            // Crear FormData
            const formData = new FormData();
            formData.append('profilePhoto', file);
            
            // Subir archivo
            fetch('/api/upload/profile-photo', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('Foto de perfil actualizada correctamente');
                    loadProfilePhoto(); // Recargar la foto
                } else {
                    showError(data.message || 'Error al subir la foto');
                }
            })
            .catch(error => {
                console.error('Error al subir foto:', error);
                showError('Error al subir la foto');
            });
            
            // Limpiar el input
            event.target.value = '';
        }

        function removeProfilePhoto() {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar tu foto de perfil?')) {
                return;
            }
            
            fetch('/api/upload/profile-photo', {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('Foto de perfil eliminada correctamente');
                    loadProfilePhoto(); // Recargar la foto
                } else {
                    showError(data.message || 'Error al eliminar la foto');
                }
            })
            .catch(error => {
                console.error('Error al eliminar foto:', error);
                showError('Error al eliminar la foto');
            });
        }

        // Funciones para manejo de liquidaciones
        function loadPayrollsData() {
            loadAllPayrolls();
            loadEmployeesForPayroll();
            populateYearFilter();
        }

        function loadAllPayrolls() {
            fetch('/api/liquidaciones/all', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayPayrolls(data.liquidaciones);
                } else {
                    showError('Error al cargar liquidaciones');
                }
            })
            .catch(error => {
                console.error('Error al cargar liquidaciones:', error);
                showError('Error al cargar liquidaciones');
            });
        }

        function displayPayrolls(payrolls) {
            const tbody = document.getElementById('payrollsTableBody');
            tbody.innerHTML = '';

            if (payrolls.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No hay liquidaciones registradas</td></tr>';
                return;
            }

            payrolls.forEach(payroll => {
                const row = document.createElement('tr');
                const monthNames = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                
                row.innerHTML = `
                    <td>${payroll.nombre} ${payroll.apellido}</td>
                    <td>${monthNames[payroll.periodo_mes]} ${payroll.periodo_ano}</td>
                    <td>
                        <i class="fas fa-file-pdf" style="color: #EF4444; margin-right: 5px;"></i>
                        ${payroll.nombre_archivo}
                    </td>
                    <td>${formatFileSize(payroll.tama√±o_archivo)}</td>
                    <td>${payroll.subido_por_nombre || 'N/A'} ${payroll.subido_por_apellido || ''}</td>
                    <td>${formatDate(payroll.fecha_subida)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="downloadPayroll(${payroll.id})" title="Descargar">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletePayroll(${payroll.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadEmployeesForPayroll() {
            fetch('/api/empleados', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const select = document.getElementById('payrollEmployee');
                    const filterSelect = document.getElementById('payrollEmployeeFilter');
                    
                    // Limpiar opciones existentes
                    select.innerHTML = '<option value="">Seleccionar empleado...</option>';
                    filterSelect.innerHTML = '<option value="">Todos los empleados</option>';
                    
                    data.empleados.forEach(employee => {
                        const option = document.createElement('option');
                        option.value = employee.id;
                        option.textContent = `${employee.nombre} ${employee.apellido}`;
                        select.appendChild(option);
                        
                        const filterOption = option.cloneNode(true);
                        filterSelect.appendChild(filterOption);
                    });
                }
            })
            .catch(error => {
                console.error('Error al cargar empleados:', error);
            });
        }

        function populateYearFilter() {
            const currentYear = new Date().getFullYear();
            const yearSelect = document.getElementById('payrollYear');
            const yearFilterSelect = document.getElementById('payrollYearFilter');
            
            // Limpiar opciones existentes
            yearSelect.innerHTML = '<option value="">A√±o</option>';
            yearFilterSelect.innerHTML = '<option value="">Todos los a√±os</option>';
            
            // Agregar a√±os desde 2020 hasta el a√±o actual + 1
            for (let year = 2020; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
                
                const filterOption = option.cloneNode(true);
                yearFilterSelect.appendChild(filterOption);
            }
        }

        function showUploadPayrollModal() {
            document.getElementById('uploadPayrollModal').style.display = 'block';
            document.getElementById('uploadPayrollForm').reset();
        }

        function filterPayrolls() {
            // Esta funci√≥n se implementar√° para filtrar las liquidaciones
            loadAllPayrolls(); // Por ahora recargamos todas
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function downloadPayroll(payrollId) {
            window.open(`/api/liquidaciones/download/${payrollId}`, '_blank');
        }

        function deletePayroll(payrollId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta liquidaci√≥n?')) {
                return;
            }
            
            fetch(`/api/liquidaciones/${payrollId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('Liquidaci√≥n eliminada correctamente');
                    loadAllPayrolls();
                } else {
                    showError(data.message || 'Error al eliminar liquidaci√≥n');
                }
            })
            .catch(error => {
                console.error('Error al eliminar liquidaci√≥n:', error);
                showError('Error al eliminar liquidaci√≥n');
            });
        }

        // Funciones para manejo de tiempo de colaci√≥n
        let currentBreakTimeEmployeeId = null;

        function editBreakTime(employeeId, currentBreakTime) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) {
                showError('Empleado no encontrado');
                return;
            }

            currentBreakTimeEmployeeId = employeeId;
            document.getElementById('breakTimeEmployee').value = `${employee.nombre} ${employee.apellido}`;
            document.getElementById('breakTimeMinutes').value = currentBreakTime;
            document.getElementById('editBreakTimeModal').style.display = 'block';
        }

        function updateBreakTime() {
            if (!currentBreakTimeEmployeeId) {
                showError('No se ha seleccionado un empleado');
                return;
            }

            const newBreakTime = parseInt(document.getElementById('breakTimeMinutes').value);
            
            if (isNaN(newBreakTime) || newBreakTime < 0 || newBreakTime > 120) {
                showError('El tiempo de colaci√≥n debe ser un n√∫mero entre 0 y 120 minutos');
                return;
            }

            fetch(`/api/empleados/${currentBreakTimeEmployeeId}/colacion`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    tiempo_colacion: newBreakTime
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('Tiempo de colaci√≥n actualizado correctamente');
                    closeModal('editBreakTimeModal');
                    loadEmployees(); // Recargar empleados para actualizar la tabla
                } else {
                    showError(data.message || 'Error al actualizar tiempo de colaci√≥n');
                }
            })
            .catch(error => {
                console.error('Error al actualizar tiempo de colaci√≥n:', error);
                showError('Error al actualizar tiempo de colaci√≥n');
            });
        }

        // Configurar formulario de subida de liquidaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            const uploadForm = document.getElementById('uploadPayrollForm');
            if (uploadForm) {
                uploadForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData();
                    formData.append('empleado_id', document.getElementById('payrollEmployee').value);
                    formData.append('periodo_mes', document.getElementById('payrollMonth').value);
                    formData.append('periodo_ano', document.getElementById('payrollYear').value);
                    formData.append('observaciones', document.getElementById('payrollObservations').value);
                    formData.append('liquidacion', document.getElementById('payrollFile').files[0]);
                    
                    fetch('/api/liquidaciones/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showSuccess('Liquidaci√≥n subida correctamente');
                            closeModal('uploadPayrollModal');
                            loadAllPayrolls();
                        } else {
                            showError(data.message || 'Error al subir liquidaci√≥n');
                        }
                    })
                    .catch(error => {
                        console.error('Error al subir liquidaci√≥n:', error);
                        showError('Error al subir liquidaci√≥n');
                    });
                });
            }

            // Configurar formulario de edici√≥n de tiempo de colaci√≥n
            const breakTimeForm = document.getElementById('editBreakTimeForm');
            if (breakTimeForm) {
                breakTimeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    updateBreakTime();
                });
            }
        });

        // Funci√≥n para navegar al mes anterior
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }

        // Funci√≥n para navegar al mes siguiente
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }

        // Funci√≥n para generar rotaci√≥n de horarios
        function generateRotatingSchedule() {
            console.log('Generando calendario oficial de turnos...');
            generateOfficialCalendar();
            showSuccess('Calendario oficial de turnos generado exitosamente');
        }

        // Funci√≥n para generar el calendario oficial como el de septiembre
        async function generateOfficialCalendar() {
            const calendarContainer = document.getElementById('calendarContainer');
            if (!calendarContainer) {
                console.error('No se encontr√≥ el contenedor del calendario');
                return;
            }

            // Obtener empleados actuales de la base de datos
            let employees = [];
            try {
                const response = await fetch('/api/empleados', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                if (data.success) {
                    employees = data.data.map((emp, index) => ({
                        id: emp.id,
                        name: `${emp.nombre} ${emp.apellido}`,
                        color: ['purple', 'blue', 'black', 'orange', 'green', 'yellow'][index % 6]
                    }));
                    console.log('Empleados cargados para calendario:', employees.length);
                } else {
                    console.error('Error al cargar empleados:', data.message);
                    return;
                }
            } catch (error) {
                console.error('Error al obtener empleados:', error);
                return;
            }

            // Generar calendario para septiembre 2025 (semana espec√≠fica del ejemplo)
            const currentDate = new Date();
            const targetMonth = 8; // Septiembre (0-indexed)
            const targetYear = 2025;
            const monthNames = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 
                              'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];
            
            const daysInMonth = new Date(targetYear, targetMonth + 1, 0).getDate();
            const firstDay = new Date(targetYear, targetMonth, 1).getDay();
            
            // Ajustar para que lunes sea 0
            const adjustedFirstDay = (firstDay + 6) % 7;
            
            let calendarHTML = `
                <div class="official-calendar">
                    <div class="calendar-header">
                        <h2>${monthNames[targetMonth]}</h2>
                        <div class="calendar-days-header">
            `;
            
            // Generar encabezado de d√≠as
            const dayNames = ['LUN.', 'MAR.', 'MI√â.', 'JUE.', 'VIE.', 'S√ÅB.', 'DOM.'];
            for (let i = 0; i < 7; i++) {
                calendarHTML += `<div class="day-header">${dayNames[i]}</div>`;
            }
            calendarHTML += `</div>`;
            
            // Generar n√∫meros de d√≠as para todo el mes
            calendarHTML += `<div class="calendar-days-numbers">`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDate = new Date(targetYear, targetMonth, day);
                const isSunday = dayDate.getDay() === 0;
                const isSpecialDay = day === 18 || day === 19; // D√≠as especiales como en el calendario
                
                let dayClass = 'day-number';
                if (isSunday || isSpecialDay) {
                    dayClass += ' special-day';
                }
                
                calendarHTML += `<div class="${dayClass}">${day}</div>`;
            }
            calendarHTML += `</div>`;
            
            // Generar filas de empleados con sus turnos
            calendarHTML += `<div class="calendar-employees">`;
            
            // Verificar si hay empleados
            if (employees.length === 0) {
                calendarHTML += `
                    <div class="no-employees-message">
                        <div class="message-content">
                            <i class="fas fa-users"></i>
                            <h3>No hay empleados registrados</h3>
                            <p>Agrega empleados para generar el calendario de turnos</p>
                            <button class="btn btn-primary" onclick="showSection('employees')">
                                <i class="fas fa-plus"></i> Agregar Empleado
                            </button>
                        </div>
                    </div>
                `;
            } else {
                for (const employee of employees) {
                calendarHTML += `
                    <div class="employee-row">
                        <div class="employee-info ${employee.color}">
                            <div class="employee-name">${employee.name}</div>
                        </div>
                        <div class="employee-schedule">
                `;
                
                // Generar turnos para cada d√≠a del mes
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDate = new Date(targetYear, targetMonth, day);
                    const dayOfWeek = dayDate.getDay();
                    const isSunday = dayOfWeek === 0;
                    
                    // L√≥gica de turnos con rotaci√≥n equitativa para todos los empleados
                    let shiftClass = 'no-shift';
                    let shiftColor = '';
                    
                    // Todos los empleados usan el sistema de rotaci√≥n equitativa
                    shiftClass = await getStandardRotationShift(employee.name, day, dayOfWeek);
                    shiftColor = getShiftColor(shiftClass);
                    
                    calendarHTML += `<div class="shift-cell ${shiftClass}" style="background-color: ${shiftColor}"></div>`;
                }
                
                calendarHTML += `
                        </div>
                    </div>
                `;
                }
            }
            
            calendarHTML += `
                    </div>
                </div>
            `;
            
            calendarContainer.innerHTML = calendarHTML;
        }

        // Funciones para definir turnos espec√≠ficos de cada empleado seg√∫n el calendario oficial
        function getIvanVidalShift(day) {
            // Basado en el calendario oficial de septiembre
            if (day >= 1 && day <= 3) return 'orange-shift';
            if (day >= 4 && day <= 6) return 'green-shift';
            if (day === 7) return 'red-shift';
            if (day >= 8 && day <= 12) return 'orange-shift';
            if (day === 13) return 'green-shift';
            if (day === 14) return 'red-shift';
            if (day >= 15 && day <= 17) return 'purple-shift';
            if (day >= 18 && day <= 19) return 'orange-shift';
            if (day === 20) return 'yellow-shift';
            if (day === 21) return 'red-shift';
            if (day >= 22 && day <= 25) return 'purple-shift';
            if (day >= 26 && day <= 27) return 'orange-shift';
            if (day === 28) return 'red-shift';
            if (day >= 29 && day <= 30) return 'purple-shift';
            return 'no-shift';
        }

        function getJosePaillacarShift(day) {
            if (day >= 1 && day <= 2) return 'yellow-shift';
            if (day >= 3 && day <= 6) return 'orange-shift';
            if (day === 7) return 'red-shift';
            if (day >= 8 && day <= 9) return 'yellow-shift';
            if (day >= 10 && day <= 13) return 'green-shift';
            if (day === 14) return 'red-shift';
            if (day >= 15 && day <= 18) return 'yellow-shift';
            if (day >= 19 && day <= 20) return 'orange-shift';
            if (day === 21) return 'red-shift';
            if (day >= 22 && day <= 25) return 'yellow-shift';
            if (day >= 26 && day <= 27) return 'orange-shift';
            if (day === 28) return 'red-shift';
            if (day >= 29 && day <= 30) return 'yellow-shift';
            return 'no-shift';
        }

        function getMarcosPaillacarShift(day) {
            if (day >= 1 && day <= 7) return 'no-shift';
            if (day >= 8 && day <= 12) return 'black-shift';
            if (day >= 13 && day <= 14) return 'no-shift';
            if (day >= 15 && day <= 19) return 'no-shift';
            if (day === 20) return 'black-shift';
            if (day === 21) return 'no-shift';
            if (day >= 22 && day <= 26) return 'black-shift';
            if (day >= 27 && day <= 28) return 'no-shift';
            if (day >= 29 && day <= 30) return 'black-shift';
            return 'no-shift';
        }

        function getMatiasVillanuevaShift(day) {
            if (day >= 1 && day <= 5) return 'purple-shift';
            if (day >= 6 && day <= 7) return 'no-shift';
            if (day >= 8 && day <= 12) return 'purple-shift';
            if (day >= 13 && day <= 14) return 'no-shift';
            if (day >= 15 && day <= 19) return 'blue-shift';
            if (day >= 20 && day <= 21) return 'no-shift';
            if (day >= 22 && day <= 26) return 'blue-shift';
            if (day >= 27 && day <= 28) return 'no-shift';
            if (day >= 29 && day <= 30) return 'green-shift';
            return 'no-shift';
        }

        function getAngelicaChavezShift(day) {
            if (day >= 1 && day <= 5) return 'blue-shift';
            if (day === 6) return 'red-shift';
            if (day === 7) return 'no-shift';
            if (day >= 8 && day <= 12) return 'blue-shift';
            if (day === 13) return 'red-shift';
            if (day === 14) return 'no-shift';
            if (day >= 15 && day <= 19) return 'black-shift';
            if (day === 20) return 'red-shift';
            if (day === 21) return 'no-shift';
            if (day >= 22 && day <= 26) return 'green-shift';
            if (day === 27) return 'red-shift';
            if (day === 28) return 'no-shift';
            if (day >= 29 && day <= 30) return 'blue-shift';
            return 'no-shift';
        }

        function getMatiasIgorShift(day) {
            if (day >= 1 && day <= 5) return 'green-shift';
            if (day === 6) return 'red-shift';
            if (day === 7) return 'no-shift';
            if (day >= 8 && day <= 12) return 'green-shift';
            if (day === 13) return 'red-shift';
            if (day === 14) return 'no-shift';
            if (day >= 15 && day <= 19) return 'green-shift';
            if (day === 20) return 'red-shift';
            if (day === 21) return 'no-shift';
            if (day >= 22 && day <= 26) return 'blue-shift';
            if (day === 27) return 'red-shift';
            if (day === 28) return 'no-shift';
            if (day >= 29 && day <= 30) return 'orange-shift';
            return 'no-shift';
        }

        // Funci√≥n para obtener el color correspondiente a cada turno
        function getShiftColor(shiftClass) {
            const colors = {
                'orange-shift': '#FFA500',
                'green-shift': '#00FF00',
                'yellow-shift': '#FFFF00',
                'blue-shift': '#0000FF',
                'purple-shift': '#800080',
                'black-shift': '#000000',
                'red-shift': '#FF0000',
                'holiday': '#FF0000',
                'no-shift': '#FFFFFF'
            };
            return colors[shiftClass] || '#FFFFFF';
        }

        function isHoliday(day, month, year) {
            // D√≠as feriados de Chile 2025
            const holidays = [
                { day: 1, month: 0 },   // 1 de Enero - A√±o Nuevo
                { day: 19, month: 3 },  // 19 de Abril - Viernes Santo
                { day: 20, month: 3 },  // 20 de Abril - S√°bado Santo
                { day: 1, month: 4 },   // 1 de Mayo - D√≠a del Trabajador
                { day: 21, month: 4 },  // 21 de Mayo - D√≠a de las Glorias Navales
                { day: 18, month: 8 },  // 18 de Septiembre - Fiestas Patrias
                { day: 19, month: 8 },  // 19 de Septiembre - Glorias del Ej√©rcito
                { day: 12, month: 9 },  // 12 de Octubre - Encuentro de Dos Mundos
                { day: 1, month: 10 },  // 1 de Noviembre - D√≠a de Todos los Santos
                { day: 8, month: 11 },  // 8 de Diciembre - Inmaculada Concepci√≥n
                { day: 25, month: 11 }  // 25 de Diciembre - Navidad
            ];
            
            return holidays.some(holiday => 
                holiday.day === day && holiday.month === month
            );
        }

        // Funci√≥n para obtener la lista actual de empleados
        async function getCurrentEmployees() {
            try {
                console.log('üîç Obteniendo empleados desde la API...');
                const response = await fetch('/api/empleados', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                console.log('üì° Respuesta de empleados:', response.status);
                const data = await response.json();
                console.log('üìä Datos de empleados:', data);
                
                if (data.success && data.data && data.data.length > 0) {
                    const employeeNames = data.data.map(emp => `${emp.nombre} ${emp.apellido}`);
                    console.log('‚úÖ Empleados obtenidos:', employeeNames);
                    return employeeNames;
                } else {
                    console.log('‚ö†Ô∏è No hay empleados en la respuesta o respuesta fallida');
                }
            } catch (error) {
                console.error('‚ùå Error al obtener empleados:', error);
            }
            
            // Fallback a lista vac√≠a si no hay empleados cargados
            console.log('üîÑ No hay empleados registrados, devolviendo lista vac√≠a');
            return [];
        }

        // Nuevas funciones para el patr√≥n espec√≠fico proporcionado
        function getMatiasVillanuevaNewShift(day, dayOfWeek) {
            // MATIAS VILLANUEVA: Central Transporte Ma√±ana (Lun 1, Mar 2) ‚Üí Central Transporte Tarde (Vie 5 - Lun 8)
            if (day >= 1 && day <= 2) {
                return 'orange-shift'; // Central Transporte Ma√±ana
            } else if (day >= 5 && day <= 8) {
                return 'green-shift'; // Central Transporte Tarde
            }
            return 'no-shift';
        }

        function getMatiasIgorNewShift(day, dayOfWeek) {
            // MATIAS IGOR: Central Transporte Tarde (Lun 1 - Jue 4) ‚Üí Central Transporte Ma√±ana (Dom 7)
            if (day >= 1 && day <= 4) {
                return 'green-shift'; // Central Transporte Tarde
            } else if (day === 7) {
                return 'orange-shift'; // Central Transporte Ma√±ana
            }
            return 'no-shift';
        }

        async function getStandardRotationShift(employeeName, day, dayOfWeek) {
            // Verificar si es d√≠a feriado primero
            if (isHoliday(day, 8, 2025)) { // Septiembre es mes 8 (0-indexed)
                return 'holiday';
            }
            
            try {
                // Obtener empleados actuales
                const employees = await getCurrentEmployees();
                const employeeIndex = employees.indexOf(employeeName);
                
                if (employeeIndex === -1) {
                    console.log(`‚ùå Empleado ${employeeName} no encontrado`);
                    return 'no-shift';
                }
                
                // Obtener horarios disponibles desde la API
                const response = await fetch('/api/horarios', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                
                if (!data.success || !data.data || data.data.length === 0) {
                    console.log('‚ö†Ô∏è No hay horarios definidos');
                    return 'no-shift';
                }
                
                const horarios = data.data;
                console.log('üìã Horarios disponibles:', horarios);
                
                // Sistema de rotaci√≥n autom√°tica basado en horarios reales
                const totalEmployees = employees.length;
                const totalHorarios = horarios.length;
                
                if (totalHorarios === 0) {
                    return 'no-shift';
                }
                
                // Calcular la semana del mes (1-4)
                const weekInMonth = Math.ceil(day / 7);
                
                // Calcular el turno basado en la rotaci√≥n equitativa
                const horarioIndex = (employeeIndex + weekInMonth - 1) % totalHorarios;
                const horarioSeleccionado = horarios[horarioIndex];
                
                // Mapear el horario a una clase CSS
                const shiftClass = mapHorarioToShiftClass(horarioSeleccionado.nombre);
                
                console.log(`üìÖ Empleado: ${employeeName}, D√≠a: ${day}, Semana: ${weekInMonth}, Horario: ${horarioSeleccionado.nombre}, Clase: ${shiftClass}`);
                
                return shiftClass;
                
            } catch (error) {
                console.error('‚ùå Error al obtener horarios:', error);
                return 'no-shift';
            }
        }

        // Funci√≥n para mapear nombres de horarios a clases CSS
        function mapHorarioToShiftClass(horarioNombre) {
            const horarioLower = horarioNombre.toLowerCase();
            
            // Mapeo de horarios a clases CSS
            if (horarioLower.includes('ma√±ana') || horarioLower.includes('morning')) {
                return 'yellow-shift';
            } else if (horarioLower.includes('tarde') || horarioLower.includes('afternoon')) {
                return 'blue-shift';
            } else if (horarioLower.includes('noche') || horarioLower.includes('night')) {
                return 'black-shift';
            } else if (horarioLower.includes('central') && horarioLower.includes('transporte')) {
                return 'green-shift';
            } else if (horarioLower.includes('despacho')) {
                return 'orange-shift';
            } else if (horarioLower.includes('especial') || horarioLower.includes('extra')) {
                return 'purple-shift';
            } else {
                // Por defecto, asignar un color basado en el hash del nombre
                const colors = ['yellow-shift', 'blue-shift', 'green-shift', 'orange-shift', 'purple-shift', 'black-shift'];
                const hash = horarioNombre.split('').reduce((a, b) => {
                    a = ((a << 5) - a) + b.charCodeAt(0);
                    return a & a;
                }, 0);
                return colors[Math.abs(hash) % colors.length];
            }
        }

        function getWorkingDaysForEmployee(employeeIndex, weekInMonth) {
            // Cada empleado tiene un patr√≥n de d√≠as de trabajo diferente
            // Todos trabajan 4-5 d√≠as por semana con d√≠as libres consecutivos
            
            const patterns = [
                [0, 1, 2, 3, 4], // IVAN VIDAL: Lun-Vie
                [0, 1, 2, 3, 5], // JOSE PAILLACAR: Lun-Jue, S√°b
                [1, 2, 3, 4, 5], // MARCOS PAILLACAR: Mar-S√°b
                [0, 1, 4, 5, 6], // MATIAS VILLANUEVA: Lun-Mar, Vie-Dom
                [0, 2, 3, 4, 6], // ANGELICA CHAVEZ: Lun, Mi√©-Vie, Dom
                [1, 3, 4, 5, 6]  // MATIAS IGOR: Mar, Jue-Dom
            ];
            
            return patterns[employeeIndex % patterns.length];
        }

        // Funci√≥n para generar resumen semanal
        function generateWeeklySummary() {
            console.log('Generando resumen semanal...');
            const tbody = document.getElementById('weeklySummaryTable');
            tbody.innerHTML = '';
            
            // Generar resumen para las pr√≥ximas 5 semanas
            for (let week = 0; week < 5; week++) {
                // Fila para Central de Transporte
                const centralRow = document.createElement('tr');
                
                // Nombre del empleado de Central de Transporte
                const centralEmployeeCell = document.createElement('td');
                const centralEmployee = getEmployeeName((week % 2) + 1);
                centralEmployeeCell.textContent = `${centralEmployee} - Central Transporte`;
                centralRow.appendChild(centralEmployeeCell);
                
                // Turnos para cada semana - Central de Transporte
                for (let weekNum = 0; weekNum < 5; weekNum++) {
                    const shiftIndex = (weekNum + week) % 2;
                    const shift = getCentralTransporteShift(shiftIndex);
                    
                    const shiftCell = document.createElement('td');
                    shiftCell.className = `summary-cell ${shift.class}`;
                    shiftCell.textContent = shift.name;
                    centralRow.appendChild(shiftCell);
                }
                
                // Horas totales - Central de Transporte (44 horas)
                const centralTotalCell = document.createElement('td');
                centralTotalCell.className = 'summary-cell total-hours';
                centralTotalCell.textContent = '44 hrs';
                centralRow.appendChild(centralTotalCell);
                
                tbody.appendChild(centralRow);
                
                // Fila para Despacho Central
                const despachoRow = document.createElement('tr');
                
                // Nombre del empleado de Despacho Central
                const despachoEmployeeCell = document.createElement('td');
                const despachoEmployee = getEmployeeName((week % 2) + 3);
                despachoEmployeeCell.textContent = `${despachoEmployee} - Despacho Central`;
                despachoRow.appendChild(despachoEmployeeCell);
                
                // Turnos para cada semana - Despacho Central
                for (let weekNum = 0; weekNum < 5; weekNum++) {
                    const shiftIndex = (weekNum + week) % 2;
                    const shift = getDespachoCentralShift(shiftIndex);
                    
                    const shiftCell = document.createElement('td');
                    shiftCell.className = `summary-cell ${shift.class}`;
                    shiftCell.textContent = shift.name;
                    despachoRow.appendChild(shiftCell);
                }
                
                // Horas totales - Despacho Central (44 horas)
                const despachoTotalCell = document.createElement('td');
                despachoTotalCell.className = 'summary-cell total-hours';
                despachoTotalCell.textContent = '44 hrs';
                despachoRow.appendChild(despachoTotalCell);
                
                tbody.appendChild(despachoRow);
                
                // Fila para Turno Noche
                const nocheRow = document.createElement('tr');
                
                // Nombre del empleado de Turno Noche
                const nocheEmployeeCell = document.createElement('td');
                const nocheIndex = week % 5;
                const nocheShift = getTurnoNocheShift(nocheIndex);
                nocheEmployeeCell.textContent = nocheShift.name;
                nocheRow.appendChild(nocheEmployeeCell);
                
                // Turnos para cada semana - Turno Noche
                for (let weekNum = 0; weekNum < 5; weekNum++) {
                    const shiftIndex = (weekNum + week) % 5;
                    const shift = getTurnoNocheShift(shiftIndex);
                    
                    const shiftCell = document.createElement('td');
                    shiftCell.className = `summary-cell ${shift.class}`;
                    shiftCell.textContent = 'Turno Noche';
                    nocheRow.appendChild(shiftCell);
                }
                
                // Horas totales - Turno Noche (44 horas)
                const nocheTotalCell = document.createElement('td');
                nocheTotalCell.className = 'summary-cell total-hours';
                nocheTotalCell.textContent = '44 hrs';
                nocheRow.appendChild(nocheTotalCell);
                
                tbody.appendChild(nocheRow);
            }
        }

        // Funci√≥n para exportar horarios
        function exportSchedule() {
            console.log('Exportando horarios...');
            const data = {
                month: currentDate.getMonth() + 1,
                year: currentDate.getFullYear(),
                schedule: rotationSchedule,
                generated: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `horarios_${currentDate.getFullYear()}_${currentDate.getMonth() + 1}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Horarios exportados exitosamente');
        }
    </script>
</body>
</html>
